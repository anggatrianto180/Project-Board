<!DOCTYPE html>
<html lang="en" style="scroll-behavior: smooth;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Project Hub (Firebase)</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Icon Library for buttons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Lighter gray background */
        }
        .dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }
        .drag-over {
            background-color: #e0f2fe; /* Light blue on drag over */
        }
        .task-card, .note-item, .routine-item {
            transition: all 0.2s ease-in-out;
        }
        .task-card:hover, .note-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .task-card, .routine-item, .note-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .task-actions i, .column-actions i {
            color: #9ca3af;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s ease-in-out, color 0.2s ease-in-out;
            cursor: pointer;
            margin-left: 8px;
        }
        .task-card:hover .task-actions i, .routine-item:hover .task-actions i, .note-item:hover .task-actions i, .kanban-column-header:hover .column-actions i {
            visibility: visible;
            opacity: 1;
        }
        .task-actions i:hover, .column-actions i:hover {
            color: #3b82f6; /* blue-500 */
        }
        .task-actions .delete-btn:hover, .column-actions .delete-btn:hover {
            color: #ef4444; /* red-500 */
        }
        .routine-item.completed span, .routine-item.completed strong {
            text-decoration: line-through;
            color: #9ca3af; /* gray-400 */
        }
        .note-item {
            align-items: flex-start;
            flex-direction: column;
            justify-content: space-between;
        }
        .section-divider {
            border: 0;
            height: 1px;
            background-image: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0));
            margin: 3rem 0;
        }
        /* Calendar Styles */
        .calendar-day {
            min-height: 140px;
            display: flex;
            flex-direction: column;
            position: relative;
            background-color: white;
        }
        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px;
            border-bottom: 1px solid #e5e7eb;
        }
        .day-info {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .day-name {
            font-size: 0.7rem;
            color: #6b7280;
            background-color: #f3f4f6;
            padding: 2px 6px;
            border-radius: 999px;
        }
        .today .day-number {
            background-color: #3b82f6;
            color: white;
        }
        .day-number {
            font-weight: 500;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .weekend-day {
            background-color: rgba(254, 226, 226, 0.7); /* red-100 with opacity */
        }
        .other-month {
            color: #d1d5db;
            background-color: #f9fafb;
        }
        .day-routine-list {
            font-size: 0.75rem; /* text-xs */
            line-height: 1.1;
            margin-top: 4px;
            overflow-y: auto;
            flex-grow: 1;
            padding: 4px;
            background-color: #eff6ff; /* blue-50 */
            border-radius: 0 0 0.5rem 0.5rem;
        }
        .day-routine-item {
            display: flex;
            align-items: center;
            padding: 2px;
            border-radius: 4px;
        }
        .day-routine-item:hover {
            background-color: #dbeafe;
        }
        .add-routine-btn {
            color: #9ca3af;
            cursor: pointer;
            visibility: hidden;
            opacity: 0;
            transition: all 0.2s;
        }
        .calendar-day:hover .add-routine-btn {
            visibility: visible;
            opacity: 1;
        }
        .add-routine-btn:hover {
            color: #4f46e5; /* indigo-600 */
        }
        /* Mode Toggle Styles */
        .mode-toggle button.active {
            background-color: #4f46e5;
            color: white;
        }
        /* Universal Board Scroll */
        #board {
            display: flex;
            overflow-x: auto;
            padding-bottom: 1rem;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
            scroll-snap-type: x mandatory;
            gap: 1rem;
        }
        #board::-webkit-scrollbar {
            display: none; /* Safari and Chrome */
        }
        .kanban-column {
            width: 85%;
            max-width: 320px;
            flex-shrink: 0;
            scroll-snap-align: start;
        }
        @media (min-width: 768px) {
            .kanban-column {
                width: 100%;
            }
        }
        /* Mobile specific styles */
        @media (max-width: 768px) {
            .calendar-day {
                min-height: 60px;
                padding: 2px;
            }
            .day-header {
                padding: 2px;
                border-bottom: none;
            }
            .day-name { display: none; }
            .day-routine-list { display: none; }
            .add-routine-btn { display: none; }
            .calendar-day {
                cursor: pointer;
            }
            .day-number {
                width: 24px;
                height: 24px;
                font-size: 0.8rem;
            }
            .selected-day {
                outline: 2px solid #3b82f6;
                border-radius: 0.5rem;
            }
        }
    </style>
</head>
<body class="text-gray-800 pt-16">

    <header class="bg-white shadow-md fixed top-0 left-0 right-0 z-30">
        <nav class="container mx-auto px-4 md:px-8 flex justify-between items-center py-3">
            <!-- Logo -->
            <a href="#" class="flex items-center space-x-2">
                <img src="https://placehold.co/40x40/6366f1/ffffff?text=AT" alt="Logo" class="h-10 w-10 rounded-full">
                <span class="font-bold text-xl text-gray-800 hidden sm:block">Project Board AT</span>
            </a>

            <!-- Mode Toggle -->
            <div class="mode-toggle flex items-center p-1 bg-gray-200 rounded-full">
                <button id="personal-mode-btn" class="px-4 py-1 text-sm font-semibold rounded-full transition-colors">Personal</button>
                <button id="working-mode-btn" class="px-4 py-1 text-sm font-semibold rounded-full transition-colors">Working</button>
            </div>

            <!-- Mobile Menu Button -->
            <div class="md:hidden">
                <button id="mobile-menu-button" class="text-gray-600 hover:text-indigo-600 focus:outline-none">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
            </div>
        </nav>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-white border-t">
            <a href="#project-board-section" class="block py-2 px-4 text-sm text-gray-700 hover:bg-gray-100">Project Board</a>
            <a href="#daily-routine-section" class="block py-2 px-4 text-sm text-gray-700 hover:bg-gray-100">Daily Routine</a>
            <a href="#important-notes-section" class="block py-2 px-4 text-sm text-gray-700 hover:bg-gray-100">Notes</a>
        </div>
    </header>

    <main class="container mx-auto p-4 md:px-8">
        <!-- Project Board Section -->
        <div id="project-board-section" class="bg-white rounded-xl shadow-sm p-6 md:p-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Project Board</h2>
            <div class="mb-8 max-w-lg mx-auto">
                <form id="task-form" class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="task-input" placeholder="Write a new project task..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-transform hover:scale-105">
                        Add Task
                    </button>
                </form>
            </div>

            <div id="board">
                <!-- Board columns will be rendered here by JS -->
            </div>
        </div>
        
        <hr class="section-divider">

        <!-- Daily Routine Section -->
        <div id="daily-routine-section" class="bg-white rounded-xl shadow-sm p-6 md:p-8">
            <div class="flex justify-center items-center mb-6 relative">
                 <h2 class="text-3xl font-bold text-gray-800">Daily Routine Calendar</h2>
                 <button id="mobile-recurring-btn" class="sm:hidden absolute right-0 bg-indigo-500 text-white rounded-full h-8 w-8 flex items-center justify-center hover:bg-indigo-600">
                    <i class="fas fa-plus"></i>
                 </button>
            </div>
            <div id="calendar-container" class="max-w-full mx-auto">
                <div class="mb-6 p-4 border rounded-lg bg-gray-50 hidden sm:block">
                    <h4 class="font-semibold text-gray-700 mb-2">Add Recurring Routine for this Month</h4>
                    <form id="recurring-routine-form" class="flex flex-col sm:flex-row items-center gap-3">
                        <input type="time" id="recurring-routine-time" class="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <input type="text" id="recurring-routine-input" placeholder="E.g., Badminton" class="flex-grow p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        <select id="recurring-day-select" class="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                            <option value="1">Monday</option>
                            <option value="2">Tuesday</option>
                            <option value="3">Wednesday</option>
                            <option value="4">Thursday</option>
                            <option value="5">Friday</option>
                            <option value="6">Saturday</option>
                            <option value="0">Sunday</option>
                        </select>
                        <button type="submit" class="bg-indigo-500 text-white font-semibold py-2 px-3 md:px-4 rounded-lg hover:bg-indigo-600 transition-transform hover:scale-105">
                            <span class="hidden sm:inline">Add to All</span>
                            <i class="fas fa-plus sm:hidden"></i>
                        </button>
                    </form>
                </div>
                <div id="calendar-header" class="flex items-center justify-between mb-4">
                    <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-left"></i></button>
                    <h3 id="month-year-header" class="text-xl font-semibold"></h3>
                    <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div id="calendar-weekdays" class="grid grid-cols-7 gap-2 text-center font-semibold text-gray-600 mb-2">
                    <!-- Weekday names will be populated by JS -->
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-2">
                    <!-- Calendar days will be populated here -->
                </div>
            </div>
             <!-- Mobile Daily Activity View -->
            <div id="mobile-daily-activity" class="md:hidden mt-6 bg-gray-50 p-4 rounded-lg">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Daily Activity</h3>
                <div id="mobile-routine-list">
                    <p class="text-gray-500">Select a date to see your routines.</p>
                </div>
            </div>
        </div>

        <hr class="section-divider">

        <!-- Important Notes Section -->
        <div id="important-notes-section" class="bg-white rounded-xl shadow-sm p-6 md:p-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Important Notes</h2>
            <div class="max-w-4xl mx-auto">
                <div class="mb-8 max-w-lg mx-auto">
                    <form id="note-form" class="flex flex-col sm:flex-row gap-3 items-center">
                        <input type="text" id="note-input" placeholder="Add a new secret note..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
                        <button type="submit" class="bg-yellow-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 transition-transform hover:scale-105">
                            Add Note
                        </button>
                    </form>
                </div>
                <div id="notes-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
            </div>
        </div>
    </main>
    
    <!-- Modals -->
    <div id="notification-area" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 pointer-events-none">
        <!-- Notification will be injected here -->
    </div>
    <div id="custom-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm mx-auto"><p id="confirm-modal-text" class="text-lg mb-4"></p><div class="flex justify-end gap-4"><button id="confirm-cancel-btn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button><button id="confirm-ok-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button></div></div>
    </div>
    <div id="routine-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg mx-auto p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="routine-modal-date" class="text-2xl font-bold"></h3>
                <button id="close-routine-modal-btn" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-times"></i></button>
            </div>
            <div id="modal-routine-list" class="space-y-2 mb-4 max-h-64 overflow-y-auto"></div>
            <form id="routine-form" class="flex flex-col sm:flex-row gap-3">
                <input type="time" id="routine-time-input" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="text" id="routine-input" placeholder="Add a routine for this day..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                <button type="submit" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">Add</button>
            </form>
        </div>
    </div>
    <div id="edit-routine-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg mx-auto p-6">
            <h3 class="text-2xl font-bold mb-4">Edit Routine</h3>
            <form id="edit-routine-form">
                <input type="hidden" id="edit-routine-id">
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="time" id="edit-routine-time-input" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="text" id="edit-routine-input" placeholder="Routine text..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-edit-routine-btn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    <div id="recurring-routine-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg mx-auto p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Add Recurring Routine</h3>
                <button id="close-recurring-modal-btn" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-times"></i></button>
            </div>
            <form id="recurring-routine-form-modal" class="space-y-4">
                <div>
                    <label for="recurring-routine-time-modal" class="block text-sm font-medium text-gray-700">Time</label>
                    <input type="time" id="recurring-routine-time-modal" class="mt-1 p-2 w-full border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="recurring-routine-input-modal" class="block text-sm font-medium text-gray-700">Activity</label>
                    <input type="text" id="recurring-routine-input-modal" placeholder="E.g., Badminton" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div>
                    <label for="recurring-day-select-modal" class="block text-sm font-medium text-gray-700">Day of Week</label>
                    <select id="recurring-day-select-modal" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        <option value="1">Monday</option>
                        <option value="2">Tuesday</option>
                        <option value="3">Wednesday</option>
                        <option value="4">Thursday</option>
                        <option value="5">Friday</option>
                        <option value="6">Saturday</option>
                        <option value="0">Sunday</option>
                    </select>
                </div>
                <div class="flex justify-end pt-2">
                    <button type="submit" class="bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-600 transition-transform hover:scale-105">
                        Add to All
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div id="column-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg mx-auto p-6">
            <h3 id="column-modal-title" class="text-2xl font-bold mb-4"></h3>
            <form id="column-form">
                <input type="hidden" id="column-id-input">
                <div>
                    <label for="column-name-input" class="block text-sm font-medium text-gray-700">Column Name</label>
                    <input type="text" id="column-name-input" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-column-btn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
                </div>
            </form>
        </div>
    </div>
     <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-sm mx-auto p-6">
            <h3 class="text-2xl font-bold mb-4">Enter Password</h3>
            <form id="password-form">
                <div>
                    <label for="password-input" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password-input" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-password-btn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">Unlock</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, where, getDocs, writeBatch, orderBy } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA8KJmXXX5ax3QulbDFKpBI87v36OLcvK0",
            authDomain: "project-management-fafb7.firebaseapp.com",
            projectId: "project-management-fafb7",
            storageBucket: "project-management-fafb7.firebasestorage.app",
            messagingSenderId: "935346350562",
            appId: "1:935346350562:web:a475abd4099b5acbd3b1bb"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Global State ---
        let currentMode = localStorage.getItem('currentMode') || 'personal';
        let currentDate = new Date();
        let monthRoutines = {};
        let monthListenerUnsubscribe = null;
        let selectedDateStr = null;
        let routineListenerUnsubscribe = null;
        let isInitialCalendarLoad = true;
        let boardColumns = [];
        let allTasks = [];
        let allNotes = [];
        let listeners = [];
        let notesUnlocked = false;
        const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        const dayNamesShort = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

        // --- UI Functions ---
        const showNotification = (message, isError = false) => {
            const notificationArea = document.getElementById('notification-area');
            notificationArea.innerHTML = '';
            const notification = document.createElement('div');
            notification.className = `relative p-4 rounded-lg shadow-lg text-white max-w-sm pointer-events-auto ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            
            const messageEl = document.createElement('p');
            messageEl.textContent = message;

            const closeBtn = document.createElement('button');
            closeBtn.className = 'absolute top-1 right-2 text-white font-bold';
            closeBtn.innerHTML = '&times;';
            closeBtn.onclick = () => {
                notificationArea.classList.add('hidden');
            };

            notification.appendChild(messageEl);
            notification.appendChild(closeBtn);
            notificationArea.appendChild(notification);
            
            notificationArea.classList.remove('hidden');

            setTimeout(() => {
                 notificationArea.classList.add('hidden');
            }, 1500);
        };

        const showConfirmModal = (text) => {
            return new Promise((resolve) => {
                const modal = document.getElementById('custom-confirm-modal');
                const modalText = document.getElementById('confirm-modal-text');
                const okBtn = document.getElementById('confirm-ok-btn');
                const cancelBtn = document.getElementById('confirm-cancel-btn');
                modalText.textContent = text;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                okBtn.onclick = () => { modal.classList.add('hidden'); modal.classList.remove('flex'); resolve(true); };
                cancelBtn.onclick = () => { modal.classList.add('hidden'); modal.classList.remove('flex'); resolve(false); };
            });
        };
        
        const formatTime = (timeStr) => {
            if (!timeStr) return '';
            const [hours, minutes] = timeStr.split(':');
            const h = parseInt(hours, 10);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const formattedHours = h % 12 || 12;
            return `${formattedHours}:${minutes} ${ampm}`;
        };

        // --- Project Task Functions ---
        const renderBoard = () => {
            const boardContainer = document.getElementById('board');
            boardContainer.innerHTML = ''; // Clear existing columns
            
            boardColumns.forEach(column => {
                const columnEl = document.createElement('div');
                columnEl.className = 'kanban-column bg-gray-50 rounded-lg p-4';
                columnEl.dataset.columnId = column.id;

                const header = document.createElement('div');
                header.className = 'kanban-column-header flex justify-between items-center mb-4 border-b-2 pb-2';
                
                const title = document.createElement('h3');
                title.className = 'text-lg font-semibold text-gray-700';
                title.textContent = column.name;

                const actions = document.createElement('div');
                actions.className = 'column-actions';
                
                const editBtn = document.createElement('i');
                editBtn.className = 'fas fa-edit cursor-pointer';
                editBtn.onclick = () => openColumnModal(column.id, column.name);

                const deleteBtn = document.createElement('i');
                deleteBtn.className = 'fas fa-trash-alt delete-btn cursor-pointer';
                deleteBtn.onclick = () => deleteColumn(column.id);

                actions.appendChild(editBtn);
                actions.appendChild(deleteBtn);
                header.appendChild(title);
                header.appendChild(actions);

                const taskList = document.createElement('div');
                taskList.className = 'task-list min-h-[200px] space-y-3 p-1';
                
                const tasksForColumn = allTasks.filter(task => task.columnId === column.id);
                tasksForColumn.forEach(task => {
                    const taskCard = createTaskElement(task.id, task.text);
                    taskList.appendChild(taskCard);
                });

                columnEl.appendChild(header);
                columnEl.appendChild(taskList);
                boardContainer.appendChild(columnEl);
            });

            const addColumnButton = document.createElement('button');
            addColumnButton.className = 'kanban-column bg-gray-100 rounded-lg p-4 flex items-center justify-center text-gray-500 hover:bg-gray-200 hover:text-gray-700 transition-colors';
            addColumnButton.innerHTML = '<i class="fas fa-plus mr-2"></i> Add New Column';
            addColumnButton.onclick = () => openColumnModal();
            boardContainer.appendChild(addColumnButton);
        };

        const createTaskElement = (id, text) => {
            const taskCard = document.createElement('div');
            taskCard.className = 'task-card bg-white p-3 rounded-lg shadow-sm cursor-grab active:cursor-grabbing border-l-4 border-gray-300 hover:border-blue-500';
            taskCard.draggable = true;
            taskCard.dataset.id = id;
            const taskTextSpan = document.createElement('span');
            taskTextSpan.textContent = text;
            taskTextSpan.className = 'flex-grow';
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'task-actions';
            const editButton = document.createElement('i');
            editButton.className = 'fas fa-edit';
            editButton.onclick = () => editTask(id, taskCard, taskTextSpan);
            const deleteButton = document.createElement('i');
            deleteButton.className = 'fas fa-trash-alt delete-btn';
            deleteButton.onclick = () => deleteTask(id);
            actionsDiv.appendChild(editButton);
            actionsDiv.appendChild(deleteButton);
            taskCard.appendChild(taskTextSpan);
            taskCard.appendChild(actionsDiv);
            addDragEventsToTask(taskCard);
            return taskCard;
        };
        const editTask = (id, taskCard, taskTextSpan) => {
            const currentText = taskTextSpan.textContent;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentText;
            input.className = 'flex-grow p-1 border rounded';
            taskCard.replaceChild(input, taskTextSpan);
            input.focus();
            const saveChanges = async () => {
                const newText = input.value.trim();
                if (newText && newText !== currentText) {
                    await updateDoc(doc(db, "hubs", currentMode, "tasks", id), { text: newText });
                }
                taskCard.replaceChild(taskTextSpan, input);
            };
            input.addEventListener('blur', saveChanges);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') input.blur();
                if (e.key === 'Escape') { input.value = currentText; input.blur(); }
            });
        };
        const addTask = async (text) => {
            if (boardColumns.length === 0) {
                showNotification("Please add a column first before adding tasks.", true);
                return;
            }
            try { await addDoc(collection(db, "hubs", currentMode, "tasks"), { text, columnId: boardColumns[0].id }); } catch (e) { showNotification('Failed to add task.', true); }
        };
        const deleteTask = async (taskId) => { const confirmed = await showConfirmModal('Are you sure you want to delete this task?'); if (confirmed) { try { await deleteDoc(doc(db, "hubs", currentMode, "tasks", taskId)); showNotification('Task deleted successfully.'); } catch (e) { showNotification('Failed to delete task.', true); } } };

        const openColumnModal = (id = null, name = '') => {
            const modal = document.getElementById('column-modal');
            document.getElementById('column-modal-title').textContent = id ? 'Edit Column' : 'Add New Column';
            document.getElementById('column-id-input').value = id || '';
            document.getElementById('column-name-input').value = name;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        const closeColumnModal = () => {
            document.getElementById('column-modal').classList.add('hidden');
        };

        const saveColumn = async (id, name) => {
            if (!name || name.trim() === "") return;
            if (id) {
                await updateDoc(doc(db, "hubs", currentMode, "board_columns", id), { name: name.trim() });
            } else {
                const order = boardColumns.length > 0 ? Math.max(...boardColumns.map(c => c.order)) + 1 : 1;
                await addDoc(collection(db, "hubs", currentMode, "board_columns"), { name: name.trim(), order });
            }
            closeColumnModal();
        };

        const deleteColumn = async (columnId) => {
            const confirmed = await showConfirmModal('Are you sure you want to delete this column and all its tasks? This action cannot be undone.');
            if (confirmed) {
                try {
                    const batch = writeBatch(db);
                    const tasksToDeleteQuery = query(collection(db, "hubs", currentMode, "tasks"), where("columnId", "==", columnId));
                    const tasksSnapshot = await getDocs(tasksToDeleteQuery);
                    tasksSnapshot.forEach(taskDoc => {
                        batch.delete(doc(db, "hubs", currentMode, "tasks", taskDoc.id));
                    });
                    batch.delete(doc(db, "hubs", currentMode, "board_columns", columnId));
                    await batch.commit();
                    showNotification('Column and its tasks deleted successfully.');
                } catch (e) {
                    showNotification('Failed to delete column.', true);
                }
            }
        };

        // --- Daily Routine Calendar Functions ---
        const renderCalendar = () => {
            const calendarGrid = document.getElementById('calendar-grid');
            const monthYearHeader = document.getElementById('month-year-header');
            const weekdaysHeader = document.getElementById('calendar-weekdays');
            calendarGrid.innerHTML = '';
            weekdaysHeader.innerHTML = '';
            
            const isMobile = window.innerWidth < 768;
            const currentDayNames = isMobile ? dayNamesShort : dayNames;
            currentDayNames.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.textContent = day;
                weekdaysHeader.appendChild(dayEl);
            });

            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            
            monthYearHeader.textContent = `${currentDate.toLocaleString('en-US', { month: 'long' })} ${year}`;
            
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            fetchMonthRoutines(year, month);

            for (let i = 0; i < firstDayOfMonth; i++) {
                calendarGrid.appendChild(document.createElement('div'));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day border rounded';
                dayCell.dataset.date = dateStr;
                
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header';

                const dayInfo = document.createElement('div');
                dayInfo.className = 'day-info';

                const dayNumber = document.createElement('span');
                dayNumber.className = 'day-number text-sm';
                dayNumber.textContent = day;

                const dayName = document.createElement('span');
                dayName.className = 'day-name';
                dayName.textContent = dayNamesShort[date.getDay()];
                
                dayInfo.appendChild(dayNumber);
                dayInfo.appendChild(dayName);
                
                const addBtn = document.createElement('i');
                addBtn.className = 'fas fa-plus add-routine-btn text-xs';
                addBtn.onclick = (e) => { e.stopPropagation(); openRoutineModal(dateStr); };

                dayHeader.appendChild(dayInfo);
                dayHeader.appendChild(addBtn);
                
                const todayStr = new Date().toISOString().slice(0, 10);
                if (dateStr === todayStr) dayCell.classList.add('today');
                
                if (date.getDay() === 0 || date.getDay() === 6) {
                    dayCell.classList.add('weekend-day');
                }

                const routineList = document.createElement('div');
                routineList.className = 'day-routine-list';
                routineList.id = `routines-${dateStr}`;

                dayCell.appendChild(dayHeader);
                dayCell.appendChild(routineList);
                
                dayCell.addEventListener('click', () => handleDayClick(dateStr, dayCell));
                calendarGrid.appendChild(dayCell);
            }
        };
        
        const handleDayClick = (dateStr, dayCell) => {
             if (window.innerWidth >= 768) return;
             
             const prevSelected = document.querySelector('.selected-day');
             if(prevSelected) prevSelected.classList.remove('selected-day');

             dayCell.classList.add('selected-day');
             
             renderMobileRoutines(dateStr);
        };

        const fetchMonthRoutines = (year, month) => {
            if (monthListenerUnsubscribe) monthListenerUnsubscribe();
            const startDate = `${year}-${String(month + 1).padStart(2, '0')}-01`;
            const endDate = `${year}-${String(month + 2).padStart(2, '0')}-01`;
            const q = query(collection(db, "hubs", currentMode, "daily_routines"), where("date", ">=", startDate), where("date", "<", endDate));
            
            monthListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                monthRoutines = {};
                snapshot.docs.forEach(doc => {
                    const routine = { id: doc.id, ...doc.data() };
                    if (!monthRoutines[routine.date]) monthRoutines[routine.date] = [];
                    monthRoutines[routine.date].push(routine);
                });
                updateRoutineDisplay();

                if (isInitialCalendarLoad && window.innerWidth < 768) {
                    const todayStr = new Date().toISOString().slice(0, 10);
                    const todayCell = document.querySelector(`.calendar-day[data-date="${todayStr}"]`);
                    if (todayCell) {
                        handleDayClick(todayStr, todayCell);
                    }
                    isInitialCalendarLoad = false;
                }
            });
        };

        const updateRoutineDisplay = () => {
            document.querySelectorAll('.day-routine-list').forEach(list => list.innerHTML = '');
            for (const dateStr in monthRoutines) {
                const listEl = document.getElementById(`routines-${dateStr}`);
                if (listEl) {
                    monthRoutines[dateStr].sort((a, b) => (a.time || '').localeCompare(b.time || ''));
                    monthRoutines[dateStr].forEach(routine => {
                        const item = createDayRoutineElement(routine);
                        listEl.appendChild(item);
                    });
                }
            }
        };

        const createDayRoutineElement = (routine) => {
            const item = document.createElement('div');
            item.className = `day-routine-item ${routine.completed ? 'completed' : ''}`;
            item.title = `${routine.text}${routine.time ? ' at ' + formatTime(routine.time) : ''}`;

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = routine.completed;
            checkbox.className = 'form-checkbox h-3 w-3 text-indigo-600 rounded-sm mr-1 focus:ring-0 flex-shrink-0';
            checkbox.onchange = () => updateRoutineStatus(routine.id, checkbox.checked);
            
            const textSpan = document.createElement('span');
            textSpan.textContent = `${routine.text} ${formatTime(routine.time)}`;
            textSpan.className = 'truncate';

            item.appendChild(checkbox);
            item.appendChild(textSpan);
            return item;
        };

        const openRoutineModal = (dateStr) => {
            selectedDateStr = dateStr;
            const modal = document.getElementById('routine-modal');
            const modalDateHeader = document.getElementById('routine-modal-date');
            const date = new Date(dateStr + 'T00:00:00');
            modalDateHeader.textContent = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            if (routineListenerUnsubscribe) routineListenerUnsubscribe();
            const q = query(collection(db, "hubs", currentMode, "daily_routines"), where("date", "==", dateStr));
            routineListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                renderModalRoutines(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            });
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        const closeRoutineModal = () => {
            document.getElementById('routine-modal').classList.add('hidden');
            if (routineListenerUnsubscribe) { routineListenerUnsubscribe(); routineListenerUnsubscribe = null; }
            selectedDateStr = null;
        };
        
        const openEditRoutineModal = (routine) => {
            const modal = document.getElementById('edit-routine-modal');
            document.getElementById('edit-routine-id').value = routine.id;
            document.getElementById('edit-routine-input').value = routine.text;
            document.getElementById('edit-routine-time-input').value = routine.time;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        const closeEditRoutineModal = () => {
            document.getElementById('edit-routine-modal').classList.add('hidden');
        };

        const renderModalRoutines = (routines) => {
            const listEl = document.getElementById('modal-routine-list');
            listEl.innerHTML = '';
            routines.sort((a, b) => (a.time || '').localeCompare(b.time || ''));
            routines.forEach(routine => {
                const item = document.createElement('div');
                item.className = `routine-item p-3 rounded-lg bg-gray-50 hover:bg-gray-100`;
                
                const mainContent = document.createElement('div');
                mainContent.className = 'flex items-center flex-grow';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = routine.completed;
                checkbox.className = 'form-checkbox h-5 w-5 text-indigo-600 rounded mr-3 focus:ring-0';
                checkbox.onchange = () => updateRoutineStatus(routine.id, checkbox.checked);
                const textSpan = document.createElement('span');
                const timeDisplay = routine.time ? `<strong class="mr-2">${formatTime(routine.time)}</strong>` : '';
                textSpan.innerHTML = `${timeDisplay} <span class="${routine.completed ? 'completed' : ''}">${routine.text}</span>`;
                mainContent.appendChild(checkbox);
                mainContent.appendChild(textSpan);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'task-actions';
                const editButton = document.createElement('i');
                editButton.className = 'fas fa-edit';
                editButton.onclick = () => openEditRoutineModal(routine);
                const deleteButton = document.createElement('i');
                deleteButton.className = 'fas fa-trash-alt delete-btn';
                deleteButton.onclick = () => deleteRoutine(routine.id);
                actionsDiv.appendChild(editButton);
                actionsDiv.appendChild(deleteButton);

                item.appendChild(mainContent);
                item.appendChild(actionsDiv);
                listEl.appendChild(item);
            });
        };
        
        const renderMobileRoutines = (dateStr) => {
            const container = document.getElementById('mobile-routine-list');
            container.innerHTML = '';
            
            const routines = monthRoutines[dateStr] || [];
            
            if (routines.length === 0) {
                 container.innerHTML = `<p class="text-gray-500">No routines for this day. <a href="#" class="text-indigo-600" onclick="event.preventDefault(); openRoutineModal('${dateStr}')">Add one?</a></p>`;
                 return;
            }

            routines.sort((a, b) => (a.time || '').localeCompare(b.time || ''));
            routines.forEach(routine => {
                const item = document.createElement('div');
                item.className = `routine-item p-3 rounded-lg bg-white`;
                
                const mainContent = document.createElement('div');
                mainContent.className = 'flex items-center flex-grow';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = routine.completed;
                checkbox.className = 'form-checkbox h-5 w-5 text-indigo-600 rounded mr-3 focus:ring-0';
                checkbox.onchange = () => updateRoutineStatus(routine.id, checkbox.checked);
                const textSpan = document.createElement('span');
                const timeDisplay = routine.time ? `<strong class="mr-2">${formatTime(routine.time)}</strong>` : '';
                textSpan.innerHTML = `${timeDisplay} <span class="${routine.completed ? 'completed' : ''}">${routine.text}</span>`;
                mainContent.appendChild(checkbox);
                mainContent.appendChild(textSpan);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'task-actions';
                const editButton = document.createElement('i');
                editButton.className = 'fas fa-edit';
                editButton.onclick = () => openEditRoutineModal(routine);
                const deleteButton = document.createElement('i');
                deleteButton.className = 'fas fa-trash-alt delete-btn';
                deleteButton.onclick = () => deleteRoutine(routine.id);
                actionsDiv.appendChild(editButton);
                actionsDiv.appendChild(deleteButton);

                item.appendChild(mainContent);
                item.appendChild(actionsDiv);
                container.appendChild(item);
            });
        };

        const addRoutine = async (text, time, dateStr) => {
            try {
                await addDoc(collection(db, "hubs", currentMode, "daily_routines"), { text, time, completed: false, date: dateStr });
            } catch (e) {
                console.error("Error adding routine: ", e);
                showNotification('Failed to add routine.', true);
            }
        };

        const updateRoutine = async (id, text, time) => {
            try {
                await updateDoc(doc(db, "hubs", currentMode, "daily_routines", id), { text, time });
                showNotification('Routine updated successfully.');
            } catch (e) {
                showNotification('Failed to edit routine.', true);
            }
        };

        const updateRoutineStatus = async (id, completed) => {
            try {
                await updateDoc(doc(db, "hubs", currentMode, "daily_routines", id), { completed });
            } catch (e) {
                showNotification('Failed to update routine status.', true);
            }
        };

        const deleteRoutine = async (id) => {
            const confirmed = await showConfirmModal('Are you sure you want to delete this routine task?');
            if (confirmed) {
                try {
                    await deleteDoc(doc(db, "hubs", currentMode, "daily_routines", id));
                } catch (e) {
                    showNotification('Failed to delete routine.', true);
                }
            }
        };

        const addRecurringRoutine = async (text, time, dayOfWeek) => {
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const promises = [];

            for (let day = 1; day <= daysInMonth; day++) {
                const loopDate = new Date(year, month, day);
                if (loopDate.getDay() == dayOfWeek) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    promises.push(addRoutine(text, time, dateStr));
                }
            }
            try {
                await Promise.all(promises);
                showNotification(`Successfully added "${text}" to all selected days this month.`);
            } catch (e) {
                showNotification('An error occurred while adding recurring routines.', true);
            }
        };

        // --- Important Notes Functions ---
        const renderNotes = () => {
            const notesList = document.getElementById('notes-list');
            notesList.innerHTML = '';
            allNotes.forEach(note => {
                const noteItem = createNoteElement(note);
                notesList.appendChild(noteItem);
            });
        };
        const createNoteElement = (note) => {
            const item = document.createElement('div');
            item.className = 'note-item p-4 rounded-lg bg-yellow-50 hover:bg-yellow-100 shadow-sm min-h-[120px]';
            item.dataset.id = note.id;

            if (note.isSecret && !notesUnlocked) {
                item.innerHTML = `
                    <div class="flex-grow flex flex-col items-center justify-center text-gray-500">
                        <i class="fas fa-lock text-2xl"></i>
                        <p class="text-sm mt-2">Secret Note</p>
                    </div>
                    <div class="task-actions self-end mt-2">
                        <i class="fas fa-eye cursor-pointer"></i>
                    </div>
                `;
                item.querySelector('.fa-eye').onclick = () => openPasswordModal();
            } else {
                 const textSpan = document.createElement('p');
                 textSpan.textContent = note.decryptedText || note.text;
                 textSpan.className = 'flex-grow text-gray-800 break-words';
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'task-actions self-end mt-2';
                
                const editButton = document.createElement('i');
                editButton.className = 'fas fa-edit';
                editButton.onclick = () => editNote(note.id, item, textSpan);

                const deleteButton = document.createElement('i');
                deleteButton.className = 'fas fa-trash-alt delete-btn';
                deleteButton.onclick = () => deleteNote(note.id);

                actionsDiv.appendChild(editButton);
                actionsDiv.appendChild(deleteButton);
                item.appendChild(textSpan);
                item.appendChild(actionsDiv);
            }
            return item;
        };
        const editNote = (id, item, textSpan) => {
            const currentText = textSpan.textContent;
            const textarea = document.createElement('textarea');
            textarea.value = currentText;
            textarea.className = 'w-full h-full p-1 border rounded flex-grow bg-white';
            const actionsDiv = item.querySelector('.task-actions');
            if (actionsDiv) actionsDiv.style.visibility = 'hidden';
            item.replaceChild(textarea, textSpan);
            textarea.focus();
            const saveChanges = async () => {
                const newText = textarea.value.trim();
                if (newText && newText !== currentText) {
                    const isSecret = allNotes.find(n => n.id === id)?.isSecret || false;
                    let dataToUpdate = {};
                    if(isSecret) {
                        const password = '0124';
                        dataToUpdate.content = await encryptText(newText, password);
                    } else {
                        dataToUpdate.text = newText;
                    }
                    await updateDoc(doc(db, "hubs", currentMode, "notes", id), dataToUpdate);
                }
                item.replaceChild(textSpan, textarea);
                if (actionsDiv) actionsDiv.style.visibility = '';
            };
            textarea.addEventListener('blur', saveChanges);
            textarea.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') { textarea.value = currentText; textarea.blur(); }
            });
        };
        const addNote = async (text) => {
            try {
                const password = '0124';
                const encryptedContent = await encryptText(text, password);
                await addDoc(collection(db, "hubs", currentMode, "notes"), { content: encryptedContent, isSecret: true });
            } catch (e) {
                console.error("Error adding note: ", e);
                showNotification('Failed to add note.', true);
            }
        };
        const deleteNote = async (id) => { const confirmed = await showConfirmModal('Are you sure you want to delete this note?'); if (confirmed) { try { await deleteDoc(doc(db, "hubs", currentMode, "notes", id)); showNotification('Note deleted.'); } catch (e) { showNotification('Failed to delete note.', true); } } };

        // --- Crypto Functions for Secret Notes ---
        async function getKey(password, salt) {
            const enc = new TextEncoder();
            const keyMaterial = await window.crypto.subtle.importKey(
                "raw", enc.encode(password), { name: "PBKDF2" }, false, ["deriveKey"]
            );
            return window.crypto.subtle.deriveKey(
                { name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" },
                keyMaterial, { name: "AES-GCM", length: 256 }, true, ["encrypt", "decrypt"]
            );
        }

        async function encryptText(text, password) {
            const salt = window.crypto.getRandomValues(new Uint8Array(16));
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const key = await getKey(password, salt);
            const enc = new TextEncoder();
            const encodedText = enc.encode(text);
            const encryptedContent = await window.crypto.subtle.encrypt(
                { name: "AES-GCM", iv: iv }, key, encodedText
            );
            const encryptedArr = new Uint8Array(encryptedContent);
            const finalArr = new Uint8Array(salt.length + iv.length + encryptedArr.length);
            finalArr.set(salt);
            finalArr.set(iv, salt.length);
            finalArr.set(encryptedArr, salt.length + iv.length);
            return btoa(String.fromCharCode.apply(null, finalArr)); // to base64
        }
        
        async function decryptText(encryptedBase64, password) {
            try {
                const encryptedArr = new Uint8Array(atob(encryptedBase64).split("").map(c => c.charCodeAt(0)));
                const salt = encryptedArr.slice(0, 16);
                const iv = encryptedArr.slice(16, 28);
                const data = encryptedArr.slice(28);
                const key = await getKey(password, salt);
                const decryptedContent = await window.crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: iv }, key, data
                );
                const dec = new TextDecoder();
                return dec.decode(decryptedContent);
            } catch (e) {
                console.error("Decryption failed", e);
                return null;
            }
        }

        const openPasswordModal = () => {
            const modal = document.getElementById('password-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        const closePasswordModal = () => {
            document.getElementById('password-modal').classList.add('hidden');
            document.getElementById('password-form').reset();
        };

        // --- Mode Switching ---
        const switchMode = (newMode) => {
            if (currentMode === newMode) return;
            currentMode = newMode;
            localStorage.setItem('currentMode', newMode);
            notesUnlocked = false; // Reset lock status on mode switch
            updateModeUI();
            
            listeners.forEach(unsubscribe => unsubscribe());
            listeners = [];

            initializeListeners(newMode);
            renderCalendar();
        };

        const updateModeUI = () => {
            const personalBtn = document.getElementById('personal-mode-btn');
            const workingBtn = document.getElementById('working-mode-btn');
            if (currentMode === 'personal') {
                personalBtn.classList.add('active');
                workingBtn.classList.remove('active');
            } else {
                workingBtn.classList.add('active');
                personalBtn.classList.remove('active');
            }
        };

        // --- Event Listeners & Initializers ---
        const initializeListeners = (mode) => {
            const tasksListener = onSnapshot(query(collection(db, "hubs", mode, "tasks")), (snapshot) => { allTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderBoard(); });
            const columnsListener = onSnapshot(query(collection(db, "hubs", mode, "board_columns"), orderBy("order")), (snapshot) => { boardColumns = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderBoard(); });
            const notesListener = onSnapshot(query(collection(db, "hubs", mode, "notes")), (snapshot) => { allNotes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderNotes(); });
            
            listeners.push(tasksListener, columnsListener, notesListener);
        };

        document.getElementById('personal-mode-btn').addEventListener('click', () => switchMode('personal'));
        document.getElementById('working-mode-btn').addEventListener('click', () => switchMode('working'));

        document.getElementById('task-form').addEventListener('submit', (e) => { e.preventDefault(); const input = document.getElementById('task-input'); if (input.value.trim() !== '') { addTask(input.value.trim()); input.value = ''; } });
        document.getElementById('note-form').addEventListener('submit', (e) => { e.preventDefault(); const input = document.getElementById('note-input'); if (input.value.trim() !== '') { addNote(input.value.trim()); input.value = ''; } });
        document.getElementById('routine-form').addEventListener('submit', (e) => { e.preventDefault(); const textInput = document.getElementById('routine-input'); const timeInput = document.getElementById('routine-time-input'); const text = textInput.value.trim(); const time = timeInput.value; if (text !== '' && selectedDateStr) { addRoutine(text, time, selectedDateStr); textInput.value = ''; timeInput.value = ''; } });
        document.getElementById('recurring-routine-form').addEventListener('submit', (e) => { e.preventDefault(); const textInput = document.getElementById('recurring-routine-input'); const timeInput = document.getElementById('recurring-routine-time'); const daySelect = document.getElementById('recurring-day-select'); const text = textInput.value.trim(); const time = timeInput.value; if (text !== '') { addRecurringRoutine(text, time, daySelect.value); textInput.value = ''; timeInput.value = ''; } });
        document.getElementById('recurring-routine-form-modal').addEventListener('submit', (e) => { e.preventDefault(); const textInput = document.getElementById('recurring-routine-input-modal'); const timeInput = document.getElementById('recurring-routine-time-modal'); const daySelect = document.getElementById('recurring-day-select-modal'); const text = textInput.value.trim(); const time = timeInput.value; if (text !== '') { addRecurringRoutine(text, time, daySelect.value); textInput.value = ''; timeInput.value = ''; document.getElementById('recurring-routine-modal').classList.add('hidden'); } });
        document.getElementById('edit-routine-form').addEventListener('submit', (e) => { e.preventDefault(); const id = document.getElementById('edit-routine-id').value; const text = document.getElementById('edit-routine-input').value.trim(); const time = document.getElementById('edit-routine-time-input').value; if (text) { updateRoutine(id, text, time); } closeEditRoutineModal(); });
        document.getElementById('column-form').addEventListener('submit', (e) => { e.preventDefault(); const id = document.getElementById('column-id-input').value; const name = document.getElementById('column-name-input').value; saveColumn(id, name); });
        document.getElementById('password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('password-input').value;
            const firstSecretNote = allNotes.find(n => n.isSecret);
            if (firstSecretNote) {
                const decryptedText = await decryptText(firstSecretNote.content, password);
                if (decryptedText) {
                    notesUnlocked = true;
                    // Decrypt all notes and store them temporarily
                    const decryptionPromises = allNotes.map(async (note) => {
                        if (note.isSecret) {
                            note.decryptedText = await decryptText(note.content, password);
                        }
                        return note;
                    });
                    allNotes = await Promise.all(decryptionPromises);
                    renderNotes();
                    showNotification("Notes unlocked!");
                    closePasswordModal();
                } else {
                    showNotification("Wrong password!", true);
                }
            } else {
                 showNotification("No secret notes to unlock.", true);
                 closePasswordModal();
            }
        });
        
        const addDragEventsToTask = (task) => { task.addEventListener('dragstart', (e) => { task.classList.add('dragging'); e.dataTransfer.setData('text/plain', task.dataset.id); }); task.addEventListener('dragend', () => task.classList.remove('dragging')); };
        document.body.addEventListener('drop', (e) => { const columnEl = e.target.closest('.kanban-column'); if (columnEl) { const taskId = e.dataTransfer.getData('text/plain'); const newColumnId = columnEl.dataset.columnId; if(taskId && newColumnId) { updateDoc(doc(db, "hubs", currentMode, "tasks", taskId), { columnId: newColumnId }); } } });
        document.body.addEventListener('dragover', (e) => { if(e.target.closest('.kanban-column')) { e.preventDefault(); } });
        
        document.getElementById('prev-month-btn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
        document.getElementById('next-month-btn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
        document.getElementById('close-routine-modal-btn').addEventListener('click', closeRoutineModal);
        document.getElementById('cancel-edit-routine-btn').addEventListener('click', closeEditRoutineModal);
        document.getElementById('mobile-recurring-btn').addEventListener('click', () => document.getElementById('recurring-routine-modal').classList.remove('hidden'));
        document.getElementById('close-recurring-modal-btn').addEventListener('click', () => document.getElementById('recurring-routine-modal').classList.add('hidden'));
        document.getElementById('cancel-column-btn').addEventListener('click', closeColumnModal);
        document.getElementById('cancel-password-btn').addEventListener('click', closePasswordModal);
        window.addEventListener('resize', renderCalendar);

        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });
        
        // Initial setup
        updateModeUI();
        initializeListeners(currentMode);
        renderCalendar();

    </script>
</body>
</html>
