<!DOCTYPE html>
<html lang="en" style="scroll-behavior: smooth;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Project Hub (Firebase)</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Icon Library for buttons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- PWA manifest & mobile meta -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0b1220">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <style>
        :root {
            --bg: #f8fafc;
            --card: #ffffff;
            --card-border: rgba(15,23,36,0.06);
            --text: #1f2937;
            --muted: #6b7280;
            --accent: #3b82f6;
        }

        .dark {
            --bg: #0b1220;
            --card: #0f1724;
            --card-border: rgba(255,255,255,0.06);
            --text: #e6eef8;
            --muted: #9ca3af;
            --accent: #60a5fa;
        }

    /* Card borders for task cards */
    .task-card {
        border: 1px solid var(--card-border);
        padding: 0.9rem; /* snugger padding for tasks */
        border-radius: 12px;
        min-height: initial;
        height: auto;
        align-items: flex-start;
        display: flex;
        gap: 0.5rem;
    }
    /* Note cards keep a larger min height */
    .note-item {
        border: 1px solid var(--card-border);
        padding: 1.25rem; /* larger padding */
        min-height: 160px; /* larger cards */
        border-radius: 12px;
    }

        /* Ensure card borders are visible in dark mode (stronger contrast) */
        .dark .task-card, .dark .note-item {
            border: 1px solid rgba(255,255,255,0.22) !important; /* brighter border */
            box-shadow: 0 1px 4px rgba(0,0,0,0.45); /* subtle outer shadow for separation */
        }

        /* Kanban column borders (structure of board) */
        .kanban-column {
            border: 1px solid rgba(0,0,0,0.06);
            background-color: rgba(255,255,255,0.02);
        }

        /* Stronger column borders in dark mode so structure is visible */
        .dark .kanban-column {
            border: 1px solid rgba(255,255,255,0.12) !important;
            background-color: rgba(255,255,255,0.02) !important;
        }

        .kanban-column .kanban-column-header {
            border-bottom: 1px solid rgba(0,0,0,0.08);
        }

        /* Limit visible tasks to ~6 items per column; enable vertical scroll when more tasks exist */
        .task-list {
            max-height: 420px; /* roughly 6 tasks at ~64-70px each including gaps */
            overflow-y: auto;
            scroll-behavior: smooth;
            position: relative;
            padding-right: 6px; /* spacing for scrollbar */
        }

    /* subtle gradient hint to show there's more content when scrollable */
    .task-list::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 28px;
            pointer-events: none;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0.9));
            opacity: 0.9;
        }
    .dark .task-list::after {
            background: linear-gradient(to bottom, rgba(15,23,36,0), rgba(15,23,36,0.9));
        }
    /* hide gradient by default; only show when is-scrollable is set */
    .task-list::after { display: none; }
    .task-list.is-scrollable::after { display: block; }

        /* Custom scrollbar styling */
        .task-list::-webkit-scrollbar { width: 8px; }
        .task-list::-webkit-scrollbar-thumb { background: rgba(100,116,139,0.4); border-radius: 8px; }
        .dark .task-list::-webkit-scrollbar-thumb { background: rgba(148,163,184,0.18); }

        /* Full-page trade journal layout - tuned to match Project Board visuals */
        body.trade-full {
            background: linear(180deg, #0b0b0b 0%, #0b0b0b 100%);
        }
        body.trade-full #trade-section {
            /* limit width but allow breathing room on large screens */
            max-width: 1200px;
            margin: 28px auto;
            min-height: calc(100vh - 160px);
            box-shadow: 0 14px 36px rgba(2,6,23,0.13);
            border-radius: 14px;
            padding: 1.5rem; /* match Tailwind p-6 */
            background: #0b0b0b; /* dark background for trade full view */
            color: #e6eef8; /* light text */
            transition: all 180ms ease;
        }

        /* Trade Journal: improve vertical rhythm â€” apply spacing to inner wrapper children and panels */
        /* target the inner max-width wrapper's direct children so spacing applies regardless of nesting */
        #trade-section .max-w-5xl > * {
            margin-top: 1.0rem;
            margin-bottom: 1.6rem;
        }
        #trade-section .max-w-5xl > *:first-child { margin-top: 0; }
        #trade-section .max-w-5xl > *:last-child { margin-bottom: 0; }

        /* extra spacing for key panels and table containers to make sections more distinct */
        #trade-section #trade-rules-panel,
        #trade-section #trade-analytics,
        #trade-section #capital-panel,
        #trade-section #trade-notes-panel,
        #trade-section .overflow-x-auto {
            margin-top: 1.4rem;
            margin-bottom: 1.8rem;
        }

        /* make commonly used margin utility classes slightly larger inside trade for consistency */
        #trade-section .mb-4, #trade-section .mb-6 {
            margin-bottom: 1.25rem !important;
        }

        /* desktop: increase breathing room on larger screens */
        @media (min-width: 768px) {
            #trade-section .max-w-5xl > * { margin-top: 1.4rem; margin-bottom: 2rem; }
            #trade-section #trade-rules-panel,
            #trade-section #trade-analytics,
            #trade-section #capital-panel,
            #trade-section #trade-notes-panel { margin-top: 1.6rem; margin-bottom: 2.2rem; }
        }

        /* Ensure the Trade Journal keeps the same light card/background/text styles
           as the Personal (Project Board) page even if some utility classes linger. */
        #trade-section, body.trade-full #trade-section {
            background-color: var(--card) !important;
            color: var(--text) !important;
        }
        #trade-section .bg-white, #trade-section .panel, #trade-section .card, #trade-section .note-item, #trade-section .task-card {
            background-color: var(--card) !important;
            color: var(--text) !important;
        }
        #trade-section input, #trade-section textarea, #trade-section select {
            background-color: #ffffff !important;
            color: var(--text) !important;
            border-color: rgba(15,23,36,0.06) !important;
        }
        @media (min-width: 768px) {
            body.trade-full #trade-section { padding: 2rem; /* md:p-8 */ }
        }
        /* Ensure common panels/cards inside the trade panel sit above background but don't interfere with fixed overlays */
    body.trade-full #trade-section .panel, body.trade-full #trade-section .card, body.trade-full #trade-section .note-item, body.trade-full #trade-section .task-card { z-index: 2; position: relative; }
          /* We now use JS to toggle utility classes on elements inside the trade panel when entering full-page mode.
              That avoids needing !important overrides and keeps styling consistent with Tailwind utilities. */

        .dark .kanban-column .kanban-column-header {
            border-bottom: 1px solid rgba(255,255,255,0.06) !important;
        }

        /* Folder list styles: vertical on mobile, horizontal on desktop */
        #folder-list {
            display: flex;
            flex-direction: column; /* vertical stack on small screens */
            gap: 0.5rem;
            overflow-y: auto;
            max-height: 60vh;
            padding-bottom: 4px;
            -webkit-overflow-scrolling: touch;
        }
        .folder-btn {
            padding: 0.6rem 0.75rem;
            border-radius: 8px;
            background-color: #f3f4f6; /* gray-100 */
            color: #374151; /* gray-700 */
            border: 1px solid rgba(15,23,36,0.06);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%; /* full width on mobile */
            justify-content: space-between;
        }
        .folder-title {
            flex: 1 1 auto;
            min-width: 0; /* allow ellipsis */
            white-space: normal; /* allow wrapping on small screens */
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .folder-actions {
            flex: 0 0 auto;
            display: inline-flex;
            gap: 8px;
            align-items: center;
            margin-left: 8px;
        }
        .folder-btn:hover { background-color: #e6e9ef; }
        .folder-btn.active {
            background-color: #4338ca; /* indigo-700 */
            color: white;
            border-color: rgba(67,56,202,0.9);
        }
        /* Stack folder bar on small screens */
        #folders-bar { flex-direction: column; align-items: stretch; }

        /* Desktop: show folders as cards in a grid to avoid horizontal scrolling */
        @media (min-width: 768px) {
            #folder-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; overflow: visible; max-height: none; }
            .folder-btn { width: 100%; padding: 1rem; border-radius: 12px; justify-content: space-between; display: flex; align-items: center; }
            .folder-title { white-space: nowrap; }
            #folders-bar { flex-direction: column; align-items: stretch; }
        }

        /* Folder modal */
        #folder-modal .modal-panel { width: 100%; max-width: 460px; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
        }

        /* Theme-aware overrides for commonly used utility classes */
        .dark .bg-white, .dark .bg-gray-50, .dark .bg-gray-100, .dark .bg-yellow-50 {
            background-color: var(--card) !important;
        }
        .dark .text-gray-800, .dark .text-gray-700 {
            color: var(--text) !important;
        }
        .dark .text-gray-500, .dark .text-gray-600 {
            color: var(--muted) !important;
        }
        /* Soften primary/secondary button colors in dark mode to avoid harsh contrast */
        .dark .bg-blue-600 {
            background-color: rgba(96,165,250,0.16) !important; /* subtle blue */
            color: var(--text) !important;
            border: 1px solid rgba(96,165,250,0.22);
        }
        .dark .bg-indigo-600 {
            background-color: rgba(99,102,241,0.14) !important;
            color: var(--text) !important;
            border: 1px solid rgba(99,102,241,0.18);
        }
        .dark .bg-indigo-500 {
            background-color: rgba(79,70,229,0.12) !important;
            color: var(--text) !important;
            border: 1px solid rgba(79,70,229,0.16);
        }
        .dark .bg-yellow-500 {
            background-color: rgba(245,158,11,0.10) !important; /* muted yellow */
            color: var(--text) !important;
            border: 1px solid rgba(245,158,11,0.12);
        }
        .dark .bg-gray-200 {
            background-color: rgba(148,163,184,0.08) !important;
            color: var(--text) !important;
        }

        /* Calendar: slightly darker than page background but still readable */
        .dark .calendar-day {
            background-color: #0f1724 !important; /* slightly lighter than page bg */
            color: var(--text) !important;
            border-color: rgba(255,255,255,0.04) !important;
        }
        .dark .day-header {
            border-bottom-color: rgba(255,255,255,0.06) !important;
        }
        .dark .day-routine-list {
            background-color: rgba(255,255,255,0.02) !important; /* subtle light area */
            color: var(--text) !important;
        }
        .dark .today .day-number {
            background-color: var(--accent) !important;
            color: white !important;
        }

        /* Notes textarea in dark mode: slightly dark input with clear text (modal) */
        .dark #note-modal-input, .dark textarea {
            background-color: #0b1220 !important;
            color: var(--text) !important;
            border: 1px solid rgba(255,255,255,0.06) !important;
        }

        /* Form controls on modals / add-edit follow dark mode */
        .dark input[type="text"], .dark input[type="password"], .dark input[type="time"], .dark textarea, .dark select, .dark input {
            background-color: #0b1220 !important;
            color: var(--text) !important;
            border: 1px solid rgba(255,255,255,0.06) !important;
        }
        .dark .bg-white, .dark .rounded-xl, .dark .rounded-lg {
            background-color: var(--card) !important;
        }
        /* Dark mode: folder cards should match dark surface */
        .dark #folders-bar { background: transparent; }
        .dark #folder-list { background: transparent; }
        .dark .folder-btn {
            background-color: var(--card) !important;
            color: var(--text) !important;
            border: 1px solid rgba(255,255,255,0.06) !important;
        }
        .dark .folder-btn .folder-title, .dark .folder-title { color: var(--text) !important; }
        .dark .folder-actions i { color: rgba(255,255,255,0.6) !important; }
        .dark .folder-btn.active { background-color: rgba(79,70,229,0.12) !important; color: var(--text) !important; }
    /* Desktop nav color adjustments in dark mode */
    .dark header a { color: var(--muted) !important; }
    .dark header a:hover { color: var(--accent) !important; }
    .dark header { background-color: var(--card) !important; box-shadow: 0 2px 10px rgba(0,0,0,0.4); }
        .dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }
        .drag-over {
            background-color: #e0f2fe; /* Light blue on drag over */
        }
        .task-card, .note-item, .routine-item {
            transition: all 0.2s ease-in-out;
        }
        .task-card:hover, .note-item:hover {
                transform: translateY(-4px);
                box-shadow: 0 8px 20px rgba(0,0,0,0.08);
        }
        .task-card, .routine-item, .note-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .task-actions i, .column-actions i {
            color: #9ca3af;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s ease-in-out, color 0.2s ease-in-out;
            cursor: pointer;
            margin-left: 8px;
        }

        /* Task text: smaller and wrap so card height adjusts to content */
        .task-text {
            display: inline-block;
            white-space: normal;
            word-break: break-word;
            color: var(--text);
            font-size: 0.9rem; /* slightly smaller */
            line-height: 1.25;
        }

        /* Task actions positioned on the right, do not push card height */
        .task-actions { margin-left: auto; display: inline-flex; gap: 8px; align-items: center; }

        /* drag handle removed (dragging will be available across the card) */

        /* Editing textarea transition */
        textarea.autosize-transition { transition: height 0.14s ease, opacity 0.12s ease; opacity: 0.98; }

        /* Clamp long task text to 3 lines and provide a toggle */
        .task-text.clamped {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .note-body {
            white-space: pre-wrap; /* preserve newlines */
        }
        .clamped-note {
            display: -webkit-box;
            -webkit-line-clamp: 6;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .task-content { display: flex; flex-direction: column; gap: 6px; flex: 1 1 auto; min-width: 0; }

        /* Preserve newlines in notes display */
        .note-content p { white-space: pre-wrap; }
        .task-card:hover .task-actions i, .routine-item:hover .task-actions i, .note-item:hover .task-actions i, .kanban-column-header:hover .column-actions i {
            visibility: visible;
            opacity: 1;
        }
        .task-actions i:hover, .column-actions i:hover {
            color: #3b82f6; /* blue-500 */
        }
        .task-actions .delete-btn:hover, .column-actions .delete-btn:hover {
            color: #ef4444; /* red-500 */
        }
        .routine-item.completed span, .routine-item.completed strong {
            text-decoration: line-through;
            color: #9ca3af; /* gray-400 */
        }
        .note-item {
            align-items: stretch;
            flex-direction: column;
            justify-content: flex-start;
            position: relative; /* allow absolute actions */
        }

        /* Note content container to keep cards uniform */
        .note-item .note-content {
            flex: 1 1 auto;
            overflow: hidden;
            display: flex;
            align-items: flex-start;
        }

        /* Actions inside the note card: inline in header beside the title */
        .note-actions {
            position: static; /* flow with header */
            display: flex;
            gap: 8px;
            align-items: center;
            margin-left: auto;
            z-index: 2;
        }

    .note-actions i { color: #6b7280; opacity: 1; transform: translateY(0); transition: color 0.18s ease; cursor: pointer; }
    .note-item:hover .note-actions i { color: #3b82f6; }
        .section-divider {
            border: 0;
            height: 1px;
            background-image: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0));
            margin: 3rem 0;
        }
        /* Calendar Styles */
        .calendar-day {
            min-height: 140px;
            display: flex;
            flex-direction: column;
            position: relative;
            background-color: white;
        }
        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px;
            border-bottom: 1px solid #e5e7eb;
        }
        .day-info {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .day-name {
            font-size: 0.7rem;
            color: #6b7280;
            background-color: #f3f4f6;
            padding: 2px 6px;
            border-radius: 999px;
        }
        .today .day-number {
            background-color: #3b82f6;
            color: white;
        }
        .day-number {
            font-weight: 500;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .weekend-day {
            background-color: rgba(254, 226, 226, 0.7); /* light red for default (light) mode */
        }

        /* In dark mode, make weekend cells semi-red with 50% opacity */
        .dark .weekend-day {
            background-color: rgba(220, 38, 38, 0.2) !important; /* red with 20% opacity */
        }
        .other-month {
            color: #d1d5db;
            background-color: #f9fafb;
        }
        .day-routine-list {
            font-size: 0.75rem; /* text-xs */
            line-height: 1.1;
            margin-top: 4px;
            overflow-y: auto;
            flex-grow: 1;
            padding: 4px;
            background-color: #eff6ff; /* blue-50 */
            border-radius: 0 0 0.5rem 0.5rem;
        }
        .day-routine-item {
            display: flex;
            align-items: center;
            padding: 2px;
            border-radius: 4px;
        }
        .day-routine-item:hover {
            background-color: #dbeafe;
        }
        .add-routine-btn {
            color: #9ca3af;
            cursor: pointer;
            visibility: hidden;
            opacity: 0;
            transition: all 0.2s;
        }
        .calendar-day:hover .add-routine-btn {
            visibility: visible;
            opacity: 1;
        }
        /* Mode Toggle Styles */
        /* Unified active style for header mode/trade buttons */
        .mode-toggle button.active,
        .mode-toggle button.p-2.active,
        #trade-btn.active {
            background-color: var(--accent) !important;
            color: white !important;
        }
        /* Focus and animation for header buttons */
        .mode-toggle button, #trade-btn {
            transition: transform 0.12s ease, box-shadow 0.12s ease, background-color 0.12s ease;
        }
        .mode-toggle button:focus, #trade-btn:focus {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79,70,229,0.18);
            outline: 2px solid rgba(79,70,229,0.18);
        }
        .mode-toggle button.p-2 i { color: inherit; }
        /* Universal Board Scroll */
        #board {
            display: flex;
            overflow-x: auto;
            padding-bottom: 1rem;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
            scroll-snap-type: x mandatory;
            gap: 1rem;
        }
        #board::-webkit-scrollbar {
            display: none; /* Safari and Chrome */
        }
        .kanban-column {
            width: 85%;
            max-width: 320px;
            flex-shrink: 0;
            scroll-snap-align: start;
        }
        @media (min-width: 768px) {
            .kanban-column {
                width: 100%;
            }
        }
        /* Mobile specific styles */
        @media (max-width: 768px) {
            .calendar-day {
                min-height: 60px;
                padding: 2px;
            }
            .day-header {
                padding: 2px;
                border-bottom: none;
            }
            .day-name { display: none; }
            .day-routine-list { display: none; }
            .add-routine-btn { display: none; }
            .calendar-day {
                cursor: pointer;
            }
            .day-number {
                width: 24px;
                height: 24px;
                font-size: 0.8rem;
            }
            .selected-day {
                outline: 2px solid #3b82f6;
                border-radius: 0.5rem;
            }
        }
    </style>
</head>
<body class="text-gray-800 pt-16">

    <header class="bg-white shadow-md fixed top-0 left-0 right-0 z-30">
        <nav class="container mx-auto px-4 md:px-8 flex justify-between items-center py-3">
            <!-- Logo -->
            <a href="#" class="flex items-center space-x-2">
                <img src="LogoAT.png" alt="Logo" class="h-10 w-10 rounded-full">
                <span class="font-bold text-xl text-gray-800 hidden sm:block">Project Board AT</span>
            </a>

            <!-- Desktop Navigation -->
            <div class="hidden md:flex items-center gap-6 ml-4">
                <a href="#project-board-section" class="text-sm text-gray-600 hover:text-indigo-500">Project Board</a>
                <a href="#daily-routine-section" class="text-sm text-gray-600 hover:text-indigo-500">Daily Routine</a>
                <a href="#important-notes-section" class="text-sm text-gray-600 hover:text-indigo-500">Notes</a>
            </div>

            <!-- Right controls: desktop theme toggle, personal/working icon toggles, mobile menu button -->
            <div class="flex items-center gap-3 ml-auto">
                <button id="theme-toggle" title="Toggle theme" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 hidden md:inline-flex">
                    <i class="fas fa-moon"></i>
                </button>
                <button id="trade-btn" title="Trade Journal" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200 ml-2 hidden md:inline-flex" aria-pressed="false" aria-label="Open Trade Journal">
                    <i class="fas fa-chart-line"></i>
                </button>
                <div class="mode-toggle flex items-center gap-2" role="tablist" aria-label="Workspace modes">
                    <button id="personal-mode-btn" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200" title="Personal" aria-pressed="false" aria-label="Switch to personal workspace" role="tab"> <i class="fas fa-user" aria-hidden="true"></i></button>
                    <button id="working-mode-btn" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200" title="Working" aria-pressed="false" aria-label="Switch to working workspace" role="tab"> <i class="fas fa-briefcase" aria-hidden="true"></i></button>
                </div>
                <!-- install button removed per request (download icon) -->
                <div class="md:hidden">
                    <button id="mobile-menu-button" class="text-gray-600 hover:text-indigo-600 focus:outline-none">
                        <i class="fas fa-bars text-2xl"></i>
                    </button>
                </div>
            </div>
        </nav>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-white border-t">
            <a href="#project-board-section" class="block py-2 px-4 text-sm text-gray-700 hover:bg-gray-100">Project Board</a>
            <a href="#daily-routine-section" class="block py-2 px-4 text-sm text-gray-700 hover:bg-gray-100">Daily Routine</a>
            <a href="#important-notes-section" class="block py-2 px-4 text-sm text-gray-700 hover:bg-gray-100">Notes</a>
        </div>
    </header>

    <main class="container mx-auto p-4 md:px-8">
        <!-- Project Board Section -->
        <div id="project-board-section" class="bg-white rounded-xl shadow-sm p-6 md:p-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-2 text-center">Project Board</h2>
            <p id="board-mode-label" class="text-sm text-gray-600 mb-6 text-center">Mode: </p>
            <div class="mb-8 w-full">
                <div class="max-w-full mx-auto flex justify-center md:justify-end">
                 <button id="add-task-btn" class="ml-auto md:ml-0 md:mr-0 w-full md:w-auto bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-transform hover:scale-105">
                    Add New Task
                </button>
                </div>
            </div>

            <div id="board">
                <!-- Board columns will be rendered here by JS -->
            </div>
        </div>
        
        <!-- Trade Journal Section (polished) -->
        <div id="trade-section" class="bg-white rounded-xl shadow-sm p-6 md:p-8 hidden">
            <div class="max-w-5xl mx-auto">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h2 class="text-2xl font-semibold text-gray-800">Trade Journal</h2>
                        <p class="text-sm text-gray-500">Record trades, attach screenshots, and review performance.</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button id="trade-new-btn" class="px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">New Trade</button>
                        <button id="trade-refresh" class="px-3 py-2 bg-gray-100 rounded-md hover:bg-gray-200">Refresh</button>
                    </div>
                </div>

                <!-- Trade form modal (was inline panel) -->
                <div id="trade-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden" role="dialog" aria-modal="true">
                    <div class="w-full max-w-3xl rounded-lg p-6 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 shadow-lg relative">
                        <form id="trade-form" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="md:col-span-1">
                            <label class="block text-xs font-medium text-gray-600">Asset</label>
                            <input id="trade-asset" type="text" class="mt-1 w-full p-2 border rounded-md bg-white" placeholder="Bitcoin (BTC)" required />
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-xs font-medium text-gray-600">Pair</label>
                            <input id="trade-pair" type="text" class="mt-1 w-full p-2 border rounded-md bg-white" placeholder="BTC/USDT" required />
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-xs font-medium text-gray-600">Type</label>
                            <select id="trade-type" class="mt-1 w-full p-2 border rounded-md bg-white">
                                <option value="buy">Buy</option>
                                <option value="sell">Sell</option>
                            </select>
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-xs font-medium text-gray-600">Status</label>
                            <select id="trade-status" class="mt-1 w-full p-2 border rounded-md bg-white">
                                <option value="Open">Open</option>
                                <option value="Closed">Closed</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-xs font-medium text-gray-600">Date & Time</label>
                            <input id="trade-datetime" type="datetime-local" class="mt-1 w-full p-2 border rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" />
                        </div>

                        <div class="md:col-span-1">
                            <label class="block text-xs font-medium text-gray-600">Entry</label>
                            <input id="trade-entry" type="number" step="any" class="mt-1 w-full p-2 border rounded-md bg-white" />
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-xs font-medium text-gray-600">Exit</label>
                            <input id="trade-exit" type="number" step="any" class="mt-1 w-full p-2 border rounded-md bg-white" />
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-xs font-medium text-gray-600">Qty</label>
                            <input id="trade-qty" type="number" step="any" class="mt-1 w-full p-2 border rounded-md bg-white" />
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-xs font-medium text-gray-600">Currency</label>
                            <select id="trade-currency" class="mt-1 w-full p-2 border rounded-md bg-white">
                                <option value="USD">USD</option>
                                <option value="IDR">IDR</option>
                                <option value="USDT">USDT</option>
                                <option value="BTC">BTC</option>
                            </select>
                        </div>
                        <!-- Fees and Total removed per user request -->

                        <div class="md:col-span-2">
                            <label class="block text-xs font-medium text-gray-600">Reason to Open</label>
                            <textarea id="trade-open-reason" rows="2" class="mt-1 w-full p-2 border rounded-md bg-white text-sm"></textarea>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs font-medium text-gray-600">Reason to Close</label>
                            <textarea id="trade-close-reason" rows="2" class="mt-1 w-full p-2 border rounded-md bg-white text-sm"></textarea>
                        </div>

                        <!-- Rules checklist inside the New Trade form (must confirm all before saving) -->
                        <div id="trade-form-rules" class="md:col-span-4 mt-2 p-2 bg-gray-50 rounded text-sm text-gray-700">
                            <p class="font-medium mb-1">Confirm Trading Rules</p>
                            <div id="trade-form-rules-list" class="grid gap-2"></div>
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-xs font-medium text-gray-600 mb-1">Screenshots (entry / exit)</label>
                            <div class="flex items-center gap-3">
                                <label for="trade-screenshots" class="cursor-pointer inline-flex items-center gap-2 px-3 py-2 bg-white border rounded-md hover:bg-gray-50">
                                    <i class="fas fa-upload text-gray-600"></i>
                                    <span class="text-sm text-gray-700">Choose images</span>
                                </label>
                                <div id="trade-screenshot-preview" class="text-sm text-gray-500">No files chosen</div>
                            </div>
                            <input id="trade-screenshots" type="file" accept="image/*" multiple class="hidden" />
                        </div>

                        <div class="md:col-span-2 flex justify-end gap-3 mt-2">
                            <button type="button" id="trade-cancel" class="px-4 py-2 bg-gray-200 rounded-md">Cancel</button>
                            <button type="submit" id="trade-save" class="px-4 py-2 bg-indigo-600 text-white rounded-md" style="z-index:99999; position:relative; pointer-events:auto;">Save Trade</button>
                        </div>
                        </form>
                    </div>
                </div>

                        <!-- Trade notes moved below capital panel (see below) -->

                <div class="mb-4 flex items-center gap-3">
                    <input id="trade-filter-asset" placeholder="Asset" class="p-2 border rounded-md" />
                    <input id="trade-filter-pair" placeholder="Pair" class="p-2 border rounded-md" />
                    <select id="trade-filter-status" class="p-2 border rounded-md">
                        <option value="">All</option>
                        <option value="open">Open</option>
                        <option value="closed">Closed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                    <button id="trade-filter-apply" class="px-3 py-2 bg-gray-100 rounded-md">Apply</button>
                </div>

                <div class="overflow-x-auto bg-white border rounded-md">
                    <table id="trade-table" class="w-full text-left table-auto">
                        <thead class="bg-gray-800">
                            <tr>
                                <th class="p-3 text-sm font-medium text-white border">No</th>
                                <th class="p-3 text-sm font-medium text-white border">Asset</th>
                                <th class="p-3 text-sm font-medium text-white border">Pair</th>
                                <th class="p-3 text-sm font-medium text-white border">Type</th>
                                <th class="p-3 text-sm font-medium text-white border">Date</th>
                                <th class="p-3 text-sm font-medium text-white border" title="USD">Entry</th>
                                <th class="p-3 text-sm font-medium text-white border" title="USD">Exit</th>
                                <th class="p-3 text-sm font-medium text-white border" title="USD">Qty</th>
                                <th class="p-3 text-sm font-medium text-white border">P/L</th>
                                <th class="p-3 text-sm font-medium text-white border">Screenshots</th>
                                <th class="p-3 text-sm font-medium text-white border">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="trade-table-body" class="bg-white"></tbody>
                    </table>
                </div>
                <!-- Trading Rules checklist shown under the journal table -->
                <div id="trade-rules-panel" class="mt-4 bg-white border rounded-md p-4">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold">Trading Rules (Checklist)</h3>
                        <button id="manage-rules-btn" class="px-3 py-1 bg-gray-100 rounded-md hover:bg-gray-200">Manage Rules</button>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">You must confirm all active rules before saving a trade.</p>
                    <div id="trade-rules-checklist" class="mt-3 grid gap-2"></div>
                </div>
                <!-- Analytics & Summary -->
                <div id="trade-analytics" class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2 bg-white border rounded-md p-4">
                        <h4 class="font-semibold mb-2">Equity Curve</h4>
                        <canvas id="chart-equity" height="140"></canvas>
                        <h4 class="font-semibold mt-4 mb-2">Win Rate</h4>
                        <canvas id="chart-winrate" height="80"></canvas>
                    </div>
                    <div class="bg-white border rounded-md p-4">
                        <h4 class="font-semibold mb-2">Aggregated Stats</h4>
                        <div id="agg-stats" class="text-sm text-gray-700 space-y-2">
                            <div>Total Trades: <span id="stat-total">0</span></div>
                            <div>Wins: <span id="stat-wins">0</span></div>
                            <div>Losses: <span id="stat-losses">0</span></div>
                            <div>Win Rate: <span id="stat-winrate">0%</span></div>
                            <div>Avg P/L: <span id="stat-avgpl">0</span></div>
                            <div>Max Drawdown: <span id="stat-mdd">0</span></div>
                        </div>
                    </div>
                </div>

                <!-- Capital Management (Manajemen Modal) -->
                <div id="capital-panel" class="mt-6 bg-white border rounded-md p-4">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-semibold">Manajemen Modal</h3>
                        <button id="capital-new-btn" class="px-3 py-1 bg-green-600 text-white rounded-md">Tambah</button>
                    </div>
                    <div id="capital-summary" class="text-sm text-gray-700 mb-3">Saldo: <span id="capital-balance">Rp 0</span></div>
                    <div class="overflow-x-auto bg-white border rounded-md">
                        <table id="capital-table" class="w-full text-left table-auto">
                            <thead class="bg-gray-800">
                                <tr>
                                    <th class="p-3 text-sm font-medium text-white border">Tgl</th>
                                    <th class="p-3 text-sm font-medium text-white border">Tipe</th>
                                    <th class="p-3 text-sm font-medium text-white border">Jumlah (IDR)</th>
                                    <th class="p-3 text-sm font-medium text-white border">Catatan</th>
                                    <th class="p-3 text-sm font-medium text-white border">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="capital-table-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Important Notes (Trade Journal) - placed directly under Capital Management for visibility -->
                <div id="trade-notes-panel" class="mt-6 bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800">Important Notes</h3>
                            <p class="text-sm text-gray-500">Notes specific to your Trade Journal. These are stored separately from Personal/Working notes.</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <button id="trade-add-folder-btn" class="px-3 py-2 bg-gray-100 text-sm text-gray-700 rounded-md hover:bg-gray-200">+ Add Folder</button>
                            <button id="trade-header-add-note-btn" class="px-3 py-2 bg-yellow-500 text-white text-sm rounded-md hover:bg-yellow-600"><i class="fas fa-plus mr-2"></i> Add Note</button>
                        </div>
                    </div>

                    <div id="trade-folders-bar" class="mb-4">
                        <div id="trade-folder-list" class="flex items-center gap-3 overflow-auto"></div>
                    </div>

                    <!-- Notes area: hidden until a folder selected -->
                    <div id="trade-notes-area" class="hidden">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <button id="trade-back-to-folders" class="px-3 py-2 bg-gray-100 rounded-md hover:bg-gray-200">&larr; Back</button>
                                <h4 id="trade-current-folder-name" class="text-lg font-semibold text-gray-800"></h4>
                            </div>
                        </div>
                    </div>

                    <div id="trade-notes-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
                </div>
            </div>
        </div>
        
        <hr class="section-divider">

        <!-- Daily Routine Section -->
        <div id="daily-routine-section" class="bg-white rounded-xl shadow-sm p-6 md:p-8">
            <div class="flex justify-center items-center mb-6 relative">
                 <h2 class="text-3xl font-bold text-gray-800">Daily Routine Calendar</h2>
                 <button id="recurring-btn" class="absolute right-0 bg-indigo-500 text-white rounded-full h-8 w-8 flex items-center justify-center hover:bg-indigo-600">
                    <i class="fas fa-plus"></i>
                 </button>
            </div>
            <div id="calendar-container" class="max-w-full mx-auto">
                <div id="calendar-header" class="flex items-center justify-between mb-4">
                    <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-left"></i></button>
                    <h3 id="month-year-header" class="text-xl font-semibold"></h3>
                    <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div id="calendar-weekdays" class="grid grid-cols-7 gap-2 text-center font-semibold text-gray-600 mb-2">
                    <!-- Weekday names will be populated by JS -->
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-2">
                    <!-- Calendar days will be populated here -->
                </div>
            </div>
             <!-- Mobile Daily Activity View -->
            <div id="mobile-daily-activity" class="md:hidden mt-6 bg-gray-50 p-4 rounded-lg">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Daily Activity</h3>
                <div id="mobile-routine-list">
                    <p class="text-gray-500">Select a date to see your routines.</p>
                </div>
            </div>
        </div>

        <hr class="section-divider">

        <!-- Important Notes Section -->
        <div id="important-notes-section" class="bg-white rounded-xl shadow-sm p-6 md:p-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Important Notes</h2>
            <div class="max-w-full mx-auto px-4">
                <div class="mb-6 max-w-full mx-auto">
                    <div id="folders-bar" class="flex items-center justify-between gap-4 mb-4">
                        <div class="flex items-center gap-2">
                            <button id="add-folder-btn" class="bg-gray-100 text-gray-700 py-2 px-3 rounded-lg hover:bg-gray-200">+ Add Folder</button>
                        </div>
                        <div class="flex items-center gap-3 overflow-auto" id="folder-list">
                            <!-- folders will be rendered here -->
                        </div>
                    </div>

                    <!-- Notes area: hidden by default until a folder is opened -->
                    <div id="notes-area" class="hidden">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                    <button id="back-to-folders" class="px-3 py-2 bg-gray-100 rounded-md hover:bg-gray-200">&larr; Back</button>
                                    <h3 id="current-folder-name" class="text-xl font-semibold"></h3>
                                    <button id="header-add-note-btn" class="ml-3 inline-flex items-center gap-2 bg-yellow-500 text-white px-3 py-2 rounded-md hover:bg-yellow-600"><i class="fas fa-plus"></i> Add Note</button>
                                </div>
                            <div>
                                <!-- optionally folder actions could go here -->
                            </div>
                        </div>

                        <!-- Inline add form removed: use modal to add notes -->

                    </div>

                </div>
                <div id="notes-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-6"></div>
            </div>
        </div>
    </main>
    
    <!-- Modals -->
    <div id="notification-area" class="fixed top-20 left-1/2 -translate-x-1/2 z-50 pointer-events-none">
        <!-- Notification will be injected here -->
    </div>
    <div id="custom-confirm-modal" style="z-index:9999;" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
        <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm mx-auto"><p id="confirm-modal-text" class="text-lg mb-4"></p><div class="flex justify-end gap-4"><button id="confirm-cancel-btn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button><button id="confirm-ok-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button></div></div>
    </div>
    <div id="folder-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="modal-panel bg-white rounded-xl shadow-xl w-full max-w-md mx-auto p-6">
            <h3 id="folder-modal-title" class="text-2xl font-bold mb-4">Add Folder</h3>
            <form id="folder-form">
                <input type="hidden" id="folder-id-input">
                <div>
                    <label for="folder-name-input" class="block text-sm font-medium text-gray-700">Folder Name</label>
                    <input type="text" id="folder-name-input" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-folder-btn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save</button>
                </div>
            </form>
        </div>
    </div>
    <div id="note-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="modal-panel bg-white rounded-xl shadow-xl w-full max-w-md mx-auto p-6">
            <h3 id="note-modal-title" class="text-2xl font-bold mb-4">Add Note</h3>
            <form id="note-modal-form">
                <div class="mb-3">
                    <label for="note-modal-title-input" class="block text-sm font-medium text-gray-700">Title</label>
                    <input id="note-modal-title-input" type="text" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="Title (optional)">
                </div>
                <div class="mb-4">
                    <label for="note-modal-input" class="block text-sm font-medium text-gray-700">Note</label>
                    <textarea id="note-modal-input" rows="6" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500" required></textarea>
                </div>
                <div class="mb-4">
                    <label for="note-modal-folder-select" class="block text-sm font-medium text-gray-700">Folder</label>
                    <select id="note-modal-folder-select" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
                        <option value="">All</option>
                    </select>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-note-btn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">Save</button>
                </div>
            </form>
        </div>
    </div>
    <div id="routine-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-lg mx-auto p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="routine-modal-date" class="text-2xl font-bold"></h3>
                <button id="close-routine-modal-btn" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-times"></i></button>
            </div>
            <div id="modal-routine-list" class="space-y-2 mb-4 max-h-64 overflow-y-auto"></div>
            <form id="routine-form" class="flex flex-col sm:flex-row gap-3">
                <input type="time" id="routine-time-input" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="text" id="routine-input" placeholder="Add a routine for this day..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                <button type="submit" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">Add</button>
            </form>
        </div>
    </div>
    <div id="edit-routine-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg mx-auto p-6">
            <h3 class="text-2xl font-bold mb-4">Edit Routine</h3>
            <form id="edit-routine-form">
                <input type="hidden" id="edit-routine-id">
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="time" id="edit-routine-time-input" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="text" id="edit-routine-input" placeholder="Routine text..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-edit-routine-btn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    <div id="recurring-routine-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg mx-auto p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Add Recurring Routine</h3>
                <button id="close-recurring-modal-btn" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-times"></i></button>
            </div>
            <form id="recurring-routine-form-modal" class="space-y-4">
                <div>
                    <label for="recurring-routine-time-modal" class="block text-sm font-medium text-gray-700">Time</label>
                    <input type="time" id="recurring-routine-time-modal" class="mt-1 p-2 w-full border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="recurring-routine-input-modal" class="block text-sm font-medium text-gray-700">Activity</label>
                    <input type="text" id="recurring-routine-input-modal" placeholder="E.g., Badminton" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Recurrence Mode</label>
                    <div class="mt-2 space-y-2">
                        <label class="flex items-center gap-2"><input type="radio" name="recurring-mode" value="specific" checked /> Specific weekdays</label>
                        <label class="flex items-center gap-2"><input type="radio" name="recurring-mode" value="weekdays" /> Weekdays (Mon-Fri)</label>
                        <label class="flex items-center gap-2"><input type="radio" name="recurring-mode" value="weekends" /> Weekends (Sat-Sun)</label>
                        <label class="flex items-center gap-2"><input type="radio" name="recurring-mode" value="month" /> Whole Month (every day)</label>
                    </div>
                </div>
                <div id="weekday-multi-select" class="mt-3">
                    <label class="block text-sm font-medium text-gray-700">Choose Weekdays</label>
                    <div class="mt-2 grid grid-cols-7 gap-2 text-center">
                        <label class="p-2 border rounded"><input type="checkbox" value="1" />Mon</label>
                        <label class="p-2 border rounded"><input type="checkbox" value="2" />Tue</label>
                        <label class="p-2 border rounded"><input type="checkbox" value="3" />Wed</label>
                        <label class="p-2 border rounded"><input type="checkbox" value="4" />Thu</label>
                        <label class="p-2 border rounded"><input type="checkbox" value="5" />Fri</label>
                        <label class="p-2 border rounded"><input type="checkbox" value="6" />Sat</label>
                        <label class="p-2 border rounded"><input type="checkbox" value="0" />Sun</label>
                    </div>
                </div>
                <div class="flex justify-end pt-2">
                    <button type="submit" class="bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-600 transition-transform hover:scale-105">
                        Add to All
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div id="column-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg mx-auto p-6">
            <h3 id="column-modal-title" class="text-2xl font-bold mb-4"></h3>
            <form id="column-form">
                <input type="hidden" id="column-id-input">
                <div>
                    <label for="column-name-input" class="block text-sm font-medium text-gray-700">Column Name</label>
                    <input type="text" id="column-name-input" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-column-btn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
                </div>
            </form>
        </div>
    </div>
    <!-- password modal removed (secret notes feature disabled) -->
     <div id="add-task-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg mx-auto p-6">
            <h3 class="text-2xl font-bold mb-4">Add New Task</h3>
            <form id="add-task-form-modal">
                <div>
                    <label for="task-input-modal" class="block text-sm font-medium text-gray-700">Task Name</label>
                    <input type="text" id="task-input-modal" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mt-3">
                    <label for="add-task-desc-input" class="block text-sm font-medium text-gray-700">Description (optional)</label>
                    <textarea id="add-task-desc-input" rows="3" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div class="mt-3">
                    <label class="block text-sm font-medium text-gray-700">Images (optional)</label>
                    <div class="mt-2 flex items-center gap-3">
                        <label for="add-task-image-input" class="inline-flex items-center px-3 py-2 bg-gray-100 rounded cursor-pointer hover:bg-gray-200 border">Choose images</label>
                        <span id="add-task-image-filename" class="text-sm text-gray-600"></span>
                    </div>
                    <input id="add-task-image-input" type="file" accept="image/*" multiple class="hidden" />
                    <img id="add-task-image-preview" src="" alt="Preview" class="mt-2 rounded max-h-40 object-contain hidden" />
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-add-task-btn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Rules Management Section (hidden panel/modal) -->
    <div id="rules-section" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-lg p-6 w-11/12 max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Manage Trading Rules</h3>
                <button id="rules-close-btn" class="text-gray-600 hover:text-gray-800">Close</button>
            </div>
            <div class="mb-3 flex gap-2">
                <input id="new-rule-input" type="text" class="flex-1 p-2 border rounded" placeholder="Write a trading rule..." />
                <button id="add-rule-btn" class="px-3 py-2 bg-indigo-600 text-white rounded">Add Rule</button>
            </div>
            <div id="rules-list" class="space-y-2 max-h-64 overflow-auto">
                <!-- rules will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Task Detail Modal -->
    <div id="task-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-3xl mx-auto p-6">
            <h3 id="task-detail-title" class="text-2xl font-bold mb-1">Task</h3>
            <form id="task-detail-form">
                <input type="hidden" id="task-detail-id">
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700">Title</label>
                    <input id="task-detail-title-input" type="text" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="task-detail-desc-input" rows="6" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700">Images</label>
                    <div class="mt-2 flex items-center gap-3">
                        <label for="task-detail-image-input" class="inline-flex items-center px-3 py-2 bg-gray-100 rounded cursor-pointer hover:bg-gray-200 border">Choose images</label>
                        <span id="task-detail-image-filename" class="text-sm text-gray-600"></span>
                        <button id="task-detail-remove-image-btn" type="button" class="px-3 py-1 bg-red-500 text-white rounded hidden">Remove</button>
                    </div>
                    <input id="task-detail-image-input" type="file" accept="image/*" multiple class="hidden" />
                    <img id="task-detail-image-preview" src="" alt="Image" class="mt-2 rounded max-h-40 object-contain hidden" />
                    <!-- Container for saved thumbnails -->
                    <div id="task-detail-thumbs" class="mt-2 flex gap-2 flex-wrap"></div>
                </div>
                <!-- Meta (created/updated) moved below description to match user request -->
                <div id="task-meta" class="text-xs text-gray-500 mb-3"></div>
                <div class="flex justify-between items-center">
                    <button type="button" id="task-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg">Delete</button>
                    <div class="flex gap-2">
                        <button type="button" id="task-cancel-btn" class="px-4 py-2 bg-gray-200 rounded-lg">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Save</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Image preview modal (full screen) -->
    <div id="image-preview-modal" class="fixed inset-0 bg-black bg-opacity-80 z-60 hidden items-center justify-center">
        <div class="max-w-4xl w-full mx-4">
            <div class="relative">
                <button id="image-preview-close" class="absolute right-0 top-0 mt-2 mr-2 px-3 py-2 bg-gray-800 text-white rounded">Close</button>
                <img id="image-preview-img" src="" alt="Preview" class="w-full h-auto rounded" />
            </div>

    <!-- Trade Detail Modal -->
    <div id="trade-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-70">
        <div class="bg-white rounded-lg max-w-3xl w-full p-6">
            <div class="flex items-start justify-between">
                <h3 class="text-xl font-semibold">Trade Details</h3>
                <button id="trade-detail-close" class="text-gray-500 hover:text-gray-800">Close</button>
            </div>
            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <p class="text-sm text-gray-600"><strong>Asset:</strong> <span id="detail-asset"></span></p>
                    <p class="text-sm text-gray-600"><strong>Pair:</strong> <span id="detail-pair"></span></p>
                    <p class="text-sm text-gray-600"><strong>Type:</strong> <span id="detail-type"></span></p>
                    <p class="text-sm text-gray-600"><strong>Date:</strong> <span id="detail-datetime"></span></p>
                    <p class="text-sm text-gray-600"><strong>Entry:</strong> <span id="detail-entry"></span></p>
                    <p class="text-sm text-gray-600"><strong>Exit:</strong> <span id="detail-exit"></span></p>
                    <p class="text-sm text-gray-600"><strong>Qty:</strong> <span id="detail-qty"></span></p>
                    <p class="text-sm text-gray-600"><strong>Fees:</strong> <span id="detail-fees"></span></p>
                    <p class="text-sm text-gray-600"><strong>Total:</strong> <span id="detail-total"></span></p>
                    <p class="text-sm text-gray-600"><strong>P/L:</strong> <span id="detail-pl"></span></p>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-700">Reason to Open</p>
                    <div id="detail-open-reason" class="p-2 bg-gray-50 rounded text-sm text-gray-700"></div>
                    <p class="text-sm font-medium text-gray-700 mt-3">Reason to Close</p>
                    <div id="detail-close-reason" class="p-2 bg-gray-50 rounded text-sm text-gray-700"></div>
                    <div class="mt-3">
                        <p class="text-sm font-medium text-gray-700">Screenshots</p>
                        <div id="detail-screenshots" class="mt-2 flex gap-2 flex-wrap"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Capital modal removed -->
        </div>
    </div>

    <script type="module">
        // PWA: service worker registration and beforeinstallprompt handling
    let deferredPrompt = null;

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            deferredPrompt = e;
            // (install button removed) service worker logic retained below
        });

        // Register service worker if available
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => {
                        console.log('Service worker registered.', reg);
                    })
                    .catch(err => console.warn('Service worker registration failed:', err));
            });
        }

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, where, getDocs, getDoc, writeBatch, orderBy } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-storage.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA8KJmXXX5ax3QulbDFKpBI87v36OLcvK0",
            authDomain: "project-management-fafb7.firebaseapp.com",
            projectId: "project-management-fafb7",
            storageBucket: "project-management-fafb7.firebasestorage.app",
            messagingSenderId: "935346350562",
            appId: "1:935346350562:web:a475abd4099b5acbd3b1bb"
        };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const auth = getAuth(app);
    let currentUserUid = null;
    onAuthStateChanged(auth, user => { currentUserUid = user ? user.uid : null; });

        // --- Global State ---
        let currentMode = localStorage.getItem('currentMode') || 'personal';
        let currentDate = new Date();
        let monthRoutines = {};
        let monthListenerUnsubscribe = null;
        let selectedDateStr = null;
        let routineListenerUnsubscribe = null;
        let isInitialCalendarLoad = true;
    let boardColumns = [];
    let allTasks = [];
    let allNotes = [];
    // Trade-specific notes state (separate from hubs/<mode>/notes)
    let allTradeNotes = [];
    let tradeNoteFolders = [];
    let selectedTradeFolderId = null;
    let tradeNotesUnsub = null;
    let tradeFoldersUnsub = null;
    // note modal target: 'mode' uses currentMode's hubs/<mode>/notes; 'trade' uses hubs/trade/notes
    let noteModalTarget = 'mode';
    let listeners = [];
    let editingNoteId = null; // if set, note-modal is editing this note
    let editingTradeId = null; // id of trade being edited (if any)
    // notes are plain text now (no secret unlocking)
        const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        const dayNamesShort = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

        // --- UI Functions ---
        const showNotification = (message, isError = false) => {
            const notificationArea = document.getElementById('notification-area');
            notificationArea.innerHTML = '';
            const notification = document.createElement('div');
            notification.className = `relative p-4 rounded-lg shadow-lg text-white max-w-sm pointer-events-auto ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            
            const messageEl = document.createElement('p');
            messageEl.textContent = message;

            const closeBtn = document.createElement('button');
            closeBtn.className = 'absolute top-1 right-2 text-white font-bold';
            closeBtn.innerHTML = '&times;';
            closeBtn.onclick = () => {
                notificationArea.classList.add('hidden');
            };

            notification.appendChild(messageEl);
            notification.appendChild(closeBtn);
            notificationArea.appendChild(notification);
            
            notificationArea.classList.remove('hidden');

            setTimeout(() => {
                 notificationArea.classList.add('hidden');
            }, 1500);
        };

        const showConfirmModal = (text) => {
            return new Promise((resolve) => {
                const modal = document.getElementById('custom-confirm-modal');
                const modalText = document.getElementById('confirm-modal-text');
                const okBtn = document.getElementById('confirm-ok-btn');
                const cancelBtn = document.getElementById('confirm-cancel-btn');
                modalText.textContent = text;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                okBtn.onclick = () => { modal.classList.add('hidden'); modal.classList.remove('flex'); resolve(true); };
                cancelBtn.onclick = () => { modal.classList.add('hidden'); modal.classList.remove('flex'); resolve(false); };
            });
        };
        
        const formatTime = (timeStr) => {
            if (!timeStr) return '';
            const [hours, minutes] = timeStr.split(':');
            const h = parseInt(hours, 10);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const formattedHours = h % 12 || 12;
            return `${formattedHours}:${minutes} ${ampm}`;
        };

        // --- Notes Folders ---
        let noteFolders = [];
        let selectedFolderId = null;

        const renderFolders = () => {
            const folderList = document.getElementById('folder-list');
            folderList.innerHTML = '';
            // add an "All" pseudo-folder
            const allCount = allNotes.length || 0;
            const allBtn = document.createElement('button');
            allBtn.className = `folder-btn ${selectedFolderId === null ? 'active' : ''}`;
            allBtn.textContent = 'All';
            // badge
            const badgeAll = document.createElement('span'); badgeAll.className = 'ml-2 inline-flex items-center justify-center rounded-full bg-gray-200 text-sm px-2 py-0.5'; badgeAll.textContent = allCount;
            allBtn.appendChild(badgeAll);
            allBtn.onclick = () => { selectedFolderId = null; renderFolders(); renderNotes(); document.getElementById('notes-area').classList.remove('hidden'); document.getElementById('folders-bar').classList.add('hidden'); document.getElementById('current-folder-name').textContent = 'All'; const h = document.getElementById('header-add-note-btn'); if (h) h.classList.remove('hidden'); };
            // 'All' is a filter-only card â€” no add action appended
            folderList.appendChild(allBtn);

            noteFolders.forEach(f => {
                const btn = document.createElement('button');
                btn.className = `folder-btn ${selectedFolderId === f.id ? 'active' : ''}`;

                const titleWrap = document.createElement('div');
                titleWrap.className = 'folder-title';
                titleWrap.textContent = f.name;
                const count = allNotes.filter(n => n.folderId === f.id).length || 0;
                const badge = document.createElement('span'); badge.className = 'ml-2 inline-flex items-center justify-center rounded-full bg-gray-200 text-sm px-2 py-0.5'; badge.textContent = count;
                titleWrap.appendChild(badge);

                const actions = document.createElement('div');
                actions.className = 'folder-actions';
                // add note icon
                const addNoteIcon = document.createElement('i'); addNoteIcon.className = 'fas fa-plus-circle cursor-pointer text-green-600'; addNoteIcon.title = 'Add Note'; addNoteIcon.onclick = (e) => { e.stopPropagation(); openAddNoteForFolder(f.id, f.name); };
                const edit = document.createElement('i'); edit.className = 'fas fa-edit cursor-pointer text-gray-500'; edit.onclick = (e) => {
                    e.stopPropagation();
                    document.getElementById('folder-modal-title').textContent = 'Edit Folder';
                    document.getElementById('folder-id-input').value = f.id;
                    document.getElementById('folder-name-input').value = f.name;
                    const m = document.getElementById('folder-modal'); m.classList.remove('hidden'); m.classList.add('flex');
                };
                const del = document.createElement('i'); del.className = 'fas fa-trash-alt cursor-pointer text-red-500'; del.onclick = async (e) => {
                    e.stopPropagation();
                    const countHere = allNotes.filter(n => n.folderId === f.id).length || 0;
                    if (countHere > 0) {
                        showNotification('Folder contains notes and cannot be deleted.', true);
                        return;
                    }
                    const confirmed = await showConfirmModal('Delete folder? This cannot be undone.');
                    if (!confirmed) return;
                    try {
                        await deleteDoc(doc(db, 'hubs', currentMode, 'note_folders', f.id));
                    } catch (err) { showNotification('Failed to delete folder', true); }
                };

                actions.appendChild(addNoteIcon);
                actions.appendChild(edit);
                actions.appendChild(del);

                btn.appendChild(titleWrap);
                btn.appendChild(actions);

                btn.onclick = () => { selectedFolderId = f.id; renderFolders(); renderNotes(); document.getElementById('notes-area').classList.remove('hidden'); document.getElementById('folders-bar').classList.add('hidden'); document.getElementById('current-folder-name').textContent = f.name; const h = document.getElementById('header-add-note-btn'); if (h) h.classList.remove('hidden'); };

                folderList.appendChild(btn);
            });
        };

        // Helper: open note modal for specific folder
        const openAddNoteForFolder = (folderId, folderName) => {
            selectedFolderId = folderId;
            renderFolders();
            renderNotes();
            document.getElementById('notes-area').classList.remove('hidden');
            document.getElementById('folders-bar').classList.add('hidden');
            document.getElementById('current-folder-name').textContent = folderName || 'All';
            editingNoteId = null;
            document.getElementById('note-modal-title-input').value = '';
            document.getElementById('note-modal-input').value = '';
            document.getElementById('note-modal-title').textContent = 'Add Note';
            populateFolderSelect();
            // pre-select the folder
            document.getElementById('note-modal-folder-select').value = folderId || '';
            const m = document.getElementById('note-modal'); m.classList.remove('hidden'); m.classList.add('flex');
        };

        // Populate the select in the note modal with current folders
        const populateFolderSelect = () => {
            const sel = document.getElementById('note-modal-folder-select');
            if (!sel) return;
            const folders = (noteModalTarget === 'trade') ? tradeNoteFolders : noteFolders;
            sel.innerHTML = '<option value="">(None)</option>' + (folders || []).map(f => `<option value="${f.id}">${f.name}</option>`).join('');
        };

        // Render the project board columns and tasks
        const renderBoard = () => {
            const boardContainer = document.getElementById('board');
            if (!boardContainer) return;
            boardContainer.innerHTML = ''; // Clear existing columns

            boardColumns.forEach(column => {
                const columnEl = document.createElement('div');
                columnEl.className = 'kanban-column bg-gray-50 rounded-lg p-4';
                columnEl.dataset.columnId = column.id;

                const header = document.createElement('div');
                header.className = 'kanban-column-header flex justify-between items-center mb-4 border-b-2 pb-2';
                
                const title = document.createElement('h3');
                title.className = 'text-lg font-semibold text-gray-700 flex items-center gap-2';
                const titleText = document.createElement('span'); titleText.textContent = column.name;
                const taskCount = allTasks.filter(t => t.columnId === column.id).length || 0;
                const countBadge = document.createElement('span'); countBadge.className = 'ml-2 inline-flex items-center justify-center rounded-full bg-gray-200 text-sm px-2 py-0.5'; countBadge.textContent = taskCount;
                title.appendChild(titleText);
                title.appendChild(countBadge);

                const actions = document.createElement('div');
                actions.className = 'column-actions';
                
                const editBtn = document.createElement('i');
                editBtn.className = 'fas fa-edit cursor-pointer';
                editBtn.onclick = () => openColumnModal(column.id, column.name);

                const deleteBtn = document.createElement('i');
                deleteBtn.className = 'fas fa-trash-alt delete-btn cursor-pointer';
                deleteBtn.onclick = () => deleteColumn(column.id);

                actions.appendChild(editBtn);
                actions.appendChild(deleteBtn);
                header.appendChild(title);
                header.appendChild(actions);

                const taskList = document.createElement('div');
                taskList.className = 'task-list min-h-[200px] space-y-3 p-1';
                
                // sort tasks by explicit order (if present) so reorder persists
                const tasksForColumn = allTasks.filter(task => task.columnId === column.id).sort((a,b) => (a.order || 0) - (b.order || 0));
                tasksForColumn.forEach(task => {
                    const taskCard = createTaskElement(task);
                    taskList.appendChild(taskCard);
                });

                // After appending tasks, if the content overflows, add a class to show the gradient hint
                // Use a small timeout to ensure layout measurements are accurate
                setTimeout(() => {
                    if (taskList.scrollHeight > taskList.clientHeight) {
                        taskList.classList.add('is-scrollable');
                    } else {
                        taskList.classList.remove('is-scrollable');
                    }
                }, 20);

                // Enable dragging to reorder inside this column
                taskList.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(taskList, e.clientY);
                    const draggingEl = document.querySelector('.dragging');
                    if (!draggingEl) return;
                    if (afterElement == null) taskList.appendChild(draggingEl);
                    else taskList.insertBefore(draggingEl, afterElement);
                });

                taskList.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    const taskId = e.dataTransfer.getData('text/plain') || (document.querySelector('.dragging') ? document.querySelector('.dragging').dataset.id : null);
                    if (!taskId) return;
                    const targetColumnId = column.id;

                    // compute new order for tasks in target column from DOM
                    const children = Array.from(taskList.querySelectorAll('.task-card'));
                    const updates = children.map((child, idx) => ({ id: child.dataset.id, order: idx + 1 }));

                    // update tasks in this column
                    const batch = writeBatch(db);
                    updates.forEach(u => {
                        batch.update(doc(db, 'hubs', currentMode, 'tasks', u.id), { order: u.order, columnId: targetColumnId });
                    });

                    // If source column was different, also recompute orders for source column
                    const srcColumnId = window._dragSrcColumnId || null;
                    if (srcColumnId && srcColumnId !== targetColumnId) {
                        const srcColumnEl = document.querySelector(`.kanban-column[data-column-id="${srcColumnId}"]`);
                        if (srcColumnEl) {
                            const srcTaskList = srcColumnEl.querySelector('.task-list');
                            if (srcTaskList) {
                                const srcChildren = Array.from(srcTaskList.querySelectorAll('.task-card'));
                                srcChildren.forEach((child, idx) => {
                                    batch.update(doc(db, 'hubs', currentMode, 'tasks', child.dataset.id), { order: idx + 1, columnId: srcColumnId });
                                });
                            }
                        }
                    }

                    try {
                        await batch.commit();
                    } catch (err) {
                        console.error('Failed to update task order:', err);
                        showNotification('Failed to reorder tasks.', true);
                    }
                });

                columnEl.appendChild(header);
                columnEl.appendChild(taskList);
                boardContainer.appendChild(columnEl);
            });

            const addColumnButton = document.createElement('button');
            addColumnButton.className = 'kanban-column bg-gray-100 rounded-lg p-4 flex items-center justify-center text-gray-500 hover:bg-gray-200 hover:text-gray-700 transition-colors';
            addColumnButton.innerHTML = '<i class="fas fa-plus mr-2"></i> Add New Column';
            addColumnButton.onclick = () => openColumnModal();
            boardContainer.appendChild(addColumnButton);
        };

        const createTaskElement = (task) => {
            const taskCard = document.createElement('div');
            taskCard.className = 'task-card bg-white p-3 rounded-lg shadow-sm cursor-grab active:cursor-grabbing border-l-4 border-gray-300 hover:border-blue-500';
            taskCard.draggable = true;
            taskCard.dataset.id = task.id;
            const taskContent = document.createElement('div');
            taskContent.className = 'task-content';
            // Note: thumbnails are intentionally not shown in the task list; images are visible only in the task detail modal

            const titleSpan = document.createElement('span');
            titleSpan.textContent = task.text || '';
            // show full title on card and allow wrapping
            titleSpan.className = 'task-text';
            titleSpan.style.display = 'block';
            titleSpan.style.whiteSpace = 'normal';
            titleSpan.style.overflow = 'visible';
            taskContent.appendChild(titleSpan);
            taskCard.appendChild(taskContent);
            // open detail modal on click (ignore if currently dragging)
            taskCard.addEventListener('click', (e) => {
                if (document.querySelector('.dragging')) return;
                openTaskDetailModal(task.id);
            });
            addDragEventsToTask(taskCard);
            // after layout, if content overflows, show toggle
            setTimeout(() => {
                // nothing for title-only view
            }, 10);
            return taskCard;
        };
        const editTask = (id, taskCard, taskTextSpan) => {
            const currentText = taskTextSpan.textContent;
            const textarea = document.createElement('textarea');
            textarea.value = currentText;
            textarea.className = 'w-full p-2 border rounded resize-none';
            textarea.style.minHeight = '64px';

            const parent = taskTextSpan.parentElement || taskCard;
            parent.replaceChild(textarea, taskTextSpan);
            textarea.focus();

            const autosize = () => { textarea.style.height = 'auto'; textarea.style.height = textarea.scrollHeight + 'px'; };
            autosize();
            textarea.addEventListener('input', autosize);

            const controls = document.createElement('div');
            controls.className = 'flex gap-2 justify-end mt-2';
            const saveBtn = document.createElement('button'); saveBtn.className = 'px-3 py-1 bg-blue-600 text-white rounded'; saveBtn.textContent = 'Save';
            const cancelBtn = document.createElement('button'); cancelBtn.className = 'px-3 py-1 bg-gray-200 rounded'; cancelBtn.textContent = 'Cancel';
            controls.appendChild(cancelBtn); controls.appendChild(saveBtn);
            parent.appendChild(controls);

            const finish = async (save) => {
                if (save) {
                    const newText = textarea.value.trim();
                    if (newText && newText !== currentText) {
                        try { await updateDoc(doc(db, "hubs", currentMode, "tasks", id), { text: newText }); } catch (e) { showNotification('Failed to save task.', true); }
                    }
                }
                // cleanup and restore view
                if (controls.parentElement) controls.parentElement.removeChild(controls);
                parent.replaceChild(taskTextSpan, textarea);
                taskTextSpan.textContent = save ? textarea.value : currentText;
            };

            cancelBtn.addEventListener('click', (e) => { e.preventDefault(); finish(false); });
            saveBtn.addEventListener('click', async (e) => { e.preventDefault(); await finish(true); });
            textarea.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') { e.preventDefault(); finish(false); }
            });
        };
        // --- Task Detail Modal Handlers ---
        const openTaskDetailModal = (taskId) => {
            const modal = document.getElementById('task-detail-modal');
            const idInput = document.getElementById('task-detail-id');
            const titleInput = document.getElementById('task-detail-title-input');
            const descInput = document.getElementById('task-detail-desc-input');

            const taskObj = allTasks.find(t => t.id === taskId) || { id: taskId, text: '' };
            idInput.value = taskObj.id;
            titleInput.value = taskObj.text || '';
            descInput.value = taskObj.description || '';
            // meta: time and createdAt
            const metaEl = document.getElementById('task-meta');
            const created = taskObj.createdAt ? new Date(taskObj.createdAt).toLocaleString() : '';
            const updated = taskObj.updatedAt ? new Date(taskObj.updatedAt).toLocaleString() : '';
            const timeStr = taskObj.time ? formatTime(taskObj.time) : '';
            const parts = [];
            if (timeStr) parts.push(`Time: ${timeStr}`);
            if (created) parts.push(`Created: ${created}`);
            if (updated) parts.push(`Updated: ${updated}`);
            metaEl.innerHTML = parts.map(p => `<div>${p}</div>`).join('');
            // render saved thumbnails
            renderTaskThumbnails(taskObj);
            // set filename display and remove button based on existing images
            const detailFn = document.getElementById('task-detail-image-filename');
            const removeBtn = document.getElementById('task-detail-remove-image-btn');
            const paths = taskObj.imagePath ? (Array.isArray(taskObj.imagePath) ? taskObj.imagePath : [taskObj.imagePath]) : [];
            if (paths.length) {
                const firstName = (paths[0].split('/').pop() || 'image');
                const display = firstName.length > 24 ? firstName.slice(0,20) + 'â€¦' : firstName;
                if (detailFn) detailFn.textContent = paths.length > 1 ? `${display} (+${paths.length-1})` : display;
                if (removeBtn) { removeBtn.classList.remove('hidden'); removeBtn.dataset.remove = 'false'; }
            } else {
                if (detailFn) detailFn.textContent = '';
                if (removeBtn) { removeBtn.classList.add('hidden'); removeBtn.dataset.remove = 'false'; }
            }
            modal.classList.remove('hidden'); modal.classList.add('flex');
        };

        // Render thumbnails for saved images in task detail modal (supports multiple images)
        const renderTaskThumbnails = (task) => {
            const thumbsContainer = document.getElementById('task-detail-thumbs');
            if (!thumbsContainer) return;
            thumbsContainer.innerHTML = '';
            const urls = task && task.imageUrl ? (Array.isArray(task.imageUrl) ? task.imageUrl : [task.imageUrl]) : [];
            const paths = task && task.imagePath ? (Array.isArray(task.imagePath) ? task.imagePath : [task.imagePath]) : [];
            urls.forEach((url, idx) => {
                const wrap = document.createElement('div'); wrap.className = 'relative';
                const img = document.createElement('img');
                img.src = url;
                img.alt = 'thumb';
                img.className = 'rounded cursor-pointer border p-0.5';
                img.style.width = '72px';
                img.style.height = '72px';
                img.style.objectFit = 'cover';
                img.addEventListener('click', () => {
                    const pm = document.getElementById('image-preview-modal');
                    const pmImg = document.getElementById('image-preview-img');
                    if (pm && pmImg) {
                        pmImg.src = url;
                        pm.classList.remove('hidden'); pm.classList.add('flex');
                        try { bringPreviewToFront(); } catch (err) { pm.style.zIndex = '99999'; }
                    }
                });
                // delete icon
                const delBtn = document.createElement('button');
                delBtn.className = 'absolute -top-2 -right-2 bg-white rounded-full p-1 shadow text-red-600';
                delBtn.title = 'Delete image';
                delBtn.innerHTML = '<i class="fas fa-trash"></i>';
                delBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const confirmed = await showConfirmModal('Delete this image?');
                    if (!confirmed) return;
                    const tId = task && task.id ? task.id : document.getElementById('task-detail-id').value;
                    const pathToDelete = paths[idx] || null;
                    if (pathToDelete) {
                        await deleteTaskImage(pathToDelete).catch(() => {});
                        // update firestore: remove the path and url from arrays
                        const newPaths = paths.filter((p, i) => i !== idx);
                        const newUrls = urls.filter((u, i) => i !== idx);
                        await updateDoc(doc(db, 'hubs', currentMode, 'tasks', tId), { imagePath: newPaths.length ? newPaths : null, imageUrl: newUrls.length ? newUrls : null });
                        // refresh local and UI
                        const t = allTasks.find(x=>x.id===tId) || {};
                        t.imagePath = newPaths.length ? newPaths : null; t.imageUrl = newUrls.length ? newUrls : null;
                        renderTaskThumbnails(t);
                        showNotification('Image deleted.');
                    }
                });
                wrap.appendChild(img);
                wrap.appendChild(delBtn);
                thumbsContainer.appendChild(wrap);
            });
        };

    document.getElementById('task-cancel-btn').addEventListener('click', () => { const m = document.getElementById('task-detail-modal'); m.classList.add('hidden'); m.classList.remove('flex'); const fn = document.getElementById('task-detail-image-filename'); if (fn) fn.textContent = ''; const preview = document.getElementById('task-detail-image-preview'); const input = document.getElementById('task-detail-image-input'); const removeBtn = document.getElementById('task-detail-remove-image-btn'); if (preview) { preview.src = ''; preview.classList.add('hidden'); } if (input) input.value = ''; if (removeBtn) removeBtn.classList.add('hidden'); });

        document.getElementById('task-delete-btn').addEventListener('click', async () => {
            const id = document.getElementById('task-detail-id').value;
            // use centralized deleteTask so images are removed too
            await deleteTask(id);
            const m = document.getElementById('task-detail-modal'); if (m) { m.classList.add('hidden'); m.classList.remove('flex'); }
        });

        document.getElementById('task-detail-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('task-detail-id').value;
            const title = document.getElementById('task-detail-title-input').value.trim();
            const desc = document.getElementById('task-detail-desc-input').value.trim();
            if (!title) { showNotification('Title cannot be empty.', true); return; }
            try {
                const taskRef = doc(db, 'hubs', currentMode, 'tasks', id);
                const updates = { text: title, description: desc, updatedAt: Date.now() };
                const existing = allTasks.find(t => t.id === id) || {};
                const fileInput = document.getElementById('task-detail-image-input');
                const removeBtn = document.getElementById('task-detail-remove-image-btn');
                const files = fileInput && fileInput.files && fileInput.files.length ? Array.from(fileInput.files) : [];
                // existing arrays
                const existingPaths = existing.imagePath ? (Array.isArray(existing.imagePath) ? existing.imagePath.slice() : [existing.imagePath]) : [];
                const existingUrls = existing.imageUrl ? (Array.isArray(existing.imageUrl) ? existing.imageUrl.slice() : [existing.imageUrl]) : [];
                if (files.length > 0) {
                    // upload new files and append to arrays
                    const uploadResults = await uploadTaskImages(id, files);
                    const newPaths = uploadResults.filter(r=>r).map(r=>r.path);
                    const newUrls = uploadResults.filter(r=>r).map(r=>r.url);
                    const mergedPaths = existingPaths.concat(newPaths);
                    const mergedUrls = existingUrls.concat(newUrls);
                    updates.imagePath = mergedPaths.length ? mergedPaths : null;
                    updates.imageUrl = mergedUrls.length ? mergedUrls : null;
                } else if (removeBtn && removeBtn.dataset.remove === 'true') {
                    // remove all existing images
                    for (const p of existingPaths) { await deleteTaskImage(p).catch(()=>{}); }
                    updates.imagePath = null; updates.imageUrl = null;
                }
                await updateDoc(taskRef, updates);
                showNotification('Task updated.');
                const m = document.getElementById('task-detail-modal'); m.classList.add('hidden'); m.classList.remove('flex');
            } catch (e) { console.error(e); showNotification('Failed to update task.', true); }
        });
    const addTask = async (text, description = '', file = null) => {
            if (boardColumns.length === 0) {
                showNotification("Please add a column first before adding tasks.", true);
                return;
            }
            try {
                // Insert new task at the top: set order = 1 and increment existing tasks' order in the column
                const colId = boardColumns[0].id;
                // prepare a batch to bump existing tasks' order by +1
                const batch = writeBatch(db);
                               const tasksForColumn = allTasks.filter(t => t.columnId === colId).sort((a,b) => (a.order || 0) - (b.order || 0));
                tasksForColumn.forEach(t => {
                    const ref = doc(db, 'hubs', currentMode, 'tasks', t.id);
                    batch.update(ref, { order: (t.order || 0) + 1 });
                });

                // commit the bump first so new task can be inserted at order=1
                await batch.commit();

                // add the new task with order 1
                const docRef = await addDoc(collection(db, "hubs", currentMode, "tasks"), { text, description: description || null, columnId: colId, order: 1, createdAt: Date.now(), updatedAt: Date.now() });
                // if files provided, upload each and attach arrays of paths/urls
                if (file && file.length && file.length > 0) {
                    try {
                        const uploadResults = await uploadTaskImages(docRef.id, Array.from(file));
                        const paths = uploadResults.filter(r=>r).map(r=>r.path);
                        const urls = uploadResults.filter(r=>r).map(r=>r.url);
                        await updateDoc(doc(db, 'hubs', currentMode, 'tasks', docRef.id), { imagePath: paths, imageUrl: urls });
                    } catch (err) { console.warn('Image upload for new task failed', err); }
                }
            } catch (e) { console.error(e); showNotification('Failed to add task.', true); }
        };
        const deleteTask = async (taskId) => {
            const confirmed = await showConfirmModal('Are you sure you want to delete this task?');
            if (confirmed) {
                try {
                    const taskDocSnap = await getDoc(doc(db, 'hubs', currentMode, 'tasks', taskId));
                    let imagePaths = [];
                    if (taskDocSnap && taskDocSnap.exists()) {
                        const data = taskDocSnap.data();
                        if (Array.isArray(data.imagePath)) imagePaths = data.imagePath; else if (data.imagePath) imagePaths = [data.imagePath];
                    }
                    // delete all associated images
                    for (const p of imagePaths) { await deleteTaskImage(p).catch(()=>{}); }
                    await deleteDoc(doc(db, "hubs", currentMode, "tasks", taskId));
                    showNotification('Task deleted successfully.');
                } catch (e) { showNotification('Failed to delete task.', true); }
            }
        };

        // --- Image helpers ---
        const uploadTaskImage = async (taskId, file) => {
            try {
                const MAX_DIM = 1600;
                const blob = await resizeImageFile(file, MAX_DIM, MAX_DIM, 0.8);
                const path = `tasks/${taskId}/${Date.now()}_${file.name.replace(/[^a-zA-Z0-9._-]/g, '_')}`;
                const ref = storageRef(storage, path);
                await uploadBytes(ref, blob);
                const url = await getDownloadURL(ref);
                return { path, url };
            } catch (err) { console.error('uploadTaskImage failed', err); return null; }
        };

        // upload an array of files for a task and return array of {path,url}
        const uploadTaskImages = async (taskId, files) => {
            const results = [];
            for (const f of files) {
                try {
                    const r = await uploadTaskImage(taskId, f);
                    results.push(r);
                } catch (err) { console.warn('uploadTaskImages entry failed', err); results.push(null); }
            }
            return results;
        };

        const deleteTaskImage = async (path) => {
            try { if (!path) return; const ref = storageRef(storage, path); await deleteObject(ref); } catch (err) { console.warn('deleteTaskImage failed', err); }
        };

        const resizeImageFile = (file, maxWidth = 1600, maxHeight = 1600, quality = 0.8) => {
            return new Promise(async (resolve) => {
                try {
                    const ib = await createImageBitmap(file);
                    const ratio = Math.min(maxWidth / ib.width, maxHeight / ib.height, 1);
                    const w = Math.round(ib.width * ratio);
                    const h = Math.round(ib.height * ratio);
                    const canvas = document.createElement('canvas');
                    canvas.width = w; canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(ib, 0, 0, w, h);
                    ib.close();
                    canvas.toBlob((blob) => { resolve(blob || file); }, 'image/jpeg', quality);
                } catch (err) { console.warn('resize failed', err); resolve(file); }
            });
        };

        // preview handlers
        const addTaskImageInput = document.getElementById('add-task-image-input');
        const addTaskImagePreview = document.getElementById('add-task-image-preview');
        if (addTaskImageInput) {
            addTaskImageInput.addEventListener('change', (e) => {
                const files = e.target.files ? Array.from(e.target.files) : [];
                const fn = document.getElementById('add-task-image-filename');
                if (!files.length) { if (addTaskImagePreview) { addTaskImagePreview.src = ''; addTaskImagePreview.classList.add('hidden'); } if (fn) fn.textContent = ''; return; }
                // show a small count and first filename shortened
                if (fn) {
                    const first = files[0].name;
                    const display = first.length > 24 ? first.slice(0,20) + 'â€¦' : first;
                    fn.textContent = files.length > 1 ? `${display} (+${files.length-1})` : display;
                }
                // show first preview
                const url = URL.createObjectURL(files[0]);
                if (addTaskImagePreview) { addTaskImagePreview.src = url; addTaskImagePreview.classList.remove('hidden'); }
            });
        }

        const detailImageInput = document.getElementById('task-detail-image-input');
        const detailImagePreview = document.getElementById('task-detail-image-preview');
        const detailRemoveBtn = document.getElementById('task-detail-remove-image-btn');
        if (detailImageInput) {
            detailImageInput.addEventListener('change', (e) => {
                const files = e.target.files ? Array.from(e.target.files) : [];
                const fn = document.getElementById('task-detail-image-filename');
                if (!files.length) { if (detailImagePreview) { detailImagePreview.src = ''; detailImagePreview.classList.add('hidden'); } if (fn) fn.textContent = ''; return; }
                const first = files[0];
                const url = URL.createObjectURL(first);
                if (detailImagePreview) { detailImagePreview.src = url; detailImagePreview.classList.remove('hidden'); }
                if (detailRemoveBtn) { detailRemoveBtn.dataset.remove = 'false'; detailRemoveBtn.classList.remove('hidden'); }
                if (fn) { const display = first.name.length > 24 ? first.name.slice(0,20) + 'â€¦' : first.name; fn.textContent = files.length > 1 ? `${display} (+${files.length-1})` : display; }
            });
        }
        if (detailRemoveBtn) {
            detailRemoveBtn.addEventListener('click', () => {
                detailRemoveBtn.dataset.remove = 'true';
                if (detailImagePreview) { detailImagePreview.src = ''; detailImagePreview.classList.add('hidden'); }
                if (detailImageInput) { detailImageInput.value = ''; }
            });
        }

        const openColumnModal = (id = null, name = '') => {
            const modal = document.getElementById('column-modal');
            document.getElementById('column-modal-title').textContent = id ? 'Edit Column' : 'Add New Column';
            document.getElementById('column-id-input').value = id || '';
            document.getElementById('column-name-input').value = name;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        // Preview modal close handler
        const imagePreviewModal = document.getElementById('image-preview-modal');
        const imagePreviewClose = document.getElementById('image-preview-close');
        if (imagePreviewClose && imagePreviewModal) {
            imagePreviewClose.addEventListener('click', () => {
                imagePreviewModal.classList.add('hidden'); imagePreviewModal.classList.remove('flex');
                // clear inline z-index style if set
                imagePreviewModal.style.zIndex = '';
            });
        }

        // Ensure when opening preview via thumbnails we bring it to front
        const bringPreviewToFront = () => {
            if (!imagePreviewModal) return;
            // use very high z-index to ensure it's above other modals
            imagePreviewModal.style.zIndex = '99999';
        };

        const closeColumnModal = () => {
            const m = document.getElementById('column-modal'); m.classList.add('hidden'); m.classList.remove('flex');
        };

        const saveColumn = async (id, name) => {
            if (!name || name.trim() === "") return;
            if (id) {
                await updateDoc(doc(db, "hubs", currentMode, "board_columns", id), { name: name.trim() });
            } else {
                const order = boardColumns.length > 0 ? Math.max(...boardColumns.map(c => c.order)) + 1 : 1;
                await addDoc(collection(db, "hubs", currentMode, "board_columns"), { name: name.trim(), order });
            }
            closeColumnModal();
        };

        const deleteColumn = async (columnId) => {
            const confirmed = await showConfirmModal('Are you sure you want to delete this column and all its tasks? This action cannot be undone.');
            if (confirmed) {
                try {
                    const batch = writeBatch(db);
                    const tasksToDeleteQuery = query(collection(db, "hubs", currentMode, "tasks"), where("columnId", "==", columnId));
                    const tasksSnapshot = await getDocs(tasksToDeleteQuery);
                    tasksSnapshot.forEach(taskDoc => {
                        batch.delete(doc(db, "hubs", currentMode, "tasks", taskDoc.id));
                    });
                    batch.delete(doc(db, "hubs", currentMode, "board_columns", columnId));
                    await batch.commit();
                    showNotification('Column and its tasks deleted successfully.');
                } catch (e) {
                    showNotification('Failed to delete column.', true);
                }
            }
        };

        // --- Daily Routine Calendar Functions ---
        const renderCalendar = () => {
            const calendarGrid = document.getElementById('calendar-grid');
            const monthYearHeader = document.getElementById('month-year-header');
            const weekdaysHeader = document.getElementById('calendar-weekdays');
            calendarGrid.innerHTML = '';
            weekdaysHeader.innerHTML = '';
            
            const isMobile = window.innerWidth < 768;
            const currentDayNames = isMobile ? dayNamesShort : dayNames;
            currentDayNames.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.textContent = day;
                weekdaysHeader.appendChild(dayEl);
            });

            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            
            monthYearHeader.textContent = `${currentDate.toLocaleString('en-US', { month: 'long' })} ${year}`;
            
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            fetchMonthRoutines(year, month);

            for (let i = 0; i < firstDayOfMonth; i++) {
                calendarGrid.appendChild(document.createElement('div'));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day border rounded';
                dayCell.dataset.date = dateStr;
                
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header';

                const dayInfo = document.createElement('div');
                dayInfo.className = 'day-info';

                const dayNumber = document.createElement('span');
                dayNumber.className = 'day-number text-sm';
                dayNumber.textContent = day;

                const dayName = document.createElement('span');
                dayName.className = 'day-name';
                dayName.textContent = dayNamesShort[date.getDay()];
                
                dayInfo.appendChild(dayNumber);
                dayInfo.appendChild(dayName);
                
                const addBtn = document.createElement('i');
                addBtn.className = 'fas fa-plus add-routine-btn text-xs';
                addBtn.onclick = (e) => { e.stopPropagation(); openRoutineModal(dateStr); };

                dayHeader.appendChild(dayInfo);
                dayHeader.appendChild(addBtn);
                
                const todayStr = new Date().toISOString().slice(0, 10);
                if (dateStr === todayStr) dayCell.classList.add('today');
                
                if (date.getDay() === 0 || date.getDay() === 6) {
                    dayCell.classList.add('weekend-day');
                }

                const routineList = document.createElement('div');
                routineList.className = 'day-routine-list';
                routineList.id = `routines-${dateStr}`;

                dayCell.appendChild(dayHeader);
                dayCell.appendChild(routineList);
                
                dayCell.addEventListener('click', () => handleDayClick(dateStr, dayCell));
                calendarGrid.appendChild(dayCell);
            }
        };
        
        const handleDayClick = (dateStr, dayCell) => {
             if (window.innerWidth >= 768) return;
             
             const prevSelected = document.querySelector('.selected-day');
             if(prevSelected) prevSelected.classList.remove('selected-day');

             dayCell.classList.add('selected-day');
             
             renderMobileRoutines(dateStr);
        };

        const fetchMonthRoutines = (year, month) => {
            if (monthListenerUnsubscribe) monthListenerUnsubscribe();
            const startDate = `${year}-${String(month + 1).padStart(2, '0')}-01`;
            const endDate = `${year}-${String(month + 2).padStart(2, '0')}-01`;
            const q = query(collection(db, "hubs", currentMode, "daily_routines"), where("date", ">=", startDate), where("date", "<", endDate));
            
            monthListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                monthRoutines = {};
                snapshot.docs.forEach(doc => {
                    const routine = { id: doc.id, ...doc.data() };
                    if (!monthRoutines[routine.date]) monthRoutines[routine.date] = [];
                    monthRoutines[routine.date].push(routine);
                });
                updateRoutineDisplay();

                if (isInitialCalendarLoad && window.innerWidth < 768) {
                    const todayStr = new Date().toISOString().slice(0, 10);
                    const todayCell = document.querySelector(`.calendar-day[data-date="${todayStr}"]`);
                    if (todayCell) {
                        handleDayClick(todayStr, todayCell);
                    }
                    isInitialCalendarLoad = false;
                }
            });
        };

        const updateRoutineDisplay = () => {
            document.querySelectorAll('.day-routine-list').forEach(list => list.innerHTML = '');
            for (const dateStr in monthRoutines) {
                const listEl = document.getElementById(`routines-${dateStr}`);
                if (listEl) {
                    monthRoutines[dateStr].sort((a, b) => (a.time || '').localeCompare(b.time || ''));
                    monthRoutines[dateStr].forEach(routine => {
                        const item = createDayRoutineElement(routine);
                        listEl.appendChild(item);
                    });
                }
            }
        };

        const createDayRoutineElement = (routine) => {
            const item = document.createElement('div');
            item.className = `day-routine-item ${routine.completed ? 'completed' : ''}`;
            item.title = `${routine.text}${routine.time ? ' at ' + formatTime(routine.time) : ''}`;

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = routine.completed;
            checkbox.className = 'form-checkbox h-3 w-3 text-indigo-600 rounded-sm mr-1 focus:ring-0 flex-shrink-0';
            checkbox.onchange = () => updateRoutineStatus(routine.id, checkbox.checked);
            
            const textSpan = document.createElement('span');
            textSpan.textContent = `${routine.text} ${formatTime(routine.time)}`;
            textSpan.className = 'truncate';

            item.appendChild(checkbox);
            item.appendChild(textSpan);
            return item;
        };

        const openRoutineModal = (dateStr) => {
            selectedDateStr = dateStr;
            const modal = document.getElementById('routine-modal');
            const modalDateHeader = document.getElementById('routine-modal-date');
            const date = new Date(dateStr + 'T00:00:00');
            modalDateHeader.textContent = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            if (routineListenerUnsubscribe) routineListenerUnsubscribe();
            const q = query(collection(db, "hubs", currentMode, "daily_routines"), where("date", "==", dateStr));
            routineListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                renderModalRoutines(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            });
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        const closeRoutineModal = () => {
            const m = document.getElementById('routine-modal'); m.classList.add('hidden'); m.classList.remove('flex');
            if (routineListenerUnsubscribe) { routineListenerUnsubscribe(); routineListenerUnsubscribe = null; }
            selectedDateStr = null;
        };
        
        const openEditRoutineModal = (routine) => {
            const modal = document.getElementById('edit-routine-modal');
            document.getElementById('edit-routine-id').value = routine.id;
            document.getElementById('edit-routine-input').value = routine.text;
            document.getElementById('edit-routine-time-input').value = routine.time;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        const closeEditRoutineModal = () => {
            const m = document.getElementById('edit-routine-modal'); m.classList.add('hidden'); m.classList.remove('flex');
        };

        const renderModalRoutines = (routines) => {
            const listEl = document.getElementById('modal-routine-list');
            listEl.innerHTML = '';
            routines.sort((a, b) => (a.time || '').localeCompare(b.time || ''));
            routines.forEach(routine => {
                const item = document.createElement('div');
                item.className = `routine-item p-3 rounded-lg bg-gray-50 hover:bg-gray-100`;
                
                const mainContent = document.createElement('div');
                mainContent.className = 'flex items-center flex-grow';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = routine.completed;
                checkbox.className = 'form-checkbox h-5 w-5 text-indigo-600 rounded mr-3 focus:ring-0';
                checkbox.onchange = () => updateRoutineStatus(routine.id, checkbox.checked);
                const textSpan = document.createElement('span');
                const timeDisplay = routine.time ? `<strong class="mr-2">${formatTime(routine.time)}</strong>` : '';
                textSpan.innerHTML = `${timeDisplay} <span class="${routine.completed ? 'completed' : ''}">${routine.text}</span>`;
                mainContent.appendChild(checkbox);
                mainContent.appendChild(textSpan);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'task-actions';
                const editButton = document.createElement('i');
                editButton.className = 'fas fa-edit';
                editButton.onclick = () => openEditRoutineModal(routine);
                const deleteButton = document.createElement('i');
                deleteButton.className = 'fas fa-trash-alt delete-btn';
                deleteButton.onclick = () => deleteRoutine(routine.id);
                actionsDiv.appendChild(editButton);
                actionsDiv.appendChild(deleteButton);

                item.appendChild(mainContent);
                item.appendChild(actionsDiv);
                listEl.appendChild(item);
            });
        };
        
        const renderMobileRoutines = (dateStr) => {
            const container = document.getElementById('mobile-routine-list');
            container.innerHTML = '';
            const formList = document.getElementById('trade-form-rules-list'); if (formList) formList.innerHTML = '';
            
            const routines = monthRoutines[dateStr] || [];
            
            if (routines.length === 0) {
                 container.innerHTML = `<p class="text-gray-500">No routines for this day. <a href="#" class="text-indigo-600" onclick="event.preventDefault(); openRoutineModal('${dateStr}')">Add one?</a></p>`;
                 return;
            }

            routines.sort((a, b) => (a.time || '').localeCompare(b.time || ''));
            routines.forEach(routine => {
                const item = document.createElement('div');
                item.className = `routine-item p-3 rounded-lg bg-white`;
                
                const mainContent = document.createElement('div');
                mainContent.className = 'flex items-center flex-grow';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = routine.completed;
                checkbox.className = 'form-checkbox h-5 w-5 text-indigo-600 rounded mr-3 focus:ring-0';
                checkbox.onchange = () => updateRoutineStatus(routine.id, checkbox.checked);
                const textSpan = document.createElement('span');
                const timeDisplay = routine.time ? `<strong class="mr-2">${formatTime(routine.time)}</strong>` : '';
                textSpan.innerHTML = `${timeDisplay} <span class="${routine.completed ? 'completed' : ''}">${routine.text}</span>`;
                mainContent.appendChild(checkbox);
                mainContent.appendChild(textSpan);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'task-actions';
                const editButton = document.createElement('i');
                editButton.className = 'fas fa-edit';
                editButton.onclick = () => openEditRoutineModal(routine);
                const deleteButton = document.createElement('i');
                deleteButton.className = 'fas fa-trash-alt delete-btn';
                deleteButton.onclick = () => deleteRoutine(routine.id);
                actionsDiv.appendChild(editButton);
                actionsDiv.appendChild(deleteButton);

                item.appendChild(mainContent);
                item.appendChild(actionsDiv);
                container.appendChild(item);
            });
        };

        const addRoutine = async (text, time, dateStr) => {
            try {
                await addDoc(collection(db, "hubs", currentMode, "daily_routines"), { text, time, completed: false, date: dateStr });
            } catch (e) {
                console.error("Error adding routine: ", e);
                showNotification('Failed to add routine.', true);
            }
        };

        const updateRoutine = async (id, text, time) => {
            try {
                await updateDoc(doc(db, "hubs", currentMode, "daily_routines", id), { text, time });
                showNotification('Routine updated successfully.');
            } catch (e) {
                showNotification('Failed to edit routine.', true);
            }
        };

        const updateRoutineStatus = async (id, completed) => {
            try {
                await updateDoc(doc(db, "hubs", currentMode, "daily_routines", id), { completed });
            } catch (e) {
                showNotification('Failed to update routine status.', true);
            }
        };

        const deleteRoutine = async (id) => {
            const confirmed = await showConfirmModal('Are you sure you want to delete this routine task?');
            if (confirmed) {
                try {
                    await deleteDoc(doc(db, "hubs", currentMode, "daily_routines", id));
                } catch (e) {
                    showNotification('Failed to delete routine.', true);
                }
            }
        };

        // Helper: compute date strings for given selection
        const getDatesForSelection = (mode, selectedWeekdays = []) => {
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const dates = [];
            if (mode === 'month') {
                for (let day = 1; day <= daysInMonth; day++) {
                    dates.push(`${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`);
                }
                return dates;
            }
            if (mode === 'weekdays') {
                selectedWeekdays = [1,2,3,4,5];
            } else if (mode === 'weekends') {
                selectedWeekdays = [6,0];
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const loopDate = new Date(year, month, day);
                if (selectedWeekdays.includes(loopDate.getDay())) {
                    dates.push(`${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`);
                }
            }
            return dates;
        };

        const addRoutinesForDates = async (text, time, dateArray) => {
            const promises = dateArray.map(d => addRoutine(text, time, d));
            try {
                await Promise.all(promises);
                showNotification(`Successfully added "${text}" to ${dateArray.length} date(s) this month.`);
            } catch (e) {
                showNotification('An error occurred while adding recurring routines.', true);
            }
        };

        // --- Important Notes Functions ---
        const renderNotes = () => {
            const notesList = document.getElementById('notes-list');
            if (!notesList) return;
            notesList.innerHTML = '';
            const filtered = selectedFolderId ? allNotes.filter(n => n.folderId === selectedFolderId) : allNotes;
            filtered.forEach(note => {
                const noteItem = createNoteElement(note, 'mode');
                notesList.appendChild(noteItem);
            });
            try { renderTradeNotes(); } catch(e) {}
        };

        // Trade notes are separate from mode notes. Render trade-specific folders & notes into trade panel.
        const renderTradeFolders = () => {
            const folderList = document.getElementById('trade-folder-list');
            if (!folderList) return;
            folderList.innerHTML = '';
            const allCount = allTradeNotes.length || 0;
            const allBtn = document.createElement('button');
            allBtn.className = `folder-btn ${selectedTradeFolderId === null ? 'active' : ''}`;
            allBtn.textContent = 'All';
            const badgeAll = document.createElement('span'); badgeAll.className = 'ml-2 inline-flex items-center justify-center rounded-full bg-gray-200 text-sm px-2 py-0.5'; badgeAll.textContent = allCount;
            allBtn.appendChild(badgeAll);
            allBtn.onclick = () => { selectedTradeFolderId = null; renderTradeFolders(); renderTradeNotes(); document.getElementById('trade-notes-area')?.classList.remove('hidden'); };
            folderList.appendChild(allBtn);
            tradeNoteFolders.forEach(f => {
                const btn = document.createElement('button');
                btn.className = `folder-btn ${selectedTradeFolderId === f.id ? 'active' : ''}`;
                const titleWrap = document.createElement('div'); titleWrap.className = 'folder-title'; titleWrap.textContent = f.name;
                const count = allTradeNotes.filter(n => n.folderId === f.id).length || 0;
                const badge = document.createElement('span'); badge.className = 'ml-2 inline-flex items-center justify-center rounded-full bg-gray-200 text-sm px-2 py-0.5'; badge.textContent = count; titleWrap.appendChild(badge);
                const actions = document.createElement('div'); actions.className = 'folder-actions';
                const addNoteIcon = document.createElement('i'); addNoteIcon.className = 'fas fa-plus-circle cursor-pointer text-green-600'; addNoteIcon.title = 'Add Note'; addNoteIcon.onclick = (e) => { e.stopPropagation(); openAddTradeNoteForFolder(f.id, f.name); };
                actions.appendChild(addNoteIcon);
                btn.appendChild(titleWrap); btn.appendChild(actions);
                btn.onclick = () => { selectedTradeFolderId = f.id; renderTradeFolders(); renderTradeNotes(); document.getElementById('trade-notes-area')?.classList.remove('hidden'); };
                folderList.appendChild(btn);
            });
        };

        const renderTradeNotes = () => {
            const tlist = document.getElementById('trade-notes-list');
            if (!tlist) return;
            tlist.innerHTML = '';
            const filtered = selectedTradeFolderId ? allTradeNotes.filter(n => n.folderId === selectedTradeFolderId) : allTradeNotes;
            if (!filtered || filtered.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'p-6 text-center text-sm text-gray-500 bg-gray-50 rounded';
                empty.innerHTML = `
                    <p class="mb-2">No trading notes yet.</p>
                    <p class="mb-3 text-xs">Use notes to record trade ideas, lessons, or screenshots you want to keep alongside your journal.</p>
                    <div><button id="trade-notes-empty-add" class="px-3 py-1 bg-yellow-500 text-white rounded">Add your first trade note</button></div>
                `;
                tlist.appendChild(empty);
                setTimeout(() => {
                    const cta = document.getElementById('trade-notes-empty-add');
                    if (cta) cta.addEventListener('click', () => openNoteModalForTrade());
                }, 30);
                return;
            }
            filtered.forEach(note => {
                const el = createNoteElement(note, 'trade');
                // use the main note card style for trade embedded (match personal/work)
                el.classList.remove('bg-yellow-50');
                el.classList.add('bg-white');
                tlist.appendChild(el);
            });
        };

        // open add note for a specific trade-folder
        const openAddTradeNoteForFolder = (folderId, folderName) => {
            selectedTradeFolderId = folderId || null; renderTradeFolders(); renderTradeNotes();
            noteModalTarget = 'trade';
            editingNoteId = null;
            document.getElementById('note-modal-title-input').value = '';
            document.getElementById('note-modal-input').value = '';
            document.getElementById('note-modal-title').textContent = 'Add Note';
            populateFolderSelect();
            document.getElementById('note-modal-folder-select').value = folderId || '';
            const m = document.getElementById('note-modal'); m.classList.remove('hidden'); m.classList.add('flex');
        };

        // Open note modal with trade-specific defaults (called from trade area)
        const openNoteModalForTrade = () => {
            editingNoteId = null;
            // prefill modal with contextual placeholder and select '(None)' folder
            document.getElementById('note-modal-title-input').value = '';
            document.getElementById('note-modal-input').value = 'Notes about trade: add entry/exit reasoning, screenshots, or links.';
            document.getElementById('note-modal-title').textContent = 'Add Trade Note';
            populateFolderSelect();
            document.getElementById('note-modal-folder-select').value = '';
            const m = document.getElementById('note-modal'); m.classList.remove('hidden'); m.classList.add('flex');
        };
        // target: 'mode' (personal/working) or 'trade'
        const createNoteElement = (note, target = 'mode') => {
            const item = document.createElement('div');
            item.className = 'note-item p-4 rounded-lg bg-yellow-50 hover:bg-yellow-100 shadow-sm min-h-[120px] flex flex-col';
            item.dataset.id = note.id;

            // Header row: title (left) and actions (right)
            const header = document.createElement('div');
            header.className = 'flex items-start gap-3 mb-2';

            const titleEl = document.createElement('h4');
            titleEl.className = 'text-lg font-bold text-gray-800 flex-1 min-w-0';
            titleEl.textContent = note.title || '';
            if (!note.title) titleEl.style.display = 'none';

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'note-actions';
            const editButton = document.createElement('i');
            editButton.className = 'fas fa-edit';
            editButton.title = 'Edit';
            editButton.onclick = () => {
                if (target === 'trade') editTradeNote(note.id, item);
                else editNote(note.id, item);
            };
            const deleteButton = document.createElement('i');
            deleteButton.className = 'fas fa-trash-alt delete-btn';
            deleteButton.title = 'Delete';
            deleteButton.onclick = () => {
                if (target === 'trade') deleteTradeNote(note.id);
                else deleteNote(note.id);
            };
            actionsDiv.appendChild(editButton);
            actionsDiv.appendChild(deleteButton);

            header.appendChild(titleEl);
            header.appendChild(actionsDiv);

            // Body: the note text
            const bodyWrap = document.createElement('div');
            bodyWrap.className = 'note-content mb-2';
            const textSpan = document.createElement('p');
            textSpan.textContent = note.text || '';
            textSpan.className = 'note-body text-gray-800 break-words text-base leading-relaxed clamped-note';
            bodyWrap.appendChild(textSpan);

            // Show more / Show less toggle placed under the body
            const toggleWrap = document.createElement('div');
            toggleWrap.className = 'toggle-wrap';
            const toggle = document.createElement('button');
            toggle.className = 'text-sm text-blue-600 hidden mt-2';
            toggle.textContent = 'Show more';
            toggle.onclick = () => {
                const nowClamped = textSpan.classList.toggle('clamped-note');
                toggle.textContent = nowClamped ? 'Show more' : 'Show less';
            };
            toggleWrap.appendChild(toggle);

            item.appendChild(header);
            item.appendChild(bodyWrap);
            item.appendChild(toggleWrap);

            // show toggle if overflow
            setTimeout(() => {
                if (textSpan.scrollHeight > (textSpan.clientHeight + 6)) toggle.classList.remove('hidden');
            }, 10);
            return item;
        };
        // Edit a trade-scoped note
        const editTradeNote = (id, item) => {
            const noteObj = allTradeNotes.find(n => n.id === id) || null;
            if (!noteObj) return;
            editingNoteId = id;
            noteModalTarget = 'trade';
            document.getElementById('note-modal-title-input').value = noteObj.title || '';
            document.getElementById('note-modal-input').value = noteObj.text || '';
            document.getElementById('note-modal-title').textContent = 'Edit Trade Note';
            // trade folders are separate; leave folder select blank or prefill if available
            populateFolderSelect();
            document.getElementById('note-modal-folder-select').value = noteObj.folderId || '';
            const m = document.getElementById('note-modal'); m.classList.remove('hidden'); m.classList.add('flex');
        };
        const deleteTradeNote = async (id) => { const confirmed = await showConfirmModal('Delete this trade note?'); if (!confirmed) return; try { await deleteDoc(doc(db, 'hubs', 'trade', 'notes', id)); showNotification('Trade note deleted.'); } catch(e){ showNotification('Failed to delete trade note.', true); } };
        const editNote = (id, item, textSpan) => {
            // Open modal to edit note and allow moving between folders
            const noteObj = allNotes.find(n => n.id === id) || null;
            if (!noteObj) return;
            editingNoteId = id;
            document.getElementById('note-modal-title-input').value = noteObj.title || '';
            document.getElementById('note-modal-input').value = noteObj.text || '';
            document.getElementById('note-modal-title').textContent = 'Edit Note';
            populateFolderSelect();
            document.getElementById('note-modal-folder-select').value = noteObj.folderId || '';
            const m = document.getElementById('note-modal'); m.classList.remove('hidden'); m.classList.add('flex');
        };
        const addNote = async (title, text) => {
            try {
                await addDoc(collection(db, "hubs", currentMode, "notes"), { title: title || null, text, folderId: selectedFolderId || null, createdAt: Date.now() });
            } catch (e) {
                console.error("Error adding note: ", e);
                showNotification('Failed to add note.', true);
            }
        };
        const deleteNote = async (id) => { const confirmed = await showConfirmModal('Are you sure you want to delete this note?'); if (confirmed) { try { await deleteDoc(doc(db, "hubs", currentMode, "notes", id)); showNotification('Note deleted.'); } catch (e) { showNotification('Failed to delete note.', true); } } };



        // --- Mode Switching ---
        const switchMode = (newMode) => {
            // hide trade section and clear trade active state when switching modes
            const tradeSection = document.getElementById('trade-section'); if (tradeSection) { tradeSection.classList.add('hidden'); tradeSection.classList.remove('flex'); }
            document.getElementById('trade-btn')?.classList.remove('active');

            if (currentMode === newMode) return;
            currentMode = newMode;
            localStorage.setItem('currentMode', newMode);
            // notes are plain text; no lock state
            updateModeUI();
            
            listeners.forEach(unsubscribe => unsubscribe());
            listeners = [];
            if (typeof rulesUnsub === 'function') { try { rulesUnsub(); } catch(e){} rulesUnsub = null; }

            initializeListeners(newMode);
            renderCalendar();
        };

        const updateModeUI = () => {
            const personalBtn = document.getElementById('personal-mode-btn');
            const workingBtn = document.getElementById('working-mode-btn');
            const modeLabel = document.getElementById('board-mode-label');
            if (currentMode === 'personal') {
                personalBtn.classList.add('active');
                workingBtn.classList.remove('active');
                if(modeLabel) modeLabel.textContent = 'Mode: Personal';
            } else {
                workingBtn.classList.add('active');
                personalBtn.classList.remove('active');
                if(modeLabel) modeLabel.textContent = 'Mode: Working';
            }
        };

        // Wire up the mode buttons so they switch modes when clicked
        // Navigation helpers: update UI, ARIA, and history
        const sections = {
            board: 'project-board-section',
            daily: 'daily-routine-section',
            notes: 'important-notes-section',
            trade: 'trade-section'
        };

        const applyNavigationState = (target) => {
            // target: one of 'board'|'daily'|'notes'|'trade' or section id
            // hide all primary sections first
            Object.values(sections).forEach(id => { const el = document.getElementById(id); if (el) { el.classList.add('hidden'); el.classList.remove('flex'); } });

            // clear active states
            document.getElementById('trade-btn')?.classList.remove('active');
            document.getElementById('personal-mode-btn')?.classList.remove('active');
            document.getElementById('working-mode-btn')?.classList.remove('active');
            // reset aria
            document.getElementById('trade-btn')?.setAttribute('aria-pressed','false');
            document.getElementById('personal-mode-btn')?.setAttribute('aria-pressed','false');
            document.getElementById('working-mode-btn')?.setAttribute('aria-pressed','false');

            // show requested: if target is trade => single trade view; otherwise show all main sections together
            if (target === 'trade' || target === sections.trade) {
                const el = document.getElementById(sections.trade);
                if (el) {
                    // Save original className once so we can restore exactly on exit
                    if (!el.dataset._origClass) el.dataset._origClass = el.className;
                    // show trade section as a single full-page view
                    el.classList.remove('hidden');
                    el.classList.add('flex','w-full','min-h-screen');
                    // remove rounded that constrains it so it appears full-page
                    el.classList.remove('rounded-xl');

                    // if there's an inner max-width wrapper, expand it to full width and save its original classes
                    // try to find a child with a 'max-w-' class (covers max-w-4xl, max-w-5xl, etc.)
                    const inner = Array.from(el.children).find(c => /max-w-/.test(c.className)) || el.querySelector('.max-w-5xl');
                    if (inner) {
                        if (!inner.dataset._origClass) inner.dataset._origClass = inner.className;
                        inner.classList.remove('max-w-5xl','mx-auto');
                        inner.classList.add('w-full','max-w-full','mx-0','px-4');
                    }
                    // allow CSS rules keyed on body.trade-full to apply as well
                    document.body.classList.add('trade-full');

                    // Keep the existing background and utility classes so Trade Journal
                    // visually matches the Personal (Project Board) page. Previously
                    // this area converted .bg-white elements to dark variants; that
                    // behavior has been removed to keep a consistent white background.
                    // Run a small sweep to normalize any lingering color utility classes.
                    try { normalizeTradeColors(el); } catch(e) { console.warn('normalizeTradeColors failed', e); }
                }
                document.getElementById('trade-btn')?.classList.add('active');
                document.getElementById('trade-btn')?.setAttribute('aria-pressed','true');
            } else {
                // show all main sections (Project Board + Daily + Notes)
                const boardEl = document.getElementById(sections.board); if (boardEl) { boardEl.classList.remove('hidden'); }
                const dailyEl = document.getElementById(sections.daily); if (dailyEl) { dailyEl.classList.remove('hidden'); }
                const notesEl = document.getElementById(sections.notes); if (notesEl) { notesEl.classList.remove('hidden'); }
                // if we left trade view, restore trade section sizing to its original card-like appearance
                const tradeEl = document.getElementById(sections.trade);
                if (tradeEl) {
                    // If we saved original class lists, restore them precisely
                    if (tradeEl.dataset._origClass) {
                        tradeEl.className = tradeEl.dataset._origClass;
                        delete tradeEl.dataset._origClass;
                    } else {
                        tradeEl.classList.remove('flex','w-full','min-h-screen');
                        tradeEl.classList.add('hidden','rounded-xl');
                    }
                    const inner = tradeEl.querySelector('[data-_orig-class]') || Array.from(tradeEl.children).find(c => /\bmax-w-/.test(c.className));
                    if (inner) {
                        if (inner.dataset._origClass) {
                            inner.className = inner.dataset._origClass;
                            delete inner.dataset._origClass;
                        } else {
                            inner.classList.remove('w-full','max-w-full','mx-0','px-4');
                            inner.classList.add('max-w-5xl','mx-auto');
                        }
                    }
                    // restore any elements we toggled to dark utilities
                    try {
                        const toggled = tradeEl.querySelectorAll('[data-_orig-class-all]');
                        toggled.forEach(n => {
                            n.className = n.dataset._origClassAll;
                            delete n.dataset._origClassAll;
                        });
                    } catch (e) { console.warn('Restore original classes failed', e); }
                    // remove body trade-full marker
                    document.body.classList.remove('trade-full');
                }
                // set appropriate focus/scroll if user navigated to a specific sub-section
                if (target === 'daily' || target === sections.daily) { document.getElementById(sections.daily)?.scrollIntoView({ behavior: 'smooth' }); }
                else if (target === 'notes' || target === sections.notes) { document.getElementById(sections.notes)?.scrollIntoView({ behavior: 'smooth' }); }
                else { document.getElementById(sections.board)?.scrollIntoView({ behavior: 'smooth' }); }
                // update mode buttons UI for board view
                updateModeUI();
            }
        };

        const navigateTo = (target, opts = { replace: false }) => {
            // push history (use path like #/board, #/trade)
            const hash = typeof target === 'string' && Object.keys(sections).includes(target) ? `#/${target}` : `#/${target}`;
            if (opts.replace) history.replaceState({ target }, '', hash); else history.pushState({ target }, '', hash);
            applyNavigationState(target);
        };

        const parseHash = () => {
            const h = location.hash || '';
            if (!h) return 'board';
            const parts = h.replace(/^#\/?/, '').split('/');
            return parts[0] || 'board';
        };

        window.addEventListener('popstate', (e) => { const t = (e.state && e.state.target) || parseHash(); applyNavigationState(t); });

    // On initial load, apply navigation based on hash (or default to board)
    const initial = parseHash() || 'board';
    // ensure URL shows a hash for shareability
    if (!location.hash) history.replaceState({ target: initial }, '', `#/${initial}`);
    applyNavigationState(initial);

        // keyboard support: allow Enter/Space on buttons
        const makeKeyboardClickable = (el) => { if (!el) return; el.tabIndex = 0; el.addEventListener('keydown', (ev) => { if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); el.click(); } }); };

        // wire mode buttons to navigation
        document.getElementById('personal-mode-btn')?.addEventListener('click', () => { switchMode('personal'); navigateTo('board'); document.getElementById('personal-mode-btn')?.setAttribute('aria-pressed','true'); });
        document.getElementById('working-mode-btn')?.addEventListener('click', () => { switchMode('working'); navigateTo('board'); document.getElementById('working-mode-btn')?.setAttribute('aria-pressed','true'); });
        makeKeyboardClickable(document.getElementById('personal-mode-btn'));
        makeKeyboardClickable(document.getElementById('working-mode-btn'));

        // (previous helper removed) top nav links use navigateTo to restore main sections

        // Wire top nav links to navigate (and sync URL)
        document.querySelectorAll('a[href="#project-board-section"]').forEach(a => { a.addEventListener('click', (e) => { e.preventDefault(); navigateTo('board'); }); });
        document.querySelectorAll('a[href="#daily-routine-section"]').forEach(a => { a.addEventListener('click', (e) => { e.preventDefault(); navigateTo('daily'); }); });
        document.querySelectorAll('a[href="#important-notes-section"]').forEach(a => { a.addEventListener('click', (e) => { e.preventDefault(); navigateTo('notes'); }); });

        // --- Trade Journal JS ---
        const tradeBtn = document.getElementById('trade-btn');
        const tradeSection = document.getElementById('trade-section');
        if (tradeBtn && tradeSection) {
            tradeBtn.addEventListener('click', () => {
                const cur = parseHash();
                if (cur === 'trade') {
                    // go back to board
                    navigateTo('board');
                } else {
                    navigateTo('trade');
                    // move focus into trade section for accessibility
                    setTimeout(()=>{ document.getElementById('trade-asset')?.focus(); }, 120);
                }
            });
            makeKeyboardClickable(tradeBtn);
        }

    // Trade helpers (single collection for all modes)
    const tradeCollectionPath = () => collection(db, 'trades');

        // Rules helpers (CRUD) - global collection 'rules'
        let rulesUnsub = null;
        const rulesCollectionPath = () => collection(db, 'rules');

        const listenRules = () => {
            if (rulesUnsub) rulesUnsub();
            const q = query(rulesCollectionPath(), orderBy('createdAt','asc'));
            rulesUnsub = onSnapshot(q, snapshot => {
                const rules = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderRulesChecklist(rules);
                renderRulesListModal(rules);
            });
        };

        const addRule = async (text) => {
            if (!text || !text.trim()) return;
            try { await addDoc(rulesCollectionPath(), { text: text.trim(), createdAt: Date.now() }); } catch (err) { console.error('addRule failed', err); }
        };

        const updateRule = async (id, text) => { if (!id) return; try { await updateDoc(doc(db, 'rules', id), { text, updatedAt: Date.now() }); } catch (err) { console.error('updateRule failed', err); } };

        const deleteRule = async (id) => {
            if (!id) return;
            try {
                // check if any trade in the global trades collection references this ruleId
                const tradesRef = collection(db, 'trades');
                const qUsed = query(tradesRef, where('confirmedRuleIds', 'array-contains', id));
                const snap = await getDocs(qUsed);
                if (!snap.empty) {
                    showNotification('Rule ini sedang dipakai oleh trade yang sudah disimpan. Tidak bisa dihapus.', true);
                    return;
                }
                await deleteDoc(doc(db, 'rules', id));
                showNotification('Rule deleted.');
            } catch (err) {
                console.error('deleteRule failed', err);
                showNotification('Gagal menghapus rule.', true);
            }
        };

        // Render checklist under trade table
        const renderRulesChecklist = (rules) => {
            const container = document.getElementById('trade-rules-checklist');
            const formList = document.getElementById('trade-form-rules-list');
            if (container) container.innerHTML = '';
            if (formList) formList.innerHTML = '';
            if (!container) return;
            if (!rules || !rules.length) {
                container.innerHTML = '<p class="text-sm text-gray-500">No active trading rules. Click Manage Rules to add.</p>';
                // when there are no rules, allow saving trades
                const saveBtn = document.getElementById('trade-save'); if (saveBtn) saveBtn.removeAttribute('disabled');
                return;
            }
            rules.forEach(r => {
                const id = r.id;
                const row = document.createElement('label');
                row.className = 'flex items-start gap-3';
                row.innerHTML = `<input type="checkbox" data-rule-id="${id}" class="trade-rule-checkbox mt-1" /> <span class="text-sm text-gray-800">${escapeHtml(r.text || '')}</span>`;
                container.appendChild(row);
                // also render into the trade form rules area
                if (formList) {
                    const fRow = document.createElement('label'); fRow.className = 'flex items-start gap-3';
                    fRow.innerHTML = `<input type="checkbox" data-rule-id="${id}" class="trade-form-rule-checkbox mt-1" /> <span class="text-sm text-gray-800">${escapeHtml(r.text || '')}</span>`;
                    formList.appendChild(fRow);
                }
            });

            // attach change listeners for table checklist
            const checkboxes = container.querySelectorAll('.trade-rule-checkbox');
            checkboxes.forEach(cb => cb.addEventListener('change', ()=>{ validateRulesChecklist(); }));
            // attach change listeners for form checklist that control Save button
            const formCheckboxes = document.querySelectorAll('.trade-form-rule-checkbox');
            formCheckboxes.forEach(cb => cb.addEventListener('change', ()=>{ validateRulesChecklist(); }));
            // initial validate
            validateRulesChecklist();
        };

        // Simplified: always enable Save button. Rules checklist remains visible but does not block saving.
        const validateRulesChecklist = () => {
            const saveBtn = document.getElementById('trade-save');
            if (!saveBtn) return;
            saveBtn.removeAttribute('disabled');
        };

        // Render rules management modal list
        const renderRulesListModal = (rules) => {
            const list = document.getElementById('rules-list'); if (!list) return; list.innerHTML = '';
            rules.forEach(r => {
                const div = document.createElement('div'); div.className = 'flex items-center justify-between gap-2 p-2 border rounded';
                div.innerHTML = `
                    <div class="flex-1">
                        <input data-rule-id="${r.id}" class="rule-edit-input w-full p-1 border rounded" value="${escapeHtml(r.text||'')}" />
                    </div>
                    <div class="flex items-center gap-2">
                        <button data-id="${r.id}" class="save-rule-btn px-2 py-1 bg-green-500 text-white rounded">Save</button>
                        <button data-id="${r.id}" class="del-rule-btn px-2 py-1 bg-red-500 text-white rounded">Delete</button>
                    </div>
                `;
                list.appendChild(div);
            });
            // attach handlers
            list.querySelectorAll('.save-rule-btn').forEach(btn => btn.addEventListener('click', (e)=>{ const id = btn.dataset.id; const input = list.querySelector(`input[data-rule-id="${id}"]`); if (input) updateRule(id, input.value); }));
            list.querySelectorAll('.del-rule-btn').forEach(btn => btn.addEventListener('click', async (e)=>{ const id = btn.dataset.id; // attempt delete with check
                // confirm first
                const confirmed = await showConfirmModal('Delete this rule?'); if (!confirmed) return; deleteRule(id); }));
        };

        // simple HTML escape
        const escapeHtml = (s='') => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

        // Manage Rules UI wiring
        document.getElementById('manage-rules-btn')?.addEventListener('click', ()=>{ document.getElementById('rules-section')?.classList.remove('hidden'); document.getElementById('rules-section')?.classList.add('flex'); document.getElementById('new-rule-input')?.focus(); });
        document.getElementById('rules-close-btn')?.addEventListener('click', ()=>{ document.getElementById('rules-section')?.classList.add('hidden'); document.getElementById('rules-section')?.classList.remove('flex'); });
        document.getElementById('add-rule-btn')?.addEventListener('click', ()=>{ const v = document.getElementById('new-rule-input')?.value || ''; if (v.trim()) { addRule(v); document.getElementById('new-rule-input').value = ''; document.getElementById('new-rule-input')?.focus(); } });

    // Start listening rules (global)
    listenRules();

        const uploadTradeScreenshots = async (tradeId, files) => {
            const results = [];
            for (const f of files) {
                try {
                    const blob = await resizeImageFile(f, 1600, 1600, 0.8);
                    const path = `trades/${tradeId}/${Date.now()}_${f.name.replace(/[^a-zA-Z0-9._-]/g,'_')}`;
                    const ref = storageRef(storage, path);
                    await uploadBytes(ref, blob);
                    const url = await getDownloadURL(ref);
                    results.push({ path, url });
                } catch (err) { console.warn('uploadTradeScreenshots failed', err); results.push(null); }
            }
            return results;
        };

        // Save trade form
        const tradeForm = document.getElementById('trade-form');
        if (tradeForm) {
        let isSavingTrade = false;
        tradeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (isSavingTrade) { console.warn('Save already in progress, ignoring duplicate submit'); return; }
            isSavingTrade = true;
            const saveBtn = document.getElementById('trade-save'); if (saveBtn) { saveBtn.setAttribute('disabled','true'); }
                const asset = document.getElementById('trade-asset').value.trim();
                const pair = document.getElementById('trade-pair').value.trim();
                const type = document.getElementById('trade-type').value;
                // status field (Open, Closed, Cancelled)
                const status = document.getElementById('trade-status') ? document.getElementById('trade-status').value : 'Open';
                const datetime = document.getElementById('trade-datetime').value || new Date().toISOString();
                const entry = parseFloat(document.getElementById('trade-entry').value) || 0;
                const exit = parseFloat(document.getElementById('trade-exit').value) || 0;
                const qty = parseFloat(document.getElementById('trade-qty').value) || 0;
                // fees and total removed; only keep currency
                const currency = document.getElementById('trade-currency') ? document.getElementById('trade-currency').value : 'USD';
                const openReason = document.getElementById('trade-open-reason').value.trim();
                const closeReason = document.getElementById('trade-close-reason').value.trim();
                const filesInput = document.getElementById('trade-screenshots');
                const files = filesInput && filesInput.files && filesInput.files.length ? Array.from(filesInput.files) : [];
                // gather confirmed rule ids from the form (if any)
                const confirmedRuleIds = Array.from(document.querySelectorAll('.trade-form-rule-checkbox:checked')).map(cb => cb.dataset.ruleId).filter(Boolean);
                try {
                        if (editingTradeId) {
                        // update existing trade (fees/total removed) and save confirmed rules
                        await updateDoc(doc(db, 'trades', editingTradeId), { asset, pair, type, status, datetime, entry, exit, qty, currency, openReason, closeReason, confirmedRuleIds, updatedAt: Date.now() });
                        if (files.length) {
                            const uploads = await uploadTradeScreenshots(editingTradeId, files);
                            const paths = uploads.filter(r=>r).map(r=>r.path);
                            const urls = uploads.filter(r=>r).map(r=>r.url);
                            await updateDoc(doc(db, 'trades', editingTradeId), { screenshotPaths: paths, screenshotUrls: urls });
                        }
                        showNotification('Trade updated.');
                        } else {
                        const docRef = await addDoc(tradeCollectionPath(), { asset, pair, type, status, datetime, entry, exit, qty, currency, openReason, closeReason, confirmedRuleIds, createdAt: Date.now(), updatedAt: Date.now() });
                        if (files.length) {
                            const uploads = await uploadTradeScreenshots(docRef.id, files);
                            const paths = uploads.filter(r=>r).map(r=>r.path);
                            const urls = uploads.filter(r=>r).map(r=>r.url);
                            await updateDoc(doc(db, 'trades', docRef.id), { screenshotPaths: paths, screenshotUrls: urls });
                        }
                        showNotification('Trade saved.');
                    }
                    tradeForm.reset();
                    // re-validate rule checklist so Save button gets correct enabled state after reset
                    try { validateRulesChecklist(); } catch (e) { /* ignore */ }
                    editingTradeId = null;
                    // refresh listeners will pick up new trade
                } catch (err) { console.error('save trade failed', err); showNotification('Failed to save trade.', true); }
                finally { isSavingTrade = false; const saveBtn2 = document.getElementById('trade-save'); if (saveBtn2) { saveBtn2.removeAttribute('disabled'); } }
            });
        }

    document.getElementById('trade-cancel')?.addEventListener('click', () => { editingTradeId = null; document.getElementById('trade-form').reset(); const dt = document.getElementById('trade-datetime'); if (dt) dt.value = new Date().toISOString().slice(0,16); const modal = document.getElementById('trade-form-modal'); if (modal) { modal.classList.add('hidden'); modal.classList.remove('flex'); } });

    // --- Analytics (Chart.js) and aggregated stats ---
    const loadChartJs = () => {
        if (window.Chart) return Promise.resolve();
        return new Promise((res, rej) => {
            const s = document.createElement('script');
            // Use explicit UMD bundle so window.Chart is available
            s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js';
            s.onload = () => { console.debug('Chart.js loaded'); res(); };
            s.onerror = (e) => { console.warn('Chart.js failed to load', e); rej(e); };
            document.head.appendChild(s);
        });
    };

    // Normalize color utilities inside the trade section to ensure consistent light styling
    const normalizeTradeColors = (rootEl) => {
        const root = rootEl || document.getElementById('trade-section');
        if (!root) return;
        // remove dark utility classes that may have been applied
        const darkClasses = ['bg-gray-900','text-gray-100','border-gray-700','dark','bg-yellow-50'];
        darkClasses.forEach(cls => {
            root.querySelectorAll('.' + cls).forEach(n => n.classList.remove(cls));
        });
        // ensure panels and cards have light background classes
        root.querySelectorAll('.panel, .card, .note-item, .task-card, .bg-white').forEach(n => {
            n.classList.remove('bg-gray-900','text-gray-100');
            if (!n.classList.contains('bg-white')) n.classList.add('bg-white');
            n.style.color = '';
        });
        // normalize inputs
        root.querySelectorAll('input,textarea,select').forEach(inp => {
            inp.classList.remove('bg-gray-900','text-gray-100','border-gray-700');
            if (!inp.classList.contains('bg-white')) inp.classList.add('bg-white');
            inp.style.color = '';
        });
    };

    let tradeCharts = { equity: null, winrate: null };
    const computeAndRenderStats = async (trades) => {
        console.debug('computeAndRenderStats called, trades length:', Array.isArray(trades)?trades.length:0);
        try { await loadChartJs(); } catch(e){ console.warn('Chart.js load failed', e); }

        // normalize and sort trades by date/createdAt
        const tlist = Array.isArray(trades) ? trades.slice().map(t=>({
            ...t,
            createdAt: t.createdAt || t.date || (t._ts && t._ts.seconds) || 0
        })).sort((a,b)=> (a.createdAt||0)-(b.createdAt||0)) : [];

        // build P/L list and labels using trade date if available
        const plList = [];
        const labels = [];
        for (const t of tlist) {
            const entry = Number(t.entry);
            const exit = Number(t.exit);
            // require both entry and exit to compute a closed trade P/L
            if (!isFinite(entry) || !isFinite(exit)) continue;
            const qty = isFinite(Number(t.qty)) && Number(t.qty)>0 ? Number(t.qty) : 1;
            const pl = (exit - entry) * qty;
            if (!isFinite(pl)) continue;
            plList.push(Math.round(pl*1000000)/1000000);
            // try to use readable datetime label
            const dt = t.date || t.datetime || (t.createdAt && new Date(t.createdAt*1000).toISOString()) || null;
            labels.push(dt ? String(dt).slice(0,16).replace('T',' ') : labels.length+1);
        }

        const total = plList.length;
        const wins = plList.filter(p=>p>0).length;
        const losses = plList.filter(p=>p<=0).length;
        const winrate = total ? Math.round((wins/total)*10000)/100 : 0;
        const sum = plList.reduce((s,v)=>s+v,0);
        const avg = total ? (sum/total) : 0;

        // equity curve
        const equity = []; let cum = 0; for (const p of plList) { cum += p; equity.push(Math.round(cum*100)/100); }

        // max drawdown
        let peak = -Infinity, maxDD = 0; for (const v of equity) { if (v>peak) peak=v; const dd = peak - v; if (dd>maxDD) maxDD = dd; }

        console.debug('stats computed', { total, wins, losses, winrate, avg, maxDD, samplePL: plList.slice(0,5), labelsSample: labels.slice(0,5) });
        document.getElementById('stat-total').textContent = total;
        document.getElementById('stat-wins').textContent = wins;
        document.getElementById('stat-losses').textContent = losses;
        document.getElementById('stat-winrate').textContent = winrate + '%';
        document.getElementById('stat-avgpl').textContent = avg.toFixed(4);
        document.getElementById('stat-mdd').textContent = maxDD.toFixed(4);

        // equity chart
        const eqEl = document.getElementById('chart-equity');
        if (eqEl && window.Chart) {
            console.debug('chart-equity element size before', { clientWidth: eqEl.clientWidth, clientHeight: eqEl.clientHeight, width: eqEl.width, height: eqEl.height });
            if (tradeCharts.equity) try { tradeCharts.equity.destroy(); } catch(e){}
            // enforce explicit canvas sizing to avoid responsive reflows
            eqEl.style.display = 'block';
            eqEl.style.width = '100%';
            eqEl.style.height = '180px';
            eqEl.style.maxHeight = '400px';
            eqEl.style.boxSizing = 'border-box';
            // set canvas pixel attributes to match CSS height for Chart.js when responsive is disabled
            try { eqEl.width = Math.floor(eqEl.clientWidth); } catch(e){}
            try { eqEl.height = parseInt(window.getComputedStyle(eqEl).height) || 180; } catch(e){}
            // pass the element instead of context to Chart (UMD supports both)
            try {
                // compute y-axis bounds to avoid zero-range (Chart.js can misbehave when min==max)
                const dsVals = equity.slice();
                let yMin = null, yMax = null;
                if (dsVals.length) {
                    yMin = Math.min(...dsVals);
                    yMax = Math.max(...dsVals);
                    if (yMin === yMax) { yMin = yMin - 1; yMax = yMax + 1; }
                    else {
                        const pad = Math.max((yMax - yMin) * 0.08, 0.0001);
                        yMin = yMin - pad; yMax = yMax + pad;
                    }
                }
                tradeCharts.equity = new Chart(eqEl, {
                    type: 'line',
                    data: {
                        labels: labels.length ? labels : equity.map((_,i)=>i+1),
                        datasets: [{ label: 'Equity', data: equity, borderColor:'#4f46e5', borderWidth:2, backgroundColor:'rgba(79,70,229,0.08)', fill:true }]
                    },
                    options: { responsive:true, maintainAspectRatio:false, animation: false, plugins:{legend:{display:false}}, scales: { y: { min: yMin, max: yMax } } }
                });
                // With responsive disabled we don't need forced redraws; still attempt a small update to be safe
                try { tradeCharts.equity.update(); console.debug('equity chart created and updated'); } catch(e) { console.warn('equity chart update failed', e); }
            } catch (err) {
                console.error('Chart creation failed for equity', err);
            }
            console.debug('equity dataset', { labels: labels.slice(0,10), equity: equity.slice(0,10) });
            console.debug('chart-equity element size after', { clientWidth: eqEl.clientWidth, clientHeight: eqEl.clientHeight, width: eqEl.width, height: eqEl.height });
        }

        // winrate chart
        const wrEl = document.getElementById('chart-winrate');
        if (wrEl && window.Chart) {
            console.debug('chart-winrate element size before', { clientWidth: wrEl.clientWidth, clientHeight: wrEl.clientHeight, width: wrEl.width, height: wrEl.height });
            if (tradeCharts.winrate) try { tradeCharts.winrate.destroy(); } catch(e){}
            // enforce explicit sizing for winrate canvas
            wrEl.style.display = 'block';
            wrEl.style.width = '100%';
            wrEl.style.height = '120px';
            wrEl.style.maxHeight = '300px';
            wrEl.style.boxSizing = 'border-box';
            try { wrEl.width = Math.floor(wrEl.clientWidth); } catch(e){}
            try { wrEl.height = parseInt(window.getComputedStyle(wrEl).height) || 120; } catch(e){}
            try {
                tradeCharts.winrate = new Chart(wrEl, {
                    type: 'bar',
                    data: { labels:['Wins','Losses'], datasets:[{ data:[wins,losses], backgroundColor:['#10b981','#ef4444'] }] },
                    options: { responsive:false, maintainAspectRatio:false, animation: false, plugins:{legend:{display:false}} }
                });
                try { tradeCharts.winrate.update(); console.debug('winrate chart created and updated'); } catch(e) { console.warn('winrate chart update failed', e); }
            } catch (err) {
                console.error('Chart creation failed for winrate', err);
            }
            console.debug('chart-winrate element size after', { clientWidth: wrEl.clientWidth, clientHeight: wrEl.clientHeight, width: wrEl.width, height: wrEl.height });
        }
    };

    // --- Capital management (capital_movements) ---
    let capitalUnsub = null;
    const listenCapitalMovements = () => {
        if (capitalUnsub) capitalUnsub();
        const ref = collection(db, 'capital_movements');
        const q = query(ref, orderBy('date','desc'));
        capitalUnsub = onSnapshot(q, snap => {
            const items = snap.docs.map(d=>({ id: d.id, ...d.data() }));
            renderCapitalList(items);
        });
    };

    const renderCapitalList = (items) => {
        const body = document.getElementById('capital-table-body'); if (!body) return; body.innerHTML = '';
        let balance = 0;
        items.forEach(it => {
            const tr = document.createElement('tr');
            const date = new Date(it.date || it.createdAt || Date.now()).toLocaleDateString();
            const type = it.type || 'DEPOSIT';
            const amt = Number(it.amount || 0);
            balance += (type === 'DEPOSIT' ? amt : -amt);
            tr.innerHTML = `<td class="p-2 border text-sm">${date}</td><td class="p-2 border text-sm">${type}</td><td class="p-2 border text-sm">${amt}</td><td class="p-2 border text-sm">${(it.notes||'')}</td><td class="p-2 border text-sm flex gap-2 items-center"><button data-id="${it.id}" data-type="edit" class="edit-capital px-2 py-1 bg-yellow-400 text-white rounded" title="Edit"><i class="fas fa-edit"></i></button><button data-id="${it.id}" data-type="delete" class="del-capital px-2 py-1 bg-red-500 text-white rounded" title="Delete"><i class="fas fa-trash-alt"></i></button></td>`;
            body.appendChild(tr);
        });
    const balEl = document.getElementById('capital-balance'); if (balEl) balEl.textContent = 'Rp ' + balance.toFixed(4);
        // attach edit/delete handlers
        document.querySelectorAll('.edit-capital').forEach(btn => btn.addEventListener('click', async (e) => {
            const id = btn.dataset.id;
            const snap = await getDoc(doc(db,'capital_movements', id));
            if (!snap || !snap.exists()) { alert('Item not found'); return; }
            const data = snap.data();
            openCapitalModal({ id, ...data });
        }));
        document.querySelectorAll('.del-capital').forEach(btn=>btn.addEventListener('click', async (e)=>{ const id = btn.dataset.id; const c = confirm('Hapus transaksi modal?'); if (!c) return; try { await deleteDoc(doc(db,'capital_movements',id)); alert('Deleted'); } catch(err){ alert('Gagal menghapus'); } }));
    };

    // opens capital modal for create or edit; if item provided, it's edit
    const openCapitalModal = (item) => {
        const html = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="w-full max-w-md rounded-lg p-6 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 shadow-lg">
                    <h3 class="text-lg font-semibold mb-3">${item && item.id ? 'Edit' : 'Tambah'} Manajemen Modal</h3>
                    <form id="_capital_inline_form_local">
                        <label class="block text-sm">Tipe</label>
                        <select id="_capital_type_local" class="w-full p-2 border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 mb-3"><option value="DEPOSIT">Deposit</option><option value="WITHDRAWAL">Withdrawal</option></select>
                        <label class="block text-sm">Jumlah</label>
                        <input id="_capital_amount_local" type="number" step="any" class="w-full p-2 border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 mb-3" required />
                        <label class="block text-sm">Tanggal</label>
                        <input id="_capital_date_local" type="datetime-local" class="w-full p-2 border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 mb-3" />
                        <label class="block text-sm">Catatan</label>
                        <textarea id="_capital_notes_local" class="w-full p-2 border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 mb-3"></textarea>
                        <div class="flex justify-end gap-2 mt-4">
                            <button type="button" id="_capital_cancel_local" class="px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100">Batal</button>
                            <button type="submit" class="px-3 py-1 rounded bg-green-600 text-white">Simpan</button>
                        </div>
                    </form>
                </div>
            </div>`;
        const wrapper = document.createElement('div'); wrapper.innerHTML = html; document.body.appendChild(wrapper);
        const fm = document.getElementById('_capital_inline_form_local');
        const cancelBtn = document.getElementById('_capital_cancel_local');
        const setDefaults = () => {
            const _d = document.getElementById('_capital_date_local'); if (_d) _d.value = (item && item.date) ? new Date(item.date).toISOString().slice(0,16) : new Date().toISOString().slice(0,16);
            const _t = document.getElementById('_capital_type_local'); if (_t) _t.value = (item && item.type) ? item.type : 'DEPOSIT';
            const _a = document.getElementById('_capital_amount_local'); if (_a) _a.value = (item && item.amount) ? item.amount : '';
            const _n = document.getElementById('_capital_notes_local'); if (_n) _n.value = (item && item.notes) ? item.notes : '';
        };
        setDefaults();
        cancelBtn.addEventListener('click', ()=>{ wrapper.remove(); });
        fm.addEventListener('submit', async (ev)=>{
            ev.preventDefault();
            const type = document.getElementById('_capital_type_local').value || 'DEPOSIT';
            const amount = Number(document.getElementById('_capital_amount_local').value) || 0;
            const dateVal = document.getElementById('_capital_date_local').value;
            const notes = document.getElementById('_capital_notes_local').value.trim() || null;
            if (!amount || amount <= 0) { alert('Jumlah harus lebih besar dari 0'); return; }
            const date = dateVal ? new Date(dateVal).getTime() : Date.now();
            try {
                if (item && item.id) {
                    await updateDoc(doc(db,'capital_movements', item.id), { user: currentUserUid, type, amount, date, notes, updatedAt: Date.now() });
                } else {
                    await addDoc(collection(db,'capital_movements'), { user: currentUserUid, type, amount, date, notes, createdAt: Date.now() });
                }
                wrapper.remove();
            } catch(err){ console.error(err); alert('Gagal menyimpan modal'); }
        });
    };

    // Open capital modal
    document.getElementById('capital-new-btn')?.addEventListener('click', ()=>{
        const html = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="w-full max-w-md rounded-lg p-6 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 shadow-lg">
                    <h3 class="text-lg font-semibold mb-3">Tambah Manajemen Modal</h3>
                    <form id="_capital_inline_form">
                        <label class="block text-sm">Tipe</label>
                        <select id="_capital_type" class="w-full p-2 border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 mb-3"><option value="DEPOSIT">Deposit</option><option value="WITHDRAWAL">Withdrawal</option></select>
                        <label class="block text-sm">Jumlah</label>
                        <input id="_capital_amount" type="number" step="any" class="w-full p-2 border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 mb-3" required />
                        <label class="block text-sm">Tanggal</label>
                        <input id="_capital_date" type="datetime-local" class="w-full p-2 border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 mb-3" />
                        <label class="block text-sm">Catatan</label>
                        <textarea id="_capital_notes" class="w-full p-2 border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 mb-3"></textarea>
                        <div class="flex justify-end gap-2 mt-4">
                            <button type="button" id="_capital_cancel" class="px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100">Batal</button>
                            <button type="submit" class="px-3 py-1 rounded bg-green-600 text-white">Simpan</button>
                        </div>
                    </form>
                </div>
            </div>`;
    const wrapper = document.createElement('div'); wrapper.innerHTML = html; document.body.appendChild(wrapper);
    const fm = document.getElementById('_capital_inline_form');
    // set default date to now
    const _dtEl = document.getElementById('_capital_date'); if (_dtEl) _dtEl.value = new Date().toISOString().slice(0,16);
    document.getElementById('_capital_cancel').addEventListener('click', ()=>{ wrapper.remove(); });
        fm.addEventListener('submit', async (ev)=>{
            ev.preventDefault();
            const type = document.getElementById('_capital_type').value || 'DEPOSIT';
            const amount = Number(document.getElementById('_capital_amount').value) || 0;
            const dateVal = document.getElementById('_capital_date').value;
            const notes = document.getElementById('_capital_notes').value.trim() || null;
            if (!amount || amount <= 0) { alert('Jumlah harus lebih besar dari 0'); return; }
            const date = dateVal ? new Date(dateVal).getTime() : Date.now();
            try {
                await addDoc(collection(db,'capital_movements'), { user: currentUserUid, type, amount, date, notes, createdAt: Date.now() });
                alert('Transaksi modal tersimpan.'); wrapper.remove();
            } catch(err){ console.error(err); alert('Gagal menyimpan modal'); }
        });
    });


    // Render trade table and listen for updates
    let tradeUnsub = null;
    let listenTrades = () => {
            if (tradeUnsub) tradeUnsub();
            const q = query(collection(db, 'trades'), orderBy('createdAt', 'desc'));
            tradeUnsub = onSnapshot(q, snapshot => {
                const rows = document.getElementById('trade-table-body');
                rows.innerHTML = '';
                    // gather filter values
                    const fAsset = (document.getElementById('trade-filter-asset')?.value || '').toLowerCase();
                    const fPair = (document.getElementById('trade-filter-pair')?.value || '').toLowerCase();
                    const fStatus = (document.getElementById('trade-filter-status')?.value || '');
                    let visibleIndex = 0;
                    const tradesForStats = [];
                    snapshot.docs.forEach((docSnap, i) => {
                        const t = { id: docSnap.id, ...docSnap.data() };
                        // apply client-side filters
                        if (fAsset && !(t.asset || '').toLowerCase().includes(fAsset)) return;
                        if (fPair && !(t.pair || '').toLowerCase().includes(fPair)) return;
                        if (fStatus) {
                            const pl = (((t.exit || 0) - (t.entry || 0)) * (t.qty || 0));
                            if (fStatus === 'profit' && pl <= 0) return;
                            if (fStatus === 'loss' && pl >= 0) return;
                        }
                        visibleIndex += 1;
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="p-2 border text-sm">${visibleIndex}</td>
                            <td class="p-2 border text-sm">${t.asset || ''}</td>
                            <td class="p-2 border text-sm">${t.pair || ''}</td>
                            <td class="p-2 border text-sm">${t.type || ''}</td>
                            <td class="p-2 border text-sm">${new Date(t.datetime || t.createdAt).toLocaleString()}</td>
                            <td class="p-2 border text-sm">${t.entry || ''}</td>
                            <td class="p-2 border text-sm">${t.exit || ''}</td>
                            <td class="p-2 border text-sm">${t.qty || ''}</td>
                            <td class="p-2 border text-sm">${(((t.exit || 0) - (t.entry || 0)) * (t.qty || 0)).toFixed(4)} ${(t.currency || '')}</td>
                            <td class="p-2 border text-sm">
                                ${(() => {
                                    if (!t.screenshotUrls || !t.screenshotUrls.length) return '';
                                    // render up to 3 thumbnails as buttons
                                    const urls = t.screenshotUrls.slice(0,3);
                                    return urls.map((u, idx) => `<button data-id="${t.id}" data-idx="${idx}" data-url="${u}" class="view-screenshot-thumb inline-block mr-1 rounded border p-0.5" title="Screenshot ${idx+1}"><img src="${u}" style="width:44px;height:32px;object-fit:cover;display:block;border-radius:4px;"/></button>`).join('') + (t.screenshotUrls.length > 3 ? `<span class="text-xs text-gray-500"> (+${t.screenshotUrls.length-3})</span>` : '');
                                })()}
                            </td>
                            <td class="p-2 border text-sm flex gap-2 items-center">
                                <button data-id="${t.id}" class="edit-trade px-2 py-1 bg-yellow-400 text-white rounded" title="Edit"><i class="fas fa-edit"></i></button>
                                <button data-id="${t.id}" class="delete-trade px-2 py-1 bg-red-500 text-white rounded" title="Delete"><i class="fas fa-trash-alt"></i></button>
                            </td>
                        `;
                        rows.appendChild(tr);
                        tradesForStats.push(t);
                    });

                    // Update analytics based on filtered trades
                    console.debug('tradesForStats sample', tradesForStats.slice(0,5));
                    console.debug('tradesForStats parsed sample', tradesForStats.slice(0,5).map(t=>({ entry:Number(t.entry), exit:Number(t.exit), qty: Number(t.qty) })));
                    try { computeAndRenderStats(tradesForStats); } catch (e) { console.warn('computeAndRenderStats failed', e); }
                // attach handlers
                document.querySelectorAll('.delete-trade').forEach(btn => {
                    btn.onclick = async (e) => {
                        const id = btn.dataset.id;
                        const confirmed = await showConfirmModal('Delete this trade and its screenshots?');
                        if (!confirmed) return;
                        try {
                            const snap = await getDoc(doc(db, 'trades', id));
                            if (snap && snap.exists()) {
                                const data = snap.data();
                                const paths = Array.isArray(data.screenshotPaths) ? data.screenshotPaths : (data.screenshotPaths ? [data.screenshotPaths] : []);
                                for (const p of paths) { await deleteTaskImage(p).catch(()=>{}); }
                                await deleteDoc(doc(db, 'trades', id));
                                showNotification('Trade deleted.');
                            }
                        } catch (err) { console.error(err); showNotification('Failed to delete trade.', true); }
                    };
                });

                document.querySelectorAll('.view-screenshots').forEach(btn => {
                    btn.onclick = async (e) => {
                        const id = btn.dataset.id;
                        const snap = await getDoc(doc(db, 'trades', id));
                        if (!snap || !snap.exists()) return;
                        const data = snap.data();
                        const urls = data.screenshotUrls || [];
                        if (!urls.length) return;
                        // show first screenshot in preview modal
                        const pm = document.getElementById('image-preview-modal');
                        const pmImg = document.getElementById('image-preview-img');
                        if (pm && pmImg) { pmImg.src = urls[0]; pm.classList.remove('hidden'); pm.classList.add('flex'); bringPreviewToFront(); }
                    };
                });

                // thumbnail buttons: click any thumbnail to preview that image
                document.querySelectorAll('.view-screenshot-thumb').forEach(btn => {
                    btn.onclick = (e) => {
                        e.stopPropagation();
                        const url = btn.dataset.url || btn.getAttribute('data-url');
                        if (!url) return;
                        const pm = document.getElementById('image-preview-modal');
                        const pmImg = document.getElementById('image-preview-img');
                        if (pm && pmImg) { pmImg.src = url; pm.classList.remove('hidden'); pm.classList.add('flex'); bringPreviewToFront(); }
                    };
                });

                document.querySelectorAll('.edit-trade').forEach(btn => {
                    btn.onclick = async (e) => {
                        const id = btn.dataset.id;
                        const snap = await getDoc(doc(db, 'trades', id));
                        if (!snap || !snap.exists()) return;
                        const data = snap.data();
                        // populate form
                        document.getElementById('trade-asset').value = data.asset || '';
                        document.getElementById('trade-pair').value = data.pair || '';
                        document.getElementById('trade-type').value = data.type || 'buy';
                        if (document.getElementById('trade-status')) document.getElementById('trade-status').value = data.status || 'Open';
                        const dtEl = document.getElementById('trade-datetime'); if (dtEl) dtEl.value = data.datetime ? new Date(data.datetime).toISOString().slice(0,16) : new Date().toISOString().slice(0,16);
                        document.getElementById('trade-entry').value = data.entry || '';
                        document.getElementById('trade-exit').value = data.exit || '';
                        document.getElementById('trade-qty').value = data.qty || '';
                        if (document.getElementById('trade-currency')) document.getElementById('trade-currency').value = data.currency || 'USD';
                        // fees/total fields removed
                        document.getElementById('trade-open-reason').value = data.openReason || '';
                        document.getElementById('trade-close-reason').value = data.closeReason || '';
                        // set editing id and open modal
                        editingTradeId = id;
                        const modal = document.getElementById('trade-form-modal'); if (modal) { modal.classList.remove('hidden'); }
                        document.getElementById('trade-asset')?.focus();
                        // pre-check rules in the form based on trade.confirmedRuleIds
                        const confirmed = Array.isArray(data.confirmedRuleIds) ? data.confirmedRuleIds : [];
                        // uncheck all first
                        document.querySelectorAll('.trade-form-rule-checkbox').forEach(cb => { cb.checked = false; });
                        confirmed.forEach(rid => {
                            const cb = document.querySelector(`.trade-form-rule-checkbox[data-rule-id="${rid}"]`);
                            if (cb) cb.checked = true;
                        });
                        validateRulesChecklist();
                    };
                });

                // Details button opens a modal with all trade fields
                document.querySelectorAll('.view-details').forEach(btn => {
                    btn.onclick = async (e) => {
                        const id = btn.dataset.id;
                        const snap = await getDoc(doc(db, 'trades', id));
                        if (!snap || !snap.exists()) return;
                        const data = snap.data();
                        document.getElementById('detail-asset').textContent = data.asset || '';
                        document.getElementById('detail-pair').textContent = data.pair || '';
                        document.getElementById('detail-type').textContent = data.type || '';
                        document.getElementById('detail-datetime').textContent = new Date(data.datetime || data.createdAt).toLocaleString();
                        document.getElementById('detail-entry').textContent = data.entry || '';
                        document.getElementById('detail-exit').textContent = data.exit || '';
                        document.getElementById('detail-qty').textContent = data.qty || '';
                        document.getElementById('detail-fees').textContent = data.fees || '';
                        document.getElementById('detail-total').textContent = data.total || '';
                        document.getElementById('detail-pl').textContent = (((data.exit || 0) - (data.entry || 0)) * (data.qty || 0)).toFixed(4);
                        document.getElementById('detail-open-reason').textContent = data.openReason || '';
                        document.getElementById('detail-close-reason').textContent = data.closeReason || '';
                        const ds = document.getElementById('detail-screenshots'); ds.innerHTML = '';
                        const urls = data.screenshotUrls || [];
                        urls.forEach(u => {
                            const img = document.createElement('img');
                            img.src = u;
                            img.className = 'h-20 w-32 object-cover rounded cursor-pointer border';
                            img.addEventListener('click', ()=>{ const pm = document.getElementById('image-preview-modal'); const pmImg = document.getElementById('image-preview-img'); if (pm && pmImg) { pmImg.src = u; pm.classList.remove('hidden'); pm.classList.add('flex'); bringPreviewToFront(); } });
                            ds.appendChild(img);
                        });
                        const modal = document.getElementById('trade-detail-modal'); if (modal) { modal.classList.remove('hidden'); modal.classList.add('flex'); }
                    };
                });

                document.getElementById('trade-detail-close')?.addEventListener('click', ()=>{ const modal = document.getElementById('trade-detail-modal'); if (modal) { modal.classList.add('hidden'); modal.classList.remove('flex'); } });
            });
        };

    // start listening for trades (single collection)
    listenTrades();
    // start listening for capital movements so the list updates when a new entry is saved
    try { listenCapitalMovements(); } catch(e) { console.warn('listenCapitalMovements failed to start', e); }

        // Wire up Trade UI controls (new/panel toggle, screenshots preview, refresh)
        document.getElementById('trade-new-btn')?.addEventListener('click', () => {
            const modal = document.getElementById('trade-form-modal');
            if (!modal) return;
            // open modal for new trade
            editingTradeId = null;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            // set defaults after render
            setTimeout(()=>{
                const dt = document.getElementById('trade-datetime');
                if (dt) dt.value = new Date().toISOString().slice(0,16);
                if (document.getElementById('trade-status')) document.getElementById('trade-status').value = 'Open';
                document.getElementById('trade-asset')?.focus();
                try { validateRulesChecklist(); } catch (e) {}
            }, 40);
        });

        document.getElementById('trade-screenshots')?.addEventListener('change', (e) => {
            const preview = document.getElementById('trade-screenshot-preview');
            const files = e.target.files;
            if (!preview) return;
            if (files && files.length) {
                const names = Array.from(files).slice(0,3).map(f=>f.name.length>20?(f.name.slice(0,17)+'...'):f.name);
                preview.textContent = names.join(', ') + (files.length>3?` (+${files.length-3} more)`: '');
            } else { preview.textContent = 'No files chosen'; }
        });

        // Filters: re-run render on Apply (onSnapshot will pick up filters during render)
        document.getElementById('trade-filter-apply')?.addEventListener('click', () => {
            // calling listenTrades will remove previous listener and set a new onSnapshot
            listenTrades(currentMode);
        });

    document.getElementById('trade-refresh')?.addEventListener('click', () => { try { if (tradeUnsub) tradeUnsub(); listenTrades(); showNotification('Trade list refreshed.'); } catch(e){ console.warn(e); } });

        // --- Event Listeners & Initializers ---
        const initializeListeners = (mode) => {
            const tasksListener = onSnapshot(query(collection(db, "hubs", mode, "tasks")), (snapshot) => { allTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderBoard(); });
            const columnsListener = onSnapshot(query(collection(db, "hubs", mode, "board_columns"), orderBy("order")), (snapshot) => { boardColumns = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderBoard(); });
            const notesListener = onSnapshot(query(collection(db, "hubs", mode, "notes")), (snapshot) => { allNotes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderNotes(); try { renderTradeNotes(); } catch(e){} });
            // trade-scoped notes & folders (separate namespace) - keep listeners so trade notes start empty unless created
            try {
                if (tradeNotesUnsub) tradeNotesUnsub();
                tradeNotesUnsub = onSnapshot(query(collection(db, 'hubs', 'trade', 'notes')), (snap) => { allTradeNotes = snap.docs.map(d => ({ id: d.id, ...d.data() })); renderTradeNotes(); });
            } catch (err) { console.warn('trade notes listener failed', err); }
            try {
                if (tradeFoldersUnsub) tradeFoldersUnsub();
                tradeFoldersUnsub = onSnapshot(query(collection(db, 'hubs', 'trade', 'note_folders'), orderBy('createdAt')), (snap) => { tradeNoteFolders = snap.docs.map(d => ({ id: d.id, ...d.data() })); renderTradeFolders(); });
            } catch (err) { console.warn('trade folders listener failed', err); }
            const foldersListener = onSnapshot(query(collection(db, 'hubs', mode, 'note_folders'), orderBy('createdAt')), (snapshot) => { noteFolders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); if (!selectedFolderId && noteFolders.length) { /* keep null by default */ } renderFolders(); });
            
            listeners.push(tasksListener, columnsListener, notesListener);
            // start rules listener and keep a handle to unsubscribe via rulesUnsub
            listenRules();
        };

        document.getElementById('personal-mode-btn').addEventListener('click', () => switchMode('personal'));
        document.getElementById('working-mode-btn').addEventListener('click', () => switchMode('working'));

    document.getElementById('add-task-btn').addEventListener('click', () => { const m = document.getElementById('add-task-modal'); m.classList.remove('hidden'); m.classList.add('flex'); });
    document.getElementById('cancel-add-task-btn').addEventListener('click', () => { const m = document.getElementById('add-task-modal'); m.classList.add('hidden'); m.classList.remove('flex'); const fn = document.getElementById('add-task-image-filename'); if (fn) fn.textContent = ''; const preview = document.getElementById('add-task-image-preview'); const input = document.getElementById('add-task-image-input'); if (preview) { preview.src = ''; preview.classList.add('hidden'); } if (input) input.value = ''; });
    document.getElementById('add-task-form-modal').addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = document.getElementById('task-input-modal');
        const descInput = document.getElementById('add-task-desc-input');
        const fileInput = document.getElementById('add-task-image-input');
        const files = fileInput && fileInput.files && fileInput.files.length ? Array.from(fileInput.files) : null;
        if (input.value.trim() !== '') {
            await addTask(input.value.trim(), descInput.value.trim(), files);
            input.value = ''; descInput.value = '';
            if (fileInput) { fileInput.value = ''; const preview = document.getElementById('add-task-image-preview'); if (preview) { preview.src = ''; preview.classList.add('hidden'); } const fn = document.getElementById('add-task-image-filename'); if (fn) fn.textContent = ''; }
            const m = document.getElementById('add-task-modal'); m.classList.add('hidden'); m.classList.remove('flex');
        }
    });

        // Header Add Note opens modal for currently selected folder
        const openNoteModalForCurrent = () => {
            editingNoteId = null;
            document.getElementById('note-modal-input').value = '';
            document.getElementById('note-modal-title').textContent = 'Add Note';
            populateFolderSelect();
            // preselect current folder if any
            document.getElementById('note-modal-folder-select').value = selectedFolderId || '';
            const m = document.getElementById('note-modal'); m.classList.remove('hidden'); m.classList.add('flex');
        };
        document.getElementById('header-add-note-btn').addEventListener('click', () => openNoteModalForCurrent());
    // Wire the Trade Journal's Add Note button to the trade-specific modal (uses trade-focused placeholder)
    document.getElementById('trade-header-add-note-btn')?.addEventListener('click', () => openNoteModalForTrade());

        document.getElementById('note-modal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('note-modal-title-input').value.trim();
            const txt = document.getElementById('note-modal-input').value.trim();
            const folderSel = document.getElementById('note-modal-folder-select').value || null;
            if (!txt) return;
            try {
                if (noteModalTarget === 'trade') {
                    // operate on hubs/trade/notes
                    if (editingNoteId) {
                        await updateDoc(doc(db, 'hubs', 'trade', 'notes', editingNoteId), { title: title || null, text: txt, folderId: folderSel });
                        showNotification('Trade note updated.');
                    } else {
                        await addDoc(collection(db, 'hubs', 'trade', 'notes'), { title: title || null, text: txt, folderId: folderSel || null, createdAt: Date.now() });
                        showNotification('Trade note added.');
                    }
                    // hide modal and refresh trade notes UI
                    document.getElementById('note-modal').classList.add('hidden');
                    document.getElementById('note-modal').classList.remove('flex');
                    // refresh local lists handled by onSnapshot listeners
                } else {
                    // operate on hubs/<currentMode>/notes
                    if (editingNoteId) {
                        await updateDoc(doc(db, 'hubs', currentMode, 'notes', editingNoteId), { title: title || null, text: txt, folderId: folderSel });
                        showNotification('Note updated.');
                    } else {
                        await addNote(title || null, txt);
                        showNotification('Note added.');
                    }
                    document.getElementById('note-modal').classList.add('hidden');
                    document.getElementById('note-modal').classList.remove('flex');
                    renderNotes();
                    renderFolders();
                }
            } catch (err) { console.error(err); showNotification('Failed to save note.', true); }
        });

        document.getElementById('cancel-note-btn').addEventListener('click', () => { const m = document.getElementById('note-modal'); m.classList.add('hidden'); m.classList.remove('flex'); });
        document.getElementById('add-folder-btn').addEventListener('click', () => {
            document.getElementById('folder-modal-title').textContent = 'Add Folder';
            document.getElementById('folder-id-input').value = '';
            document.getElementById('folder-name-input').value = '';
            const m = document.getElementById('folder-modal'); m.classList.remove('hidden'); m.classList.add('flex');
        });

        // Folder modal form handling
        document.getElementById('folder-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('folder-id-input').value;
            const name = document.getElementById('folder-name-input').value.trim();
            if (!name) return;
            try {
                const fm = document.getElementById('folder-modal');
                const target = fm && fm.dataset && fm.dataset._target === 'trade' ? 'trade' : currentMode;
                // clear the modal target flag after reading
                if (fm && fm.dataset) delete fm.dataset._target;
                if (id) {
                    await updateDoc(doc(db, 'hubs', target, 'note_folders', id), { name });
                } else {
                    const d = await addDoc(collection(db, 'hubs', target, 'note_folders'), { name, createdAt: Date.now() });
                    if (target === 'trade') selectedTradeFolderId = d.id; else selectedFolderId = d.id;
                }
                document.getElementById('folder-modal').classList.add('hidden');
                renderFolders();
                renderNotes();
                // ensure trade lists refresh if we created a trade folder
                renderTradeFolders();
                renderTradeNotes();
            } catch (err) { showNotification('Failed to save folder', true); }
        });

        document.getElementById('cancel-folder-btn').addEventListener('click', () => { const m = document.getElementById('folder-modal'); m.classList.add('hidden'); m.classList.remove('flex'); });

    // ensure folder modal target flag cleared on cancel
    document.getElementById('cancel-folder-btn').addEventListener('click', () => { const fm = document.getElementById('folder-modal'); if (fm && fm.dataset) delete fm.dataset._target; });

        document.getElementById('back-to-folders').addEventListener('click', () => {
            document.getElementById('notes-area').classList.add('hidden');
            document.getElementById('folders-bar').classList.remove('hidden');
            selectedFolderId = null;
            renderFolders();
            const h = document.getElementById('header-add-note-btn'); if (h) h.classList.add('hidden');
        });

        // Trade-specific folder add / back handlers
        document.getElementById('trade-add-folder-btn')?.addEventListener('click', () => {
            // reuse the folder modal but operate on trade namespace when saving
            document.getElementById('folder-modal-title').textContent = 'Add Folder';
            document.getElementById('folder-id-input').value = '';
            document.getElementById('folder-name-input').value = '';
            // mark modal with a data attribute so submit handler can detect trade context
            const fm = document.getElementById('folder-modal'); fm.dataset._target = 'trade';
            fm.classList.remove('hidden'); fm.classList.add('flex');
        });

        document.getElementById('trade-back-to-folders')?.addEventListener('click', () => {
            document.getElementById('trade-notes-area').classList.add('hidden');
            document.getElementById('trade-folders-bar').classList.remove('hidden');
            selectedTradeFolderId = null;
            renderTradeFolders();
            const h = document.getElementById('trade-header-add-note-btn'); if (h) h.classList.add('hidden');
        });

        // initial render for folders (show folder list first)
        document.getElementById('notes-area').classList.add('hidden');
        document.getElementById('folders-bar').classList.remove('hidden');
        renderFolders();
        document.getElementById('routine-form').addEventListener('submit', (e) => { e.preventDefault(); const textInput = document.getElementById('routine-input'); const timeInput = document.getElementById('routine-time-input'); const text = textInput.value.trim(); const time = timeInput.value; if (text !== '' && selectedDateStr) { addRoutine(text, time, selectedDateStr); textInput.value = ''; timeInput.value = ''; } });
    document.getElementById('recurring-routine-form-modal').addEventListener('submit', async (e) => {
        e.preventDefault();
        const textInput = document.getElementById('recurring-routine-input-modal');
        const timeInput = document.getElementById('recurring-routine-time-modal');
        const text = textInput.value.trim();
        const time = timeInput.value;
        if (text === '') return;

        // Determine mode and selected weekdays
        const modeEl = document.querySelector('input[name="recurring-mode"]:checked');
        const mode = modeEl ? modeEl.value : 'specific';
        const weekdayChecks = Array.from(document.querySelectorAll('#weekday-multi-select input[type="checkbox"]'));
        const selectedWeekdays = weekdayChecks.filter(ch => ch.checked).map(ch => Number(ch.value));

        let dates = [];
        if (mode === 'specific') {
            if (selectedWeekdays.length === 0) { showNotification('Please select at least one weekday.', true); return; }
            dates = getDatesForSelection('specific', selectedWeekdays);
        } else {
            dates = getDatesForSelection(mode);
        }

        // Confirm with user how many dates will be affected
        const confirmed = await showConfirmModal(`Will add "${text}" to ${dates.length} date(s). Proceed?`);
        if (!confirmed) return;

        // Close modal and perform additions
        const m = document.getElementById('recurring-routine-modal'); m.classList.add('hidden'); m.classList.remove('flex');
        textInput.value = ''; timeInput.value = '';
        addRoutinesForDates(text, time, dates);
    });
        document.getElementById('edit-routine-form').addEventListener('submit', (e) => { e.preventDefault(); const id = document.getElementById('edit-routine-id').value; const text = document.getElementById('edit-routine-input').value.trim(); const time = document.getElementById('edit-routine-time-input').value; if (text) { updateRoutine(id, text, time); } closeEditRoutineModal(); });
        document.getElementById('column-form').addEventListener('submit', (e) => { e.preventDefault(); const id = document.getElementById('column-id-input').value; const name = document.getElementById('column-name-input').value; saveColumn(id, name); });
    // password unlock removed; notes are plain text
        
        const getDragAfterElement = (container, y) => {
            const draggableElements = [...container.querySelectorAll('.task-card:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element || null;
        };

        const addDragEventsToTask = (task) => {
            task.draggable = true;
            task.addEventListener('dragstart', (e) => {
                task.classList.add('dragging');
                e.dataTransfer.setData('text/plain', task.dataset.id);
                const columnEl = task.closest('.kanban-column');
                window._dragSrcColumnId = columnEl ? columnEl.dataset.columnId : null;
            });
            task.addEventListener('dragend', () => {
                task.classList.remove('dragging');
                window._dragSrcColumnId = null;
            });
        };
        
        document.getElementById('prev-month-btn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
        document.getElementById('next-month-btn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
        document.getElementById('close-routine-modal-btn').addEventListener('click', closeRoutineModal);
        document.getElementById('cancel-edit-routine-btn').addEventListener('click', closeEditRoutineModal);
    document.getElementById('recurring-btn').addEventListener('click', () => { const m = document.getElementById('recurring-routine-modal'); m.classList.remove('hidden'); m.classList.add('flex'); });
    document.getElementById('close-recurring-modal-btn').addEventListener('click', () => { const m = document.getElementById('recurring-routine-modal'); m.classList.add('hidden'); m.classList.remove('flex'); });
        document.getElementById('cancel-column-btn').addEventListener('click', closeColumnModal);
    // cancel-password-btn removed
        window.addEventListener('resize', renderCalendar);

        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });
        
        // Theme handling: default to dark but persist user choice
        const themeToggleBtn = document.getElementById('theme-toggle');
        const THEME_KEY = 'preferredTheme'; // 'dark' or 'light'

        // Recurring modal: toggle weekday multi-select visibility
        const setupRecurringModeToggle = () => {
            const modeRadios = document.querySelectorAll('input[name="recurring-mode"]');
            const weekdayWrap = document.getElementById('weekday-multi-select');
            const updateVisibility = () => {
                const sel = document.querySelector('input[name="recurring-mode"]:checked');
                if (!sel) return;
                if (sel.value === 'specific') weekdayWrap.style.display = 'block'; else weekdayWrap.style.display = 'none';
            };
            modeRadios.forEach(r => r.addEventListener('change', updateVisibility));
            updateVisibility();
        };

        const applyTheme = (theme) => {
            const root = document.documentElement; // <html>
            if (theme === 'dark') {
                root.classList.add('dark');
                themeToggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                root.classList.remove('dark');
                themeToggleBtn.innerHTML = '<i class="fas fa-moon"></i>';
            }
        };

        // Initialize theme on load (default dark)
        let storedTheme = localStorage.getItem(THEME_KEY);
        if (!storedTheme) {
            storedTheme = 'dark';
            localStorage.setItem(THEME_KEY, storedTheme);
        }
        applyTheme(storedTheme);

        themeToggleBtn.addEventListener('click', () => {
            const current = localStorage.getItem(THEME_KEY) || 'dark';
            const next = current === 'dark' ? 'light' : 'dark';
            localStorage.setItem(THEME_KEY, next);
            applyTheme(next);
        });

        // Initial setup
        updateModeUI();
        initializeListeners(currentMode);
        renderCalendar();
    setupRecurringModeToggle();

    // Preview modal close handler
    const imagePreviewCloseBtn = document.getElementById('image-preview-close');
    if (imagePreviewCloseBtn) {
        imagePreviewCloseBtn.addEventListener('click', () => {
            const pm = document.getElementById('image-preview-modal');
            if (pm) { pm.classList.add('hidden'); pm.classList.remove('flex'); }
            const pmImg = document.getElementById('image-preview-img'); if (pmImg) pmImg.src = '';
        });
    }

    // Delegated fallback to ensure Save Trade works even if direct listener isn't bound
    // Prevent native submit + delegated requestSubmit from both firing by preventing default click behavior
    document.addEventListener('click', (ev) => {
        const sbtn = ev.target.closest && ev.target.closest('#trade-save');
        if (!sbtn) return;
        ev.preventDefault();
        console.debug('trade-save clicked (delegated)');
        const form = document.getElementById('trade-form'); if (form) form.requestSubmit ? form.requestSubmit() : form.submit();
    });

    </script>
</body>
</html>