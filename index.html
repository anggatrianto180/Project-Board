<!DOCTYPE html>
<html lang="en" style="scroll-behavior: smooth;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Project Hub (Firebase)</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Icon Library for buttons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- PWA manifest & mobile meta -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0b1220">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <style>
        :root {
            --bg: #f8fafc;
            --card: #ffffff;
            --card-border: rgba(15,23,36,0.06);
            --text: #1f2937;
            --muted: #6b7280;
            --accent: #3b82f6;
        }

        .dark {
            --bg: #0b1220;
            --card: #0f1724;
            --card-border: rgba(255,255,255,0.06);
            --text: #e6eef8;
            --muted: #9ca3af;
            --accent: #60a5fa;
        }

        /* Card borders for task cards and notes */
        .task-card, .note-item {
                border: 1px solid var(--card-border);
                padding: 1.25rem; /* larger padding */
                min-height: 160px; /* larger cards */
                border-radius: 12px;
        }

        /* Ensure card borders are visible in dark mode (stronger contrast) */
        .dark .task-card, .dark .note-item {
            border: 1px solid rgba(255,255,255,0.22) !important; /* brighter border */
            box-shadow: 0 1px 4px rgba(0,0,0,0.45); /* subtle outer shadow for separation */
        }

        /* Kanban column borders (structure of board) */
        .kanban-column {
            border: 1px solid rgba(0,0,0,0.06);
            background-color: rgba(255,255,255,0.02);
        }

        /* Stronger column borders in dark mode so structure is visible */
        .dark .kanban-column {
            border: 1px solid rgba(255,255,255,0.12) !important;
            background-color: rgba(255,255,255,0.02) !important;
        }

        .kanban-column .kanban-column-header {
            border-bottom: 1px solid rgba(0,0,0,0.08);
        }

        /* Limit visible tasks to ~6 items per column; enable vertical scroll when more tasks exist */
        .task-list {
            max-height: 420px; /* roughly 6 tasks at ~64-70px each including gaps */
            overflow-y: auto;
            scroll-behavior: smooth;
            position: relative;
            padding-right: 6px; /* spacing for scrollbar */
        }

    /* subtle gradient hint to show there's more content when scrollable */
    .task-list::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 28px;
            pointer-events: none;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0.9));
            opacity: 0.9;
        }
    .dark .task-list::after {
            background: linear-gradient(to bottom, rgba(15,23,36,0), rgba(15,23,36,0.9));
        }
    /* hide gradient by default; only show when is-scrollable is set */
    .task-list::after { display: none; }
    .task-list.is-scrollable::after { display: block; }

        /* Custom scrollbar styling */
        .task-list::-webkit-scrollbar { width: 8px; }
        .task-list::-webkit-scrollbar-thumb { background: rgba(100,116,139,0.4); border-radius: 8px; }
        .dark .task-list::-webkit-scrollbar-thumb { background: rgba(148,163,184,0.18); }

        .dark .kanban-column .kanban-column-header {
            border-bottom: 1px solid rgba(255,255,255,0.06) !important;
        }

        /* Folder list styles: vertical on mobile, horizontal on desktop */
        #folder-list {
            display: flex;
            flex-direction: column; /* vertical stack on small screens */
            gap: 0.5rem;
            overflow-y: auto;
            max-height: 60vh;
            padding-bottom: 4px;
            -webkit-overflow-scrolling: touch;
        }
        .folder-btn {
            padding: 0.6rem 0.75rem;
            border-radius: 8px;
            background-color: #f3f4f6; /* gray-100 */
            color: #374151; /* gray-700 */
            border: 1px solid rgba(15,23,36,0.06);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%; /* full width on mobile */
            justify-content: space-between;
        }
        .folder-title {
            flex: 1 1 auto;
            min-width: 0; /* allow ellipsis */
            white-space: normal; /* allow wrapping on small screens */
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .folder-actions {
            flex: 0 0 auto;
            display: inline-flex;
            gap: 8px;
            align-items: center;
            margin-left: 8px;
        }
        .folder-btn:hover { background-color: #e6e9ef; }
        .folder-btn.active {
            background-color: #4338ca; /* indigo-700 */
            color: white;
            border-color: rgba(67,56,202,0.9);
        }
        /* Stack folder bar on small screens */
        #folders-bar { flex-direction: column; align-items: stretch; }

        /* Desktop: show folders as cards in a grid to avoid horizontal scrolling */
        @media (min-width: 768px) {
            #folder-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; overflow: visible; max-height: none; }
            .folder-btn { width: 100%; padding: 1rem; border-radius: 12px; justify-content: space-between; display: flex; align-items: center; }
            .folder-title { white-space: nowrap; }
            #folders-bar { flex-direction: column; align-items: stretch; }
        }

        /* Folder modal */
        #folder-modal .modal-panel { width: 100%; max-width: 460px; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
        }

        /* Theme-aware overrides for commonly used utility classes */
        .dark .bg-white, .dark .bg-gray-50, .dark .bg-gray-100, .dark .bg-yellow-50 {
            background-color: var(--card) !important;
        }
        .dark .text-gray-800, .dark .text-gray-700 {
            color: var(--text) !important;
        }
        .dark .text-gray-500, .dark .text-gray-600 {
            color: var(--muted) !important;
        }
        /* Soften primary/secondary button colors in dark mode to avoid harsh contrast */
        .dark .bg-blue-600 {
            background-color: rgba(96,165,250,0.16) !important; /* subtle blue */
            color: var(--text) !important;
            border: 1px solid rgba(96,165,250,0.22);
        }
        .dark .bg-indigo-600 {
            background-color: rgba(99,102,241,0.14) !important;
            color: var(--text) !important;
            border: 1px solid rgba(99,102,241,0.18);
        }
        .dark .bg-indigo-500 {
            background-color: rgba(79,70,229,0.12) !important;
            color: var(--text) !important;
            border: 1px solid rgba(79,70,229,0.16);
        }
        .dark .bg-yellow-500 {
            background-color: rgba(245,158,11,0.10) !important; /* muted yellow */
            color: var(--text) !important;
            border: 1px solid rgba(245,158,11,0.12);
        }
        .dark .bg-gray-200 {
            background-color: rgba(148,163,184,0.08) !important;
            color: var(--text) !important;
        }

        /* Calendar: slightly darker than page background but still readable */
        .dark .calendar-day {
            background-color: #0f1724 !important; /* slightly lighter than page bg */
            color: var(--text) !important;
            border-color: rgba(255,255,255,0.04) !important;
        }
        .dark .day-header {
            border-bottom-color: rgba(255,255,255,0.06) !important;
        }
        .dark .day-routine-list {
            background-color: rgba(255,255,255,0.02) !important; /* subtle light area */
            color: var(--text) !important;
        }
        .dark .today .day-number {
            background-color: var(--accent) !important;
            color: white !important;
        }

        /* Notes textarea in dark mode: slightly dark input with clear text (modal) */
        .dark #note-modal-input, .dark textarea {
            background-color: #0b1220 !important;
            color: var(--text) !important;
            border: 1px solid rgba(255,255,255,0.06) !important;
        }

        /* Form controls on modals / add-edit follow dark mode */
        .dark input[type="text"], .dark input[type="password"], .dark input[type="time"], .dark textarea, .dark select, .dark input {
            background-color: #0b1220 !important;
            color: var(--text) !important;
            border: 1px solid rgba(255,255,255,0.06) !important;
        }
        .dark .bg-white, .dark .rounded-xl, .dark .rounded-lg {
            background-color: var(--card) !important;
        }
        /* Dark mode: folder cards should match dark surface */
        .dark #folders-bar { background: transparent; }
        .dark #folder-list { background: transparent; }
        .dark .folder-btn {
            background-color: var(--card) !important;
            color: var(--text) !important;
            border: 1px solid rgba(255,255,255,0.06) !important;
        }
        .dark .folder-btn .folder-title, .dark .folder-title { color: var(--text) !important; }
        .dark .folder-actions i { color: rgba(255,255,255,0.6) !important; }
        .dark .folder-btn.active { background-color: rgba(79,70,229,0.12) !important; color: var(--text) !important; }
    /* Desktop nav color adjustments in dark mode */
    .dark header a { color: var(--muted) !important; }
    .dark header a:hover { color: var(--accent) !important; }
    .dark header { background-color: var(--card) !important; box-shadow: 0 2px 10px rgba(0,0,0,0.4); }
        .dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }
        .drag-over {
            background-color: #e0f2fe; /* Light blue on drag over */
        }
        .task-card, .note-item, .routine-item {
            transition: all 0.2s ease-in-out;
        }
        .task-card:hover, .note-item:hover {
                transform: translateY(-4px);
                box-shadow: 0 8px 20px rgba(0,0,0,0.08);
        }
        .task-card, .routine-item, .note-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .task-actions i, .column-actions i {
            color: #9ca3af;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s ease-in-out, color 0.2s ease-in-out;
            cursor: pointer;
            margin-left: 8px;
        }
        .task-card:hover .task-actions i, .routine-item:hover .task-actions i, .note-item:hover .task-actions i, .kanban-column-header:hover .column-actions i {
            visibility: visible;
            opacity: 1;
        }
        .task-actions i:hover, .column-actions i:hover {
            color: #3b82f6; /* blue-500 */
        }
        .task-actions .delete-btn:hover, .column-actions .delete-btn:hover {
            color: #ef4444; /* red-500 */
        }
        .routine-item.completed span, .routine-item.completed strong {
            text-decoration: line-through;
            color: #9ca3af; /* gray-400 */
        }
        .note-item {
            align-items: stretch;
            flex-direction: column;
            justify-content: flex-start;
            position: relative; /* allow absolute actions */
        }

        /* Note content container to keep cards uniform */
        .note-item .note-content {
            flex: 1 1 auto;
            overflow: hidden;
            display: flex;
            align-items: flex-start;
        }

        /* Actions inside the note card (top-right) */
        .note-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 8px;
            z-index: 5;
        }

        .note-actions i { color: #9ca3af; opacity: 0; transform: translateY(-4px); transition: opacity 0.18s ease, transform 0.18s ease; cursor: pointer; }
        .note-item:hover .note-actions i { opacity: 1; transform: translateY(0); }
        .section-divider {
            border: 0;
            height: 1px;
            background-image: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0));
            margin: 3rem 0;
        }
        /* Calendar Styles */
        .calendar-day {
            min-height: 140px;
            display: flex;
            flex-direction: column;
            position: relative;
            background-color: white;
        }
        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px;
            border-bottom: 1px solid #e5e7eb;
        }
        .day-info {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .day-name {
            font-size: 0.7rem;
            color: #6b7280;
            background-color: #f3f4f6;
            padding: 2px 6px;
            border-radius: 999px;
        }
        .today .day-number {
            background-color: #3b82f6;
            color: white;
        }
        .day-number {
            font-weight: 500;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .weekend-day {
            background-color: rgba(254, 226, 226, 0.7); /* light red for default (light) mode */
        }

        /* In dark mode, make weekend cells semi-red with 50% opacity */
        .dark .weekend-day {
            background-color: rgba(220, 38, 38, 0.2) !important; /* red with 20% opacity */
        }
        .other-month {
            color: #d1d5db;
            background-color: #f9fafb;
        }
        .day-routine-list {
            font-size: 0.75rem; /* text-xs */
            line-height: 1.1;
            margin-top: 4px;
            overflow-y: auto;
            flex-grow: 1;
            padding: 4px;
            background-color: #eff6ff; /* blue-50 */
            border-radius: 0 0 0.5rem 0.5rem;
        }
        .day-routine-item {
            display: flex;
            align-items: center;
            padding: 2px;
            border-radius: 4px;
        }
        .day-routine-item:hover {
            background-color: #dbeafe;
        }
        .add-routine-btn {
            color: #9ca3af;
            cursor: pointer;
            visibility: hidden;
            opacity: 0;
            transition: all 0.2s;
        }
        .calendar-day:hover .add-routine-btn {
            visibility: visible;
            opacity: 1;
        }
        .add-routine-btn:hover {
            color: #4f46e5; /* indigo-600 */
        }
        /* Mode Toggle Styles */
        .mode-toggle button.active {
            background-color: #4f46e5;
            color: white;
        }
        /* Icon-only mode buttons active state */
        .mode-toggle button.p-2.active {
            background-color: var(--accent) !important;
            color: white !important;
        }
        .mode-toggle button.p-2 i { color: inherit; }
        /* Universal Board Scroll */
        #board {
            display: flex;
            overflow-x: auto;
            padding-bottom: 1rem;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
            scroll-snap-type: x mandatory;
            gap: 1rem;
        }
        #board::-webkit-scrollbar {
            display: none; /* Safari and Chrome */
        }
        .kanban-column {
            width: 85%;
            max-width: 320px;
            flex-shrink: 0;
            scroll-snap-align: start;
        }
        @media (min-width: 768px) {
            .kanban-column {
                width: 100%;
            }
        }
        /* Mobile specific styles */
        @media (max-width: 768px) {
            .calendar-day {
                min-height: 60px;
                padding: 2px;
            }
            .day-header {
                padding: 2px;
                border-bottom: none;
            }
            .day-name { display: none; }
            .day-routine-list { display: none; }
            .add-routine-btn { display: none; }
            .calendar-day {
                cursor: pointer;
            }
            .day-number {
                width: 24px;
                height: 24px;
                font-size: 0.8rem;
            }
            .selected-day {
                outline: 2px solid #3b82f6;
                border-radius: 0.5rem;
            }
        }
    </style>
</head>
<body class="text-gray-800 pt-16">

    <header class="bg-white shadow-md fixed top-0 left-0 right-0 z-30">
        <nav class="container mx-auto px-4 md:px-8 flex justify-between items-center py-3">
            <!-- Logo -->
            <a href="#" class="flex items-center space-x-2">
                <img src="https://placehold.co/40x40/6366f1/ffffff?text=AT" alt="Logo" class="h-10 w-10 rounded-full">
                <span class="font-bold text-xl text-gray-800 hidden sm:block">Project Board AT</span>
            </a>

            <!-- Desktop Navigation -->
            <div class="hidden md:flex items-center gap-6 ml-4">
                <a href="#project-board-section" class="text-sm text-gray-600 hover:text-indigo-500">Project Board</a>
                <a href="#daily-routine-section" class="text-sm text-gray-600 hover:text-indigo-500">Daily Routine</a>
                <a href="#important-notes-section" class="text-sm text-gray-600 hover:text-indigo-500">Notes</a>
            </div>

            <!-- Right controls: desktop theme toggle, personal/working icon toggles, mobile menu button -->
            <div class="flex items-center gap-3 ml-auto">
                <button id="theme-toggle" title="Toggle theme" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 hidden md:inline-flex">
                    <i class="fas fa-moon"></i>
                </button>
                <div class="mode-toggle flex items-center gap-2">
                    <button id="personal-mode-btn" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200" title="Personal"><i class="fas fa-user"></i></button>
                    <button id="working-mode-btn" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200" title="Working"><i class="fas fa-briefcase"></i></button>
                </div>
                <button id="install-btn" title="Install app" class="p-2 rounded-full bg-green-600 text-white hidden md:inline-flex ml-2">
                    <i class="fas fa-download"></i>
                </button>
                <div class="md:hidden">
                    <button id="mobile-menu-button" class="text-gray-600 hover:text-indigo-600 focus:outline-none">
                        <i class="fas fa-bars text-2xl"></i>
                    </button>
                </div>
            </div>
        </nav>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-white border-t">
            <a href="#project-board-section" class="block py-2 px-4 text-sm text-gray-700 hover:bg-gray-100">Project Board</a>
            <a href="#daily-routine-section" class="block py-2 px-4 text-sm text-gray-700 hover:bg-gray-100">Daily Routine</a>
            <a href="#important-notes-section" class="block py-2 px-4 text-sm text-gray-700 hover:bg-gray-100">Notes</a>
        </div>
    </header>

    <main class="container mx-auto p-4 md:px-8">
        <!-- Project Board Section -->
        <div id="project-board-section" class="bg-white rounded-xl shadow-sm p-6 md:p-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-2 text-center">Project Board</h2>
            <p id="board-mode-label" class="text-sm text-gray-600 mb-6 text-center">Mode: </p>
            <div class="mb-8 w-full">
                <div class="max-w-full mx-auto flex justify-center md:justify-end">
                 <button id="add-task-btn" class="ml-auto md:ml-0 md:mr-0 w-full md:w-auto bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-transform hover:scale-105">
                    Add New Task
                </button>
                </div>
            </div>

            <div id="board">
                <!-- Board columns will be rendered here by JS -->
            </div>
        </div>
        
        <hr class="section-divider">

        <!-- Daily Routine Section -->
        <div id="daily-routine-section" class="bg-white rounded-xl shadow-sm p-6 md:p-8">
            <div class="flex justify-center items-center mb-6 relative">
                 <h2 class="text-3xl font-bold text-gray-800">Daily Routine Calendar</h2>
                 <button id="recurring-btn" class="absolute right-0 bg-indigo-500 text-white rounded-full h-8 w-8 flex items-center justify-center hover:bg-indigo-600">
                    <i class="fas fa-plus"></i>
                 </button>
            </div>
            <div id="calendar-container" class="max-w-full mx-auto">
                <div id="calendar-header" class="flex items-center justify-between mb-4">
                    <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-left"></i></button>
                    <h3 id="month-year-header" class="text-xl font-semibold"></h3>
                    <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div id="calendar-weekdays" class="grid grid-cols-7 gap-2 text-center font-semibold text-gray-600 mb-2">
                    <!-- Weekday names will be populated by JS -->
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-2">
                    <!-- Calendar days will be populated here -->
                </div>
            </div>
             <!-- Mobile Daily Activity View -->
            <div id="mobile-daily-activity" class="md:hidden mt-6 bg-gray-50 p-4 rounded-lg">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Daily Activity</h3>
                <div id="mobile-routine-list">
                    <p class="text-gray-500">Select a date to see your routines.</p>
                </div>
            </div>
        </div>

        <hr class="section-divider">

        <!-- Important Notes Section -->
        <div id="important-notes-section" class="bg-white rounded-xl shadow-sm p-6 md:p-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Important Notes</h2>
            <div class="max-w-full mx-auto px-4">
                <div class="mb-6 max-w-full mx-auto">
                    <div id="folders-bar" class="flex items-center justify-between gap-4 mb-4">
                        <div class="flex items-center gap-2">
                            <button id="add-folder-btn" class="bg-gray-100 text-gray-700 py-2 px-3 rounded-lg hover:bg-gray-200">+ Add Folder</button>
                        </div>
                        <div class="flex items-center gap-3 overflow-auto" id="folder-list">
                            <!-- folders will be rendered here -->
                        </div>
                    </div>

                    <!-- Notes area: hidden by default until a folder is opened -->
                    <div id="notes-area" class="hidden">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                    <button id="back-to-folders" class="px-3 py-2 bg-gray-100 rounded-md hover:bg-gray-200">&larr; Back</button>
                                    <h3 id="current-folder-name" class="text-xl font-semibold"></h3>
                                    <button id="header-add-note-btn" class="ml-3 inline-flex items-center gap-2 bg-yellow-500 text-white px-3 py-2 rounded-md hover:bg-yellow-600"><i class="fas fa-plus"></i> Add Note</button>
                                </div>
                            <div>
                                <!-- optionally folder actions could go here -->
                            </div>
                        </div>

                        <!-- Inline add form removed: use modal to add notes -->

                    </div>

                </div>
                <div id="notes-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-6"></div>
            </div>
        </div>
    </main>
    
    <!-- Modals -->
    <div id="notification-area" class="fixed top-20 left-1/2 -translate-x-1/2 z-50 pointer-events-none">
        <!-- Notification will be injected here -->
    </div>
    <div id="custom-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm mx-auto"><p id="confirm-modal-text" class="text-lg mb-4"></p><div class="flex justify-end gap-4"><button id="confirm-cancel-btn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button><button id="confirm-ok-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button></div></div>
    </div>
    <div id="folder-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="modal-panel bg-white rounded-xl shadow-xl w-full max-w-md mx-auto p-6">
            <h3 id="folder-modal-title" class="text-2xl font-bold mb-4">Add Folder</h3>
            <form id="folder-form">
                <input type="hidden" id="folder-id-input">
                <div>
                    <label for="folder-name-input" class="block text-sm font-medium text-gray-700">Folder Name</label>
                    <input type="text" id="folder-name-input" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-folder-btn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save</button>
                </div>
            </form>
        </div>
    </div>
    <div id="note-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="modal-panel bg-white rounded-xl shadow-xl w-full max-w-md mx-auto p-6">
            <h3 id="note-modal-title" class="text-2xl font-bold mb-4">Add Note</h3>
            <form id="note-modal-form">
                <div class="mb-4">
                    <label for="note-modal-input" class="block text-sm font-medium text-gray-700">Note</label>
                    <textarea id="note-modal-input" rows="6" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500" required></textarea>
                </div>
                <div class="mb-4">
                    <label for="note-modal-folder-select" class="block text-sm font-medium text-gray-700">Folder</label>
                    <select id="note-modal-folder-select" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
                        <option value="">All</option>
                    </select>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-note-btn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">Save</button>
                </div>
            </form>
        </div>
    </div>
    <div id="routine-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg mx-auto p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="routine-modal-date" class="text-2xl font-bold"></h3>
                <button id="close-routine-modal-btn" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-times"></i></button>
            </div>
            <div id="modal-routine-list" class="space-y-2 mb-4 max-h-64 overflow-y-auto"></div>
            <form id="routine-form" class="flex flex-col sm:flex-row gap-3">
                <input type="time" id="routine-time-input" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="text" id="routine-input" placeholder="Add a routine for this day..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                <button type="submit" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">Add</button>
            </form>
        </div>
    </div>
    <div id="edit-routine-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg mx-auto p-6">
            <h3 class="text-2xl font-bold mb-4">Edit Routine</h3>
            <form id="edit-routine-form">
                <input type="hidden" id="edit-routine-id">
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="time" id="edit-routine-time-input" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="text" id="edit-routine-input" placeholder="Routine text..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-edit-routine-btn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    <div id="recurring-routine-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg mx-auto p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Add Recurring Routine</h3>
                <button id="close-recurring-modal-btn" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-times"></i></button>
            </div>
            <form id="recurring-routine-form-modal" class="space-y-4">
                <div>
                    <label for="recurring-routine-time-modal" class="block text-sm font-medium text-gray-700">Time</label>
                    <input type="time" id="recurring-routine-time-modal" class="mt-1 p-2 w-full border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="recurring-routine-input-modal" class="block text-sm font-medium text-gray-700">Activity</label>
                    <input type="text" id="recurring-routine-input-modal" placeholder="E.g., Badminton" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div>
                    <label for="recurring-day-select-modal" class="block text-sm font-medium text-gray-700">Day of Week</label>
                    <select id="recurring-day-select-modal" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        <option value="1">Monday</option>
                        <option value="2">Tuesday</option>
                        <option value="3">Wednesday</option>
                        <option value="4">Thursday</option>
                        <option value="5">Friday</option>
                        <option value="6">Saturday</option>
                        <option value="0">Sunday</option>
                    </select>
                </div>
                <div class="flex justify-end pt-2">
                    <button type="submit" class="bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-600 transition-transform hover:scale-105">
                        Add to All
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div id="column-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg mx-auto p-6">
            <h3 id="column-modal-title" class="text-2xl font-bold mb-4"></h3>
            <form id="column-form">
                <input type="hidden" id="column-id-input">
                <div>
                    <label for="column-name-input" class="block text-sm font-medium text-gray-700">Column Name</label>
                    <input type="text" id="column-name-input" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-column-btn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
                </div>
            </form>
        </div>
    </div>
    <!-- password modal removed (secret notes feature disabled) -->
     <div id="add-task-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg mx-auto p-6">
            <h3 class="text-2xl font-bold mb-4">Add New Task</h3>
            <form id="add-task-form-modal">
                <div>
                    <label for="task-input-modal" class="block text-sm font-medium text-gray-700">Task Name</label>
                    <input type="text" id="task-input-modal" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-add-task-btn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add Task</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // PWA: service worker registration and beforeinstallprompt handling
        let deferredPrompt = null;
        const installBtn = document.getElementById('install-btn');

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            deferredPrompt = e;
            // Show the install button when eligible
            if (installBtn) installBtn.classList.remove('hidden');
        });

        if (installBtn) {
            installBtn.addEventListener('click', async () => {
                if (!deferredPrompt) return;
                deferredPrompt.prompt();
                const choiceResult = await deferredPrompt.userChoice;
                // Hide the button after prompt
                installBtn.classList.add('hidden');
                deferredPrompt = null;
            });
        }

        // Register service worker if available
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => {
                        console.log('Service worker registered.', reg);
                    })
                    .catch(err => console.warn('Service worker registration failed:', err));
            });
        }

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, where, getDocs, writeBatch, orderBy } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA8KJmXXX5ax3QulbDFKpBI87v36OLcvK0",
            authDomain: "project-management-fafb7.firebaseapp.com",
            projectId: "project-management-fafb7",
            storageBucket: "project-management-fafb7.firebasestorage.app",
            messagingSenderId: "935346350562",
            appId: "1:935346350562:web:a475abd4099b5acbd3b1bb"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Global State ---
        let currentMode = localStorage.getItem('currentMode') || 'personal';
        let currentDate = new Date();
        let monthRoutines = {};
        let monthListenerUnsubscribe = null;
        let selectedDateStr = null;
        let routineListenerUnsubscribe = null;
        let isInitialCalendarLoad = true;
    let boardColumns = [];
    let allTasks = [];
    let allNotes = [];
    let listeners = [];
    let editingNoteId = null; // if set, note-modal is editing this note
    // notes are plain text now (no secret unlocking)
        const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        const dayNamesShort = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

        // --- UI Functions ---
        const showNotification = (message, isError = false) => {
            const notificationArea = document.getElementById('notification-area');
            notificationArea.innerHTML = '';
            const notification = document.createElement('div');
            notification.className = `relative p-4 rounded-lg shadow-lg text-white max-w-sm pointer-events-auto ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            
            const messageEl = document.createElement('p');
            messageEl.textContent = message;

            const closeBtn = document.createElement('button');
            closeBtn.className = 'absolute top-1 right-2 text-white font-bold';
            closeBtn.innerHTML = '&times;';
            closeBtn.onclick = () => {
                notificationArea.classList.add('hidden');
            };

            notification.appendChild(messageEl);
            notification.appendChild(closeBtn);
            notificationArea.appendChild(notification);
            
            notificationArea.classList.remove('hidden');

            setTimeout(() => {
                 notificationArea.classList.add('hidden');
            }, 1500);
        };

        const showConfirmModal = (text) => {
            return new Promise((resolve) => {
                const modal = document.getElementById('custom-confirm-modal');
                const modalText = document.getElementById('confirm-modal-text');
                const okBtn = document.getElementById('confirm-ok-btn');
                const cancelBtn = document.getElementById('confirm-cancel-btn');
                modalText.textContent = text;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                okBtn.onclick = () => { modal.classList.add('hidden'); modal.classList.remove('flex'); resolve(true); };
                cancelBtn.onclick = () => { modal.classList.add('hidden'); modal.classList.remove('flex'); resolve(false); };
            });
        };
        
        const formatTime = (timeStr) => {
            if (!timeStr) return '';
            const [hours, minutes] = timeStr.split(':');
            const h = parseInt(hours, 10);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const formattedHours = h % 12 || 12;
            return `${formattedHours}:${minutes} ${ampm}`;
        };

        // --- Notes Folders ---
        let noteFolders = [];
        let selectedFolderId = null;

        const renderFolders = () => {
            const folderList = document.getElementById('folder-list');
            folderList.innerHTML = '';
            // add an "All" pseudo-folder
            const allCount = allNotes.length || 0;
            const allBtn = document.createElement('button');
            allBtn.className = `folder-btn ${selectedFolderId === null ? 'active' : ''}`;
            allBtn.textContent = 'All';
            // badge
            const badgeAll = document.createElement('span'); badgeAll.className = 'ml-2 inline-flex items-center justify-center rounded-full bg-gray-200 text-sm px-2 py-0.5'; badgeAll.textContent = allCount;
            allBtn.appendChild(badgeAll);
            allBtn.onclick = () => { selectedFolderId = null; renderFolders(); renderNotes(); document.getElementById('notes-area').classList.remove('hidden'); document.getElementById('folders-bar').classList.add('hidden'); document.getElementById('current-folder-name').textContent = 'All'; const h = document.getElementById('header-add-note-btn'); if (h) h.classList.remove('hidden'); };
            // 'All' is a filter-only card — no add action appended
            folderList.appendChild(allBtn);

            noteFolders.forEach(f => {
                const btn = document.createElement('button');
                btn.className = `folder-btn ${selectedFolderId === f.id ? 'active' : ''}`;

                const titleWrap = document.createElement('div');
                titleWrap.className = 'folder-title';
                titleWrap.textContent = f.name;
                const count = allNotes.filter(n => n.folderId === f.id).length || 0;
                const badge = document.createElement('span'); badge.className = 'ml-2 inline-flex items-center justify-center rounded-full bg-gray-200 text-sm px-2 py-0.5'; badge.textContent = count;
                titleWrap.appendChild(badge);

                const actions = document.createElement('div');
                actions.className = 'folder-actions';
                // add note icon
                const addNoteIcon = document.createElement('i'); addNoteIcon.className = 'fas fa-plus-circle cursor-pointer text-green-600'; addNoteIcon.title = 'Add Note'; addNoteIcon.onclick = (e) => { e.stopPropagation(); openAddNoteForFolder(f.id, f.name); };
                const edit = document.createElement('i'); edit.className = 'fas fa-edit cursor-pointer text-gray-500'; edit.onclick = (e) => {
                    e.stopPropagation();
                    document.getElementById('folder-modal-title').textContent = 'Edit Folder';
                    document.getElementById('folder-id-input').value = f.id;
                    document.getElementById('folder-name-input').value = f.name;
                    const m = document.getElementById('folder-modal'); m.classList.remove('hidden'); m.classList.add('flex');
                };
                const del = document.createElement('i'); del.className = 'fas fa-trash-alt cursor-pointer text-red-500'; del.onclick = async (e) => {
                    e.stopPropagation();
                    const countHere = allNotes.filter(n => n.folderId === f.id).length || 0;
                    if (countHere > 0) {
                        showNotification('Folder contains notes and cannot be deleted.', true);
                        return;
                    }
                    const confirmed = await showConfirmModal('Delete folder? This cannot be undone.');
                    if (!confirmed) return;
                    try {
                        await deleteDoc(doc(db, 'hubs', currentMode, 'note_folders', f.id));
                    } catch (err) { showNotification('Failed to delete folder', true); }
                };

                actions.appendChild(addNoteIcon);
                actions.appendChild(edit);
                actions.appendChild(del);

                btn.appendChild(titleWrap);
                btn.appendChild(actions);

                btn.onclick = () => { selectedFolderId = f.id; renderFolders(); renderNotes(); document.getElementById('notes-area').classList.remove('hidden'); document.getElementById('folders-bar').classList.add('hidden'); document.getElementById('current-folder-name').textContent = f.name; const h = document.getElementById('header-add-note-btn'); if (h) h.classList.remove('hidden'); };

                folderList.appendChild(btn);
            });
        };

        // Helper: open note modal for specific folder
        const openAddNoteForFolder = (folderId, folderName) => {
            selectedFolderId = folderId;
            renderFolders();
            renderNotes();
            document.getElementById('notes-area').classList.remove('hidden');
            document.getElementById('folders-bar').classList.add('hidden');
            document.getElementById('current-folder-name').textContent = folderName || 'All';
            editingNoteId = null;
            document.getElementById('note-modal-input').value = '';
            document.getElementById('note-modal-title').textContent = 'Add Note';
            populateFolderSelect();
            // pre-select the folder
            document.getElementById('note-modal-folder-select').value = folderId || '';
            const m = document.getElementById('note-modal'); m.classList.remove('hidden'); m.classList.add('flex');
        };

        // Populate the select in the note modal with current folders
        const populateFolderSelect = () => {
            const sel = document.getElementById('note-modal-folder-select');
            sel.innerHTML = '';
            const optAll = document.createElement('option'); optAll.value = ''; optAll.textContent = 'All'; sel.appendChild(optAll);
            noteFolders.forEach(f => { const o = document.createElement('option'); o.value = f.id; o.textContent = f.name; sel.appendChild(o); });
        };

        const addFolder = async (name) => {
            if (!name || !name.trim()) return;
            try { const d = await addDoc(collection(db, 'hubs', currentMode, 'note_folders'), { name: name.trim(), createdAt: Date.now() }); selectedFolderId = d.id; } catch (e) { showNotification('Failed to add folder', true); }
        };


        // --- Project Task Functions ---
        const renderBoard = () => {
            const boardContainer = document.getElementById('board');
            boardContainer.innerHTML = ''; // Clear existing columns
            
            boardColumns.forEach(column => {
                const columnEl = document.createElement('div');
                columnEl.className = 'kanban-column bg-gray-50 rounded-lg p-4';
                columnEl.dataset.columnId = column.id;

                const header = document.createElement('div');
                header.className = 'kanban-column-header flex justify-between items-center mb-4 border-b-2 pb-2';
                
                const title = document.createElement('h3');
                title.className = 'text-lg font-semibold text-gray-700';
                title.textContent = column.name;

                const actions = document.createElement('div');
                actions.className = 'column-actions';
                
                const editBtn = document.createElement('i');
                editBtn.className = 'fas fa-edit cursor-pointer';
                editBtn.onclick = () => openColumnModal(column.id, column.name);

                const deleteBtn = document.createElement('i');
                deleteBtn.className = 'fas fa-trash-alt delete-btn cursor-pointer';
                deleteBtn.onclick = () => deleteColumn(column.id);

                actions.appendChild(editBtn);
                actions.appendChild(deleteBtn);
                header.appendChild(title);
                header.appendChild(actions);

                const taskList = document.createElement('div');
                taskList.className = 'task-list min-h-[200px] space-y-3 p-1';
                
                const tasksForColumn = allTasks.filter(task => task.columnId === column.id);
                tasksForColumn.forEach(task => {
                    const taskCard = createTaskElement(task.id, task.text);
                    taskList.appendChild(taskCard);
                });

                // After appending tasks, if the content overflows, add a class to show the gradient hint
                // Use a small timeout to ensure layout measurements are accurate
                setTimeout(() => {
                    if (taskList.scrollHeight > taskList.clientHeight) {
                        taskList.classList.add('is-scrollable');
                    } else {
                        taskList.classList.remove('is-scrollable');
                    }
                }, 20);

                columnEl.appendChild(header);
                columnEl.appendChild(taskList);
                boardContainer.appendChild(columnEl);
            });

            const addColumnButton = document.createElement('button');
            addColumnButton.className = 'kanban-column bg-gray-100 rounded-lg p-4 flex items-center justify-center text-gray-500 hover:bg-gray-200 hover:text-gray-700 transition-colors';
            addColumnButton.innerHTML = '<i class="fas fa-plus mr-2"></i> Add New Column';
            addColumnButton.onclick = () => openColumnModal();
            boardContainer.appendChild(addColumnButton);
        };

        const createTaskElement = (id, text) => {
            const taskCard = document.createElement('div');
            taskCard.className = 'task-card bg-white p-3 rounded-lg shadow-sm cursor-grab active:cursor-grabbing border-l-4 border-gray-300 hover:border-blue-500';
            taskCard.draggable = true;
            taskCard.dataset.id = id;
            const taskTextSpan = document.createElement('span');
            taskTextSpan.textContent = text;
            taskTextSpan.className = 'flex-grow';
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'task-actions';
            const editButton = document.createElement('i');
            editButton.className = 'fas fa-edit';
            editButton.onclick = () => editTask(id, taskCard, taskTextSpan);
            const deleteButton = document.createElement('i');
            deleteButton.className = 'fas fa-trash-alt delete-btn';
            deleteButton.onclick = () => deleteTask(id);
            actionsDiv.appendChild(editButton);
            actionsDiv.appendChild(deleteButton);
            taskCard.appendChild(taskTextSpan);
            taskCard.appendChild(actionsDiv);
            addDragEventsToTask(taskCard);
            return taskCard;
        };
        const editTask = (id, taskCard, taskTextSpan) => {
            const currentText = taskTextSpan.textContent;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentText;
            input.className = 'flex-grow p-1 border rounded';
            taskCard.replaceChild(input, taskTextSpan);
            input.focus();
            const saveChanges = async () => {
                const newText = input.value.trim();
                if (newText && newText !== currentText) {
                    await updateDoc(doc(db, "hubs", currentMode, "tasks", id), { text: newText });
                }
                taskCard.replaceChild(taskTextSpan, input);
            };
            input.addEventListener('blur', saveChanges);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') input.blur();
                if (e.key === 'Escape') { input.value = currentText; input.blur(); }
            });
        };
        const addTask = async (text) => {
            if (boardColumns.length === 0) {
                showNotification("Please add a column first before adding tasks.", true);
                return;
            }
            try { await addDoc(collection(db, "hubs", currentMode, "tasks"), { text, columnId: boardColumns[0].id }); } catch (e) { showNotification('Failed to add task.', true); }
        };
        const deleteTask = async (taskId) => { const confirmed = await showConfirmModal('Are you sure you want to delete this task?'); if (confirmed) { try { await deleteDoc(doc(db, "hubs", currentMode, "tasks", taskId)); showNotification('Task deleted successfully.'); } catch (e) { showNotification('Failed to delete task.', true); } } };

        const openColumnModal = (id = null, name = '') => {
            const modal = document.getElementById('column-modal');
            document.getElementById('column-modal-title').textContent = id ? 'Edit Column' : 'Add New Column';
            document.getElementById('column-id-input').value = id || '';
            document.getElementById('column-name-input').value = name;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        const closeColumnModal = () => {
            const m = document.getElementById('column-modal'); m.classList.add('hidden'); m.classList.remove('flex');
        };

        const saveColumn = async (id, name) => {
            if (!name || name.trim() === "") return;
            if (id) {
                await updateDoc(doc(db, "hubs", currentMode, "board_columns", id), { name: name.trim() });
            } else {
                const order = boardColumns.length > 0 ? Math.max(...boardColumns.map(c => c.order)) + 1 : 1;
                await addDoc(collection(db, "hubs", currentMode, "board_columns"), { name: name.trim(), order });
            }
            closeColumnModal();
        };

        const deleteColumn = async (columnId) => {
            const confirmed = await showConfirmModal('Are you sure you want to delete this column and all its tasks? This action cannot be undone.');
            if (confirmed) {
                try {
                    const batch = writeBatch(db);
                    const tasksToDeleteQuery = query(collection(db, "hubs", currentMode, "tasks"), where("columnId", "==", columnId));
                    const tasksSnapshot = await getDocs(tasksToDeleteQuery);
                    tasksSnapshot.forEach(taskDoc => {
                        batch.delete(doc(db, "hubs", currentMode, "tasks", taskDoc.id));
                    });
                    batch.delete(doc(db, "hubs", currentMode, "board_columns", columnId));
                    await batch.commit();
                    showNotification('Column and its tasks deleted successfully.');
                } catch (e) {
                    showNotification('Failed to delete column.', true);
                }
            }
        };

        // --- Daily Routine Calendar Functions ---
        const renderCalendar = () => {
            const calendarGrid = document.getElementById('calendar-grid');
            const monthYearHeader = document.getElementById('month-year-header');
            const weekdaysHeader = document.getElementById('calendar-weekdays');
            calendarGrid.innerHTML = '';
            weekdaysHeader.innerHTML = '';
            
            const isMobile = window.innerWidth < 768;
            const currentDayNames = isMobile ? dayNamesShort : dayNames;
            currentDayNames.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.textContent = day;
                weekdaysHeader.appendChild(dayEl);
            });

            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            
            monthYearHeader.textContent = `${currentDate.toLocaleString('en-US', { month: 'long' })} ${year}`;
            
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            fetchMonthRoutines(year, month);

            for (let i = 0; i < firstDayOfMonth; i++) {
                calendarGrid.appendChild(document.createElement('div'));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day border rounded';
                dayCell.dataset.date = dateStr;
                
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header';

                const dayInfo = document.createElement('div');
                dayInfo.className = 'day-info';

                const dayNumber = document.createElement('span');
                dayNumber.className = 'day-number text-sm';
                dayNumber.textContent = day;

                const dayName = document.createElement('span');
                dayName.className = 'day-name';
                dayName.textContent = dayNamesShort[date.getDay()];
                
                dayInfo.appendChild(dayNumber);
                dayInfo.appendChild(dayName);
                
                const addBtn = document.createElement('i');
                addBtn.className = 'fas fa-plus add-routine-btn text-xs';
                addBtn.onclick = (e) => { e.stopPropagation(); openRoutineModal(dateStr); };

                dayHeader.appendChild(dayInfo);
                dayHeader.appendChild(addBtn);
                
                const todayStr = new Date().toISOString().slice(0, 10);
                if (dateStr === todayStr) dayCell.classList.add('today');
                
                if (date.getDay() === 0 || date.getDay() === 6) {
                    dayCell.classList.add('weekend-day');
                }

                const routineList = document.createElement('div');
                routineList.className = 'day-routine-list';
                routineList.id = `routines-${dateStr}`;

                dayCell.appendChild(dayHeader);
                dayCell.appendChild(routineList);
                
                dayCell.addEventListener('click', () => handleDayClick(dateStr, dayCell));
                calendarGrid.appendChild(dayCell);
            }
        };
        
        const handleDayClick = (dateStr, dayCell) => {
             if (window.innerWidth >= 768) return;
             
             const prevSelected = document.querySelector('.selected-day');
             if(prevSelected) prevSelected.classList.remove('selected-day');

             dayCell.classList.add('selected-day');
             
             renderMobileRoutines(dateStr);
        };

        const fetchMonthRoutines = (year, month) => {
            if (monthListenerUnsubscribe) monthListenerUnsubscribe();
            const startDate = `${year}-${String(month + 1).padStart(2, '0')}-01`;
            const endDate = `${year}-${String(month + 2).padStart(2, '0')}-01`;
            const q = query(collection(db, "hubs", currentMode, "daily_routines"), where("date", ">=", startDate), where("date", "<", endDate));
            
            monthListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                monthRoutines = {};
                snapshot.docs.forEach(doc => {
                    const routine = { id: doc.id, ...doc.data() };
                    if (!monthRoutines[routine.date]) monthRoutines[routine.date] = [];
                    monthRoutines[routine.date].push(routine);
                });
                updateRoutineDisplay();

                if (isInitialCalendarLoad && window.innerWidth < 768) {
                    const todayStr = new Date().toISOString().slice(0, 10);
                    const todayCell = document.querySelector(`.calendar-day[data-date="${todayStr}"]`);
                    if (todayCell) {
                        handleDayClick(todayStr, todayCell);
                    }
                    isInitialCalendarLoad = false;
                }
            });
        };

        const updateRoutineDisplay = () => {
            document.querySelectorAll('.day-routine-list').forEach(list => list.innerHTML = '');
            for (const dateStr in monthRoutines) {
                const listEl = document.getElementById(`routines-${dateStr}`);
                if (listEl) {
                    monthRoutines[dateStr].sort((a, b) => (a.time || '').localeCompare(b.time || ''));
                    monthRoutines[dateStr].forEach(routine => {
                        const item = createDayRoutineElement(routine);
                        listEl.appendChild(item);
                    });
                }
            }
        };

        const createDayRoutineElement = (routine) => {
            const item = document.createElement('div');
            item.className = `day-routine-item ${routine.completed ? 'completed' : ''}`;
            item.title = `${routine.text}${routine.time ? ' at ' + formatTime(routine.time) : ''}`;

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = routine.completed;
            checkbox.className = 'form-checkbox h-3 w-3 text-indigo-600 rounded-sm mr-1 focus:ring-0 flex-shrink-0';
            checkbox.onchange = () => updateRoutineStatus(routine.id, checkbox.checked);
            
            const textSpan = document.createElement('span');
            textSpan.textContent = `${routine.text} ${formatTime(routine.time)}`;
            textSpan.className = 'truncate';

            item.appendChild(checkbox);
            item.appendChild(textSpan);
            return item;
        };

        const openRoutineModal = (dateStr) => {
            selectedDateStr = dateStr;
            const modal = document.getElementById('routine-modal');
            const modalDateHeader = document.getElementById('routine-modal-date');
            const date = new Date(dateStr + 'T00:00:00');
            modalDateHeader.textContent = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            if (routineListenerUnsubscribe) routineListenerUnsubscribe();
            const q = query(collection(db, "hubs", currentMode, "daily_routines"), where("date", "==", dateStr));
            routineListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                renderModalRoutines(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            });
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        const closeRoutineModal = () => {
            const m = document.getElementById('routine-modal'); m.classList.add('hidden'); m.classList.remove('flex');
            if (routineListenerUnsubscribe) { routineListenerUnsubscribe(); routineListenerUnsubscribe = null; }
            selectedDateStr = null;
        };
        
        const openEditRoutineModal = (routine) => {
            const modal = document.getElementById('edit-routine-modal');
            document.getElementById('edit-routine-id').value = routine.id;
            document.getElementById('edit-routine-input').value = routine.text;
            document.getElementById('edit-routine-time-input').value = routine.time;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        const closeEditRoutineModal = () => {
            const m = document.getElementById('edit-routine-modal'); m.classList.add('hidden'); m.classList.remove('flex');
        };

        const renderModalRoutines = (routines) => {
            const listEl = document.getElementById('modal-routine-list');
            listEl.innerHTML = '';
            routines.sort((a, b) => (a.time || '').localeCompare(b.time || ''));
            routines.forEach(routine => {
                const item = document.createElement('div');
                item.className = `routine-item p-3 rounded-lg bg-gray-50 hover:bg-gray-100`;
                
                const mainContent = document.createElement('div');
                mainContent.className = 'flex items-center flex-grow';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = routine.completed;
                checkbox.className = 'form-checkbox h-5 w-5 text-indigo-600 rounded mr-3 focus:ring-0';
                checkbox.onchange = () => updateRoutineStatus(routine.id, checkbox.checked);
                const textSpan = document.createElement('span');
                const timeDisplay = routine.time ? `<strong class="mr-2">${formatTime(routine.time)}</strong>` : '';
                textSpan.innerHTML = `${timeDisplay} <span class="${routine.completed ? 'completed' : ''}">${routine.text}</span>`;
                mainContent.appendChild(checkbox);
                mainContent.appendChild(textSpan);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'task-actions';
                const editButton = document.createElement('i');
                editButton.className = 'fas fa-edit';
                editButton.onclick = () => openEditRoutineModal(routine);
                const deleteButton = document.createElement('i');
                deleteButton.className = 'fas fa-trash-alt delete-btn';
                deleteButton.onclick = () => deleteRoutine(routine.id);
                actionsDiv.appendChild(editButton);
                actionsDiv.appendChild(deleteButton);

                item.appendChild(mainContent);
                item.appendChild(actionsDiv);
                listEl.appendChild(item);
            });
        };
        
        const renderMobileRoutines = (dateStr) => {
            const container = document.getElementById('mobile-routine-list');
            container.innerHTML = '';
            
            const routines = monthRoutines[dateStr] || [];
            
            if (routines.length === 0) {
                 container.innerHTML = `<p class="text-gray-500">No routines for this day. <a href="#" class="text-indigo-600" onclick="event.preventDefault(); openRoutineModal('${dateStr}')">Add one?</a></p>`;
                 return;
            }

            routines.sort((a, b) => (a.time || '').localeCompare(b.time || ''));
            routines.forEach(routine => {
                const item = document.createElement('div');
                item.className = `routine-item p-3 rounded-lg bg-white`;
                
                const mainContent = document.createElement('div');
                mainContent.className = 'flex items-center flex-grow';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = routine.completed;
                checkbox.className = 'form-checkbox h-5 w-5 text-indigo-600 rounded mr-3 focus:ring-0';
                checkbox.onchange = () => updateRoutineStatus(routine.id, checkbox.checked);
                const textSpan = document.createElement('span');
                const timeDisplay = routine.time ? `<strong class="mr-2">${formatTime(routine.time)}</strong>` : '';
                textSpan.innerHTML = `${timeDisplay} <span class="${routine.completed ? 'completed' : ''}">${routine.text}</span>`;
                mainContent.appendChild(checkbox);
                mainContent.appendChild(textSpan);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'task-actions';
                const editButton = document.createElement('i');
                editButton.className = 'fas fa-edit';
                editButton.onclick = () => openEditRoutineModal(routine);
                const deleteButton = document.createElement('i');
                deleteButton.className = 'fas fa-trash-alt delete-btn';
                deleteButton.onclick = () => deleteRoutine(routine.id);
                actionsDiv.appendChild(editButton);
                actionsDiv.appendChild(deleteButton);

                item.appendChild(mainContent);
                item.appendChild(actionsDiv);
                container.appendChild(item);
            });
        };

        const addRoutine = async (text, time, dateStr) => {
            try {
                await addDoc(collection(db, "hubs", currentMode, "daily_routines"), { text, time, completed: false, date: dateStr });
            } catch (e) {
                console.error("Error adding routine: ", e);
                showNotification('Failed to add routine.', true);
            }
        };

        const updateRoutine = async (id, text, time) => {
            try {
                await updateDoc(doc(db, "hubs", currentMode, "daily_routines", id), { text, time });
                showNotification('Routine updated successfully.');
            } catch (e) {
                showNotification('Failed to edit routine.', true);
            }
        };

        const updateRoutineStatus = async (id, completed) => {
            try {
                await updateDoc(doc(db, "hubs", currentMode, "daily_routines", id), { completed });
            } catch (e) {
                showNotification('Failed to update routine status.', true);
            }
        };

        const deleteRoutine = async (id) => {
            const confirmed = await showConfirmModal('Are you sure you want to delete this routine task?');
            if (confirmed) {
                try {
                    await deleteDoc(doc(db, "hubs", currentMode, "daily_routines", id));
                } catch (e) {
                    showNotification('Failed to delete routine.', true);
                }
            }
        };

        const addRecurringRoutine = async (text, time, dayOfWeek) => {
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const promises = [];

            for (let day = 1; day <= daysInMonth; day++) {
                const loopDate = new Date(year, month, day);
                if (loopDate.getDay() == dayOfWeek) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    promises.push(addRoutine(text, time, dateStr));
                }
            }
            try {
                await Promise.all(promises);
                showNotification(`Successfully added "${text}" to all selected days this month.`);
            } catch (e) {
                showNotification('An error occurred while adding recurring routines.', true);
            }
        };

        // --- Important Notes Functions ---
        const renderNotes = () => {
            const notesList = document.getElementById('notes-list');
            notesList.innerHTML = '';
            const filtered = selectedFolderId ? allNotes.filter(n => n.folderId === selectedFolderId) : allNotes;
            filtered.forEach(note => {
                const noteItem = createNoteElement(note);
                notesList.appendChild(noteItem);
            });
        };
        const createNoteElement = (note) => {
            const item = document.createElement('div');
            item.className = 'note-item p-4 rounded-lg bg-yellow-50 hover:bg-yellow-100 shadow-sm min-h-[120px]';
            item.dataset.id = note.id;

            const content = document.createElement('div');
            content.className = 'note-content';
            const textSpan = document.createElement('p');
            textSpan.textContent = note.text || '';
            textSpan.className = 'text-gray-800 break-words text-lg leading-relaxed max-h-40 overflow-hidden';
            content.appendChild(textSpan);

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'note-actions';
            const editButton = document.createElement('i');
            editButton.className = 'fas fa-edit';
            editButton.title = 'Edit';
            editButton.onclick = () => editNote(note.id, item, textSpan);
            const deleteButton = document.createElement('i');
            deleteButton.className = 'fas fa-trash-alt delete-btn';
            deleteButton.title = 'Delete';
            deleteButton.onclick = () => deleteNote(note.id);
            actionsDiv.appendChild(editButton);
            actionsDiv.appendChild(deleteButton);

            item.appendChild(actionsDiv);
            item.appendChild(content);
            return item;
        };
        const editNote = (id, item, textSpan) => {
            // Open modal to edit note and allow moving between folders
            const noteObj = allNotes.find(n => n.id === id) || null;
            if (!noteObj) return;
            editingNoteId = id;
            document.getElementById('note-modal-input').value = noteObj.text || '';
            document.getElementById('note-modal-title').textContent = 'Edit Note';
            populateFolderSelect();
            document.getElementById('note-modal-folder-select').value = noteObj.folderId || '';
            const m = document.getElementById('note-modal'); m.classList.remove('hidden'); m.classList.add('flex');
        };
        const addNote = async (text) => {
            try {
                await addDoc(collection(db, "hubs", currentMode, "notes"), { text, folderId: selectedFolderId || null, createdAt: Date.now() });
            } catch (e) {
                console.error("Error adding note: ", e);
                showNotification('Failed to add note.', true);
            }
        };
        const deleteNote = async (id) => { const confirmed = await showConfirmModal('Are you sure you want to delete this note?'); if (confirmed) { try { await deleteDoc(doc(db, "hubs", currentMode, "notes", id)); showNotification('Note deleted.'); } catch (e) { showNotification('Failed to delete note.', true); } } };



        // --- Mode Switching ---
        const switchMode = (newMode) => {
            if (currentMode === newMode) return;
            currentMode = newMode;
            localStorage.setItem('currentMode', newMode);
            // notes are plain text; no lock state
            updateModeUI();
            
            listeners.forEach(unsubscribe => unsubscribe());
            listeners = [];

            initializeListeners(newMode);
            renderCalendar();
        };

        const updateModeUI = () => {
            const personalBtn = document.getElementById('personal-mode-btn');
            const workingBtn = document.getElementById('working-mode-btn');
            const modeLabel = document.getElementById('board-mode-label');
            if (currentMode === 'personal') {
                personalBtn.classList.add('active');
                workingBtn.classList.remove('active');
                if(modeLabel) modeLabel.textContent = 'Mode: Personal';
            } else {
                workingBtn.classList.add('active');
                personalBtn.classList.remove('active');
                if(modeLabel) modeLabel.textContent = 'Mode: Working';
            }
        };

        // --- Event Listeners & Initializers ---
        const initializeListeners = (mode) => {
            const tasksListener = onSnapshot(query(collection(db, "hubs", mode, "tasks")), (snapshot) => { allTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderBoard(); });
            const columnsListener = onSnapshot(query(collection(db, "hubs", mode, "board_columns"), orderBy("order")), (snapshot) => { boardColumns = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderBoard(); });
            const notesListener = onSnapshot(query(collection(db, "hubs", mode, "notes")), (snapshot) => { allNotes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderNotes(); });
            const foldersListener = onSnapshot(query(collection(db, 'hubs', mode, 'note_folders'), orderBy('createdAt')), (snapshot) => { noteFolders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); if (!selectedFolderId && noteFolders.length) { /* keep null by default */ } renderFolders(); });
            
            listeners.push(tasksListener, columnsListener, notesListener);
        };

        document.getElementById('personal-mode-btn').addEventListener('click', () => switchMode('personal'));
        document.getElementById('working-mode-btn').addEventListener('click', () => switchMode('working'));

    document.getElementById('add-task-btn').addEventListener('click', () => { const m = document.getElementById('add-task-modal'); m.classList.remove('hidden'); m.classList.add('flex'); });
    document.getElementById('cancel-add-task-btn').addEventListener('click', () => { const m = document.getElementById('add-task-modal'); m.classList.add('hidden'); m.classList.remove('flex'); });
    document.getElementById('add-task-form-modal').addEventListener('submit', (e) => { e.preventDefault(); const input = document.getElementById('task-input-modal'); if (input.value.trim() !== '') { addTask(input.value.trim()); input.value = ''; const m = document.getElementById('add-task-modal'); m.classList.add('hidden'); m.classList.remove('flex'); } });

        // Header Add Note opens modal for currently selected folder
        const openNoteModalForCurrent = () => {
            editingNoteId = null;
            document.getElementById('note-modal-input').value = '';
            document.getElementById('note-modal-title').textContent = 'Add Note';
            populateFolderSelect();
            // preselect current folder if any
            document.getElementById('note-modal-folder-select').value = selectedFolderId || '';
            const m = document.getElementById('note-modal'); m.classList.remove('hidden'); m.classList.add('flex');
        };
        document.getElementById('header-add-note-btn').addEventListener('click', () => openNoteModalForCurrent());

        document.getElementById('note-modal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const txt = document.getElementById('note-modal-input').value.trim();
            const folderSel = document.getElementById('note-modal-folder-select').value || null;
            if (!txt) return;
            try {
                if (editingNoteId) {
                    await updateDoc(doc(db, 'hubs', currentMode, 'notes', editingNoteId), { text: txt, folderId: folderSel });
                    showNotification('Note updated.');
                } else {
                    await addDoc(collection(db, 'hubs', currentMode, 'notes'), { text: txt, folderId: folderSel, createdAt: Date.now() });
                    showNotification('Note added.');
                }
                document.getElementById('note-modal').classList.add('hidden');
                document.getElementById('note-modal').classList.remove('flex');
                renderNotes();
                renderFolders();
            } catch (err) { showNotification('Failed to save note.', true); }
        });

        document.getElementById('cancel-note-btn').addEventListener('click', () => { const m = document.getElementById('note-modal'); m.classList.add('hidden'); m.classList.remove('flex'); });
        document.getElementById('add-folder-btn').addEventListener('click', () => {
            document.getElementById('folder-modal-title').textContent = 'Add Folder';
            document.getElementById('folder-id-input').value = '';
            document.getElementById('folder-name-input').value = '';
            const m = document.getElementById('folder-modal'); m.classList.remove('hidden'); m.classList.add('flex');
        });

        // Folder modal form handling
        document.getElementById('folder-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('folder-id-input').value;
            const name = document.getElementById('folder-name-input').value.trim();
            if (!name) return;
            try {
                if (id) {
                    await updateDoc(doc(db, 'hubs', currentMode, 'note_folders', id), { name });
                } else {
                    const d = await addDoc(collection(db, 'hubs', currentMode, 'note_folders'), { name, createdAt: Date.now() });
                    selectedFolderId = d.id;
                }
                document.getElementById('folder-modal').classList.add('hidden');
                renderFolders();
                renderNotes();
            } catch (err) { showNotification('Failed to save folder', true); }
        });

        document.getElementById('cancel-folder-btn').addEventListener('click', () => { const m = document.getElementById('folder-modal'); m.classList.add('hidden'); m.classList.remove('flex'); });

        document.getElementById('back-to-folders').addEventListener('click', () => {
            document.getElementById('notes-area').classList.add('hidden');
            document.getElementById('folders-bar').classList.remove('hidden');
            selectedFolderId = null;
            renderFolders();
            const h = document.getElementById('header-add-note-btn'); if (h) h.classList.add('hidden');
        });

        // initial render for folders (show folder list first)
        document.getElementById('notes-area').classList.add('hidden');
        document.getElementById('folders-bar').classList.remove('hidden');
        renderFolders();
        document.getElementById('routine-form').addEventListener('submit', (e) => { e.preventDefault(); const textInput = document.getElementById('routine-input'); const timeInput = document.getElementById('routine-time-input'); const text = textInput.value.trim(); const time = timeInput.value; if (text !== '' && selectedDateStr) { addRoutine(text, time, selectedDateStr); textInput.value = ''; timeInput.value = ''; } });
    document.getElementById('recurring-routine-form-modal').addEventListener('submit', (e) => { e.preventDefault(); const textInput = document.getElementById('recurring-routine-input-modal'); const timeInput = document.getElementById('recurring-routine-time-modal'); const daySelect = document.getElementById('recurring-day-select-modal'); const text = textInput.value.trim(); const time = timeInput.value; if (text !== '') { addRecurringRoutine(text, time, daySelect.value); textInput.value = ''; timeInput.value = ''; const m = document.getElementById('recurring-routine-modal'); m.classList.add('hidden'); m.classList.remove('flex'); } });
        document.getElementById('edit-routine-form').addEventListener('submit', (e) => { e.preventDefault(); const id = document.getElementById('edit-routine-id').value; const text = document.getElementById('edit-routine-input').value.trim(); const time = document.getElementById('edit-routine-time-input').value; if (text) { updateRoutine(id, text, time); } closeEditRoutineModal(); });
        document.getElementById('column-form').addEventListener('submit', (e) => { e.preventDefault(); const id = document.getElementById('column-id-input').value; const name = document.getElementById('column-name-input').value; saveColumn(id, name); });
    // password unlock removed; notes are plain text
        
        const addDragEventsToTask = (task) => { task.addEventListener('dragstart', (e) => { task.classList.add('dragging'); e.dataTransfer.setData('text/plain', task.dataset.id); }); task.addEventListener('dragend', () => task.classList.remove('dragging')); };
        document.body.addEventListener('drop', (e) => { const columnEl = e.target.closest('.kanban-column'); if (columnEl) { const taskId = e.dataTransfer.getData('text/plain'); const newColumnId = columnEl.dataset.columnId; if(taskId && newColumnId) { updateDoc(doc(db, "hubs", currentMode, "tasks", taskId), { columnId: newColumnId }); } } });
        document.body.addEventListener('dragover', (e) => { if(e.target.closest('.kanban-column')) { e.preventDefault(); } });
        
        document.getElementById('prev-month-btn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
        document.getElementById('next-month-btn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
        document.getElementById('close-routine-modal-btn').addEventListener('click', closeRoutineModal);
        document.getElementById('cancel-edit-routine-btn').addEventListener('click', closeEditRoutineModal);
    document.getElementById('recurring-btn').addEventListener('click', () => { const m = document.getElementById('recurring-routine-modal'); m.classList.remove('hidden'); m.classList.add('flex'); });
    document.getElementById('close-recurring-modal-btn').addEventListener('click', () => { const m = document.getElementById('recurring-routine-modal'); m.classList.add('hidden'); m.classList.remove('flex'); });
        document.getElementById('cancel-column-btn').addEventListener('click', closeColumnModal);
    // cancel-password-btn removed
        window.addEventListener('resize', renderCalendar);

        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });
        
        // Theme handling: default to dark but persist user choice
        const themeToggleBtn = document.getElementById('theme-toggle');
        const THEME_KEY = 'preferredTheme'; // 'dark' or 'light'

        const applyTheme = (theme) => {
            const root = document.documentElement; // <html>
            if (theme === 'dark') {
                root.classList.add('dark');
                themeToggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                root.classList.remove('dark');
                themeToggleBtn.innerHTML = '<i class="fas fa-moon"></i>';
            }
        };

        // Initialize theme on load (default dark)
        let storedTheme = localStorage.getItem(THEME_KEY);
        if (!storedTheme) {
            storedTheme = 'dark';
            localStorage.setItem(THEME_KEY, storedTheme);
        }
        applyTheme(storedTheme);

        themeToggleBtn.addEventListener('click', () => {
            const current = localStorage.getItem(THEME_KEY) || 'dark';
            const next = current === 'dark' ? 'light' : 'dark';
            localStorage.setItem(THEME_KEY, next);
            applyTheme(next);
        });

        // Initial setup
        updateModeUI();
        initializeListeners(currentMode);
        renderCalendar();

    </script>
</body>
</html>
